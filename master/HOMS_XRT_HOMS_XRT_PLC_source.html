<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-plc-xrt-optics  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/docs-versions-menu.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="HOMS_XRT_HOMS_XRT_PLC_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-plc-xrt-optics
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">HOMS_XRT</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_ethercat.html">Box Hierarchy</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">HOMS_XRT_PLC</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOMS_XRT_HOMS_XRT_PLC_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-gantrycontrol">E_GantryControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-gantrymode">E_GantryMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-piezocontrol">E_PiezoControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-pitchcontrol">E_PitchControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enum-coating-states">ENUM_Coating_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#homs-gantry">HOMS_Gantry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#homs-gantryaxis">HOMS_GantryAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#homs-pitchmechanismold">HOMS_PitchMechanismOld</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-abstractaxis">ST_AbstractAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-coeindsub">ST_CoEIndSub</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-decoupledmotionpermits">ST_DecoupledMotionPermits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-elmogdcbellcoeparams">ST_ElmoGDCBellCoEParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-homsstepper">ST_HOMSStepper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-piezoaxisold">ST_PiezoAxisOld</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-stepperstatus">ST_StepperStatus</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#global-version">Global_Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl">GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-com-buffers">GVL_COM_Buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-constants">GVL_Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr1l3">GVL_MR1L3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr1l3-constants">GVL_MR1L3_Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr1l4">GVL_MR1L4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr1l4-constants">GVL_MR1L4_Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr2l3">GVL_MR2L3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-mr2l3-constants">GVL_MR2L3_Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-pmps">GVL_PMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-rtds">GVL_RTDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-serialio">GVL_SerialIO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#f-piezoposition">F_PiezoPosition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-coating-states">FB_Coating_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-coating-states-nopmps">FB_Coating_States_noPMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-drive">FB_Drive</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-elmogdcbellcoe">FB_ElmoGDCBellCoE</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-elmomcuploaddriveparams">FB_ElmoMCUploadDriveParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-elmostomonitor">FB_ElmoStoMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantry">FB_Gantry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantrydifferencemonitor">FB_GantryDifferenceMonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-initdriverefs">FB_InitDriveRefs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-limitswitchstate">FB_LimitSwitchState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mirrorcoatingprotection">FB_MirrorCoatingProtection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pi-e621-serialdriverold">FB_PI_E621_SerialDriverOld</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pi-e621-serialtransaction">FB_PI_E621_SerialTransaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-piezocontrol">FB_PiezoControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pitchcontrolold">FB_PitchControlOld</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pitchsoftlimits">FB_PitchSoftLimits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ptp">FB_PTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-readparameterinnc">FB_ReadParameterInNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-reducegantrydiff">FB_ReduceGantryDiff</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-writeparameterinnc">FB_WriteParameterInNC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">Main</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-serial-com">P_Serial_Com</a></li>
<li class="toctree-l2"><a class="reference internal" href="#piezoserial">PiezoSerial</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-coatingprotection">PRG_CoatingProtection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-pmps">PRG_PMPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-states">PRG_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#withinrange">WithinRange</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-plc-xrt-optics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/HOMS_XRT_HOMS_XRT_PLC_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Permalink to this heading"></a></h1>
<section id="e-gantrycontrol">
<h2>E_GantryControl<a class="headerlink" href="#e-gantrycontrol" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_GantryControl</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span><span class="n">Gantry</span> <span class="n">Control</span> <span class="n">Machine</span>
    <span class="n">GCM_Idle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">GCM_Init</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">GCM_ChangeCoupling</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">GCM_Couple</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">GCM_CoupledEnable</span> <span class="o">:=</span> <span class="mi">51</span><span class="p">,</span>
    <span class="n">GCM_CoupledStandby</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">GCM_Decouple</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">GCM_DecoupledStandby</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">GCM_CoupledMoveDone</span>     <span class="o">:=</span> <span class="mi">8000</span><span class="p">,</span>
    <span class="n">GCM_Error</span>       <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-gantrycontrol">E_GantryControl</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-gantrymode">
<h2>E_GantryMode<a class="headerlink" href="#e-gantrymode" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_GantryMode</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">GantryModeCoupled</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">GantryModeDecoupled</span>     <span class="o">:=</span> <span class="mi">1</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-piezocontrol">
<h2>E_PiezoControl<a class="headerlink" href="#e-piezocontrol" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_PiezoControl</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span><span class="n">Piezo</span> <span class="n">Control</span> <span class="n">Machine</span>
    <span class="n">EPC_Idle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">EPC_Init</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">EPC_MoveRequested</span>  <span class="o">:=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">EPC_MovingPositive</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">EPC_MovingNegative</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">EPC_MoveCompleted</span>  <span class="o">:=</span> <span class="mi">350</span><span class="p">,</span>
    <span class="n">EPC_Error</span> <span class="o">:=</span> <span class="mi">500</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-pitchcontrol">
<h2>E_PitchControl<a class="headerlink" href="#e-pitchcontrol" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE E_PitchControl :
(
    //Pitch Control Machine
    PCM_Init := 0,
    PCM_Standby := 1,
    PCM_MoveRequested := 10,
    PCM_Coarse50Piezo       := 20,
    PCM_CoarseMove  := 21,
    PCM_CoarseMoveCleanup := 22,
    PCM_FineMove    := 30,
    PCM_Halt                := 50,
    PCM_Done        := 8000, //why is 8000 done? Where did this come from??
    PCM_Error   := 9000, //Anything above 9000 is considered an error
    PCM_StepperError        := 9100,
    PCM_PiezoError  := 9200,
    PCM_OtherError := 9300
);
END_TYPE
</pre></div>
</div>
</section>
<section id="enum-coating-states">
<h2>ENUM_Coating_States<a class="headerlink" href="#enum-coating-states" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">ENUM_Coating_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">SiC</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">W</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="homs-gantry">
<h2>HOMS_Gantry<a class="headerlink" href="#homs-gantry" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">HOMS_Gantry</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">PAxis</span>   <span class="p">:</span>       <span class="n">HOMS_GantryAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Primary</span> <span class="n">Axis</span><span class="p">,</span> <span class="n">upstream</span>
    <span class="n">SAxis</span>   <span class="p">:</span>       <span class="n">HOMS_GantryAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Secondary</span> <span class="n">Axis</span><span class="p">,</span> <span class="n">downstream</span>
    <span class="n">VAxis</span>   <span class="p">:</span>       <span class="n">HOMS_GantryAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Virtual</span> <span class="n">Axis</span>
    <span class="n">Mode</span>    <span class="p">:</span>       <span class="n">E_GantryMode</span><span class="p">;</span> <span class="o">//</span><span class="n">Current</span> <span class="n">gantry</span> <span class="n">mode</span>
    <span class="n">ModeReq</span><span class="p">:</span>        <span class="n">E_GantryMode</span> <span class="o">:=</span> <span class="n">GantryModeCoupled</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">gantry</span> <span class="n">mode</span>
    <span class="n">Diff</span>    <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span>
    <span class="n">DiffFlt</span> <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span> <span class="n">fault</span><span class="p">,</span> <span class="n">true</span> <span class="n">means</span> <span class="n">fault</span>
    <span class="n">xCoupled</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">xUncouple</span>   <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span><span class="o">//</span><span class="n">Switch</span> <span class="n">to</span> <span class="n">uncouple</span> <span class="n">axis</span>
    <span class="n">PAxisActPos</span>     <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Encoder</span> <span class="n">Readback</span>
    <span class="n">SAxisActPos</span>     <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Encoder</span> <span class="n">Readback</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Parameters</span>
    <span class="n">These</span> <span class="n">should</span> <span class="n">come</span> <span class="n">primarily</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">ESD</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">DiffTol</span> <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.200</span><span class="p">;</span> <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span> <span class="n">tolerance</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>
    <span class="n">DiffHys</span> <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.050</span><span class="p">;</span> <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span> <span class="n">hysteresis</span> <span class="p">(</span><span class="n">mm</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-gantrymode">E_GantryMode</a></p></li>
<li><p><a class="reference internal" href="#homs-gantryaxis">HOMS_GantryAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="homs-gantryaxis">
<h2>HOMS_GantryAxis<a class="headerlink" href="#homs-gantryaxis" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">HOMS_GantryAxis</span> <span class="n">EXTENDS</span> <span class="n">ST_HOMSStepper</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Virtual</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">derived</span> <span class="kn">from</span> <span class="nn">gantry</span> <span class="n">difference</span>
    <span class="n">DecoupledPositiveEnable</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">DecoupledNegativeEnable</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Axis</span> <span class="n">center</span> <span class="k">as</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">Axilon</span> <span class="n">FAT</span><span class="p">,</span> <span class="n">used</span> <span class="k">for</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">calculation</span> <span class="n">adjustment</span>
    <span class="n">cCenter</span> <span class="p">:</span>       <span class="n">DINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Raw</span> <span class="n">encoder</span> <span class="n">count</span>
    <span class="n">diEncCnt</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-homsstepper">ST_HOMSStepper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="homs-pitchmechanismold">
<h2>HOMS_PitchMechanismOld<a class="headerlink" href="#homs-pitchmechanismold" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">HOMS_PitchMechanismOld</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">Piezo</span>   <span class="p">:</span>       <span class="n">ST_PiezoAxisOld</span><span class="p">;</span>        <span class="o">//</span><span class="n">Piezo</span>
    <span class="n">Axis</span>    <span class="p">:</span>       <span class="n">ST_AbstractAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Abstract</span> <span class="n">pitch</span> <span class="n">axis</span>
    <span class="n">Stepper</span> <span class="p">:</span>       <span class="n">ST_HOMSStepper</span><span class="p">;</span> <span class="o">//</span><span class="n">Pitch</span> <span class="n">stepper</span> <span class="n">axis</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">limits</span><span class="p">,</span> <span class="n">egu</span> <span class="n">urad</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">ReqPosLimHi</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="n">ReqPosLimLo</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">Hard</span> <span class="n">limits</span><span class="p">,</span> <span class="n">egu</span> <span class="n">INC</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">These</span> <span class="n">are</span> <span class="n">discovered</span> <span class="n">during</span> <span class="n">installation</span><span class="p">,</span> <span class="ow">and</span> <span class="n">represent</span> <span class="n">encoder</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">unbiased</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">We</span> <span class="n">changed</span> <span class="n">to</span> <span class="n">these</span> <span class="n">when</span> <span class="n">our</span> <span class="n">pitch</span> <span class="n">mechanism</span> <span class="n">limit</span> <span class="n">switches</span> <span class="n">were</span> <span class="n">insufficient</span> <span class="k">for</span>
    <span class="n">good</span> <span class="n">control</span><span class="o">.</span> <span class="n">They</span> <span class="n">had</span> <span class="n">too</span> <span class="n">much</span> <span class="n">hysteresis</span><span class="o">/</span> <span class="n">lack</span> <span class="n">of</span> <span class="n">precision</span><span class="o">.</span> <span class="n">At</span> <span class="n">this</span> <span class="n">point</span> <span class="n">the</span> <span class="n">limit</span>
    <span class="n">switches</span> <span class="n">are</span> <span class="n">ignored</span><span class="p">,</span> <span class="ow">and</span> <span class="n">instead</span> <span class="n">their</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">carried</span> <span class="n">out</span> <span class="n">by</span> <span class="n">these</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">diEncPosLimHi</span>   <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">diEncPosLimLo</span>   <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Raw</span> <span class="n">encoder</span> <span class="n">count</span>
    <span class="n">diEncCnt</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-abstractaxis">ST_AbstractAxis</a></p></li>
<li><p><a class="reference internal" href="#st-homsstepper">ST_HOMSStepper</a></p></li>
<li><p><a class="reference internal" href="#st-piezoaxisold">ST_PiezoAxisOld</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-abstractaxis">
<h2>ST_AbstractAxis<a class="headerlink" href="#st-abstractaxis" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_AbstractAxis</span> <span class="p">:</span>
<span class="n">STRUCT</span>
<span class="p">(</span><span class="o">*</span> <span class="n">ST_BasicAxis</span> <span class="n">was</span> <span class="n">created</span> <span class="k">for</span> <span class="n">basic</span> <span class="n">motion</span> <span class="n">controls</span><span class="o">.</span> <span class="n">AbstractAxis</span>
<span class="ow">is</span> <span class="n">similar</span><span class="p">,</span> <span class="n">but</span> <span class="n">removes</span> <span class="n">some</span> <span class="n">unused</span> <span class="n">elements</span> <span class="n">that</span> <span class="n">don</span><span class="s1">&#39;t apply to axes</span>
<span class="n">that</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">directly</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">hardware</span><span class="p">,</span> <span class="n">eg</span><span class="o">.</span> <span class="n">axes</span> <span class="n">that</span> <span class="n">are</span> <span class="n">combinations</span>
<span class="n">of</span> <span class="n">more</span> <span class="n">than</span> <span class="n">one</span> <span class="n">physical</span> <span class="n">actuator</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xEnable</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">rReqAbsPos</span>  <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
<span class="n">lrVelocity</span>  <span class="p">:</span>       <span class="n">REAL</span>    <span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">mm</span><span class="o">/</span><span class="n">s</span>
<span class="n">xStartAbsMove</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xStop</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xReset</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">Tweak</span> <span class="n">Requests</span>
<span class="n">bTwkFwd</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bTwkBwd</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">rTweak</span>  <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="o">//</span><span class="n">External</span> <span class="n">motor</span> <span class="n">interlock</span><span class="p">,</span> <span class="n">overrides</span> <span class="n">axis</span> <span class="n">enable</span>
<span class="n">i_xMotorInterlock</span>   <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">xHiLS</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xLoLS</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Status</span> <span class="o">*</span><span class="p">)</span>
<span class="n">bBusy</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">bDone</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-coeindsub">
<h2>ST_CoEIndSub<a class="headerlink" href="#st-coeindsub" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_CoEIndSub</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">nIndex</span>  <span class="p">:</span>       <span class="n">WORD</span><span class="p">;</span>
    <span class="n">nSubIndex</span>       <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-decoupledmotionpermits">
<h2>ST_DecoupledMotionPermits<a class="headerlink" href="#st-decoupledmotionpermits" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_DecoupledMotionPermits</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">Positive</span> <span class="n">direction</span> <span class="n">permit</span> <span class="ow">in</span> <span class="n">decoupled</span> <span class="n">mode</span>
    <span class="n">Positive</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Negative</span> <span class="n">direction</span> <span class="n">permit</span> <span class="ow">in</span> <span class="n">decoupled</span> <span class="n">mode</span>
    <span class="n">Negative</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-elmogdcbellcoeparams">
<h2>ST_ElmoGDCBellCoEParams<a class="headerlink" href="#st-elmogdcbellcoeparams" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ElmoGDCBellCoEParams</span> <span class="p">:</span>
<span class="n">STRUCT</span>
        <span class="o">//</span><span class="n">Drive</span> <span class="n">Reference</span> <span class="p">(</span><span class="k">for</span> <span class="n">CoE</span><span class="p">)</span>
        <span class="n">stDriveRef</span>   <span class="p">:</span>      <span class="n">ST_DriveRef</span><span class="p">;</span> <span class="o">//</span><span class="n">Note</span><span class="p">,</span> <span class="n">ignore</span> <span class="n">the</span> <span class="n">ams</span> <span class="nb">id</span> <span class="ow">and</span> <span class="nb">type</span> <span class="n">parameters</span> <span class="k">for</span> <span class="n">our</span> <span class="n">purposes</span><span class="o">.</span>
        <span class="o">//</span><span class="n">Ams</span> <span class="nb">id</span> <span class="n">comes</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">linked</span> <span class="k">global</span> <span class="n">variable</span>
        <span class="n">stPlcDriveRef</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ST_PlcDriveRef</span><span class="p">;</span>

        <span class="n">AmsID</span>       <span class="p">:</span>       <span class="n">T_AmsNetId</span><span class="p">;</span>
        <span class="n">nSlave</span>      <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>

        <span class="o">//</span><span class="n">Additional</span> <span class="n">drive</span> <span class="n">parameters</span>
        <span class="o">//</span><span class="mi">5</span><span class="n">V</span> <span class="n">supply</span> <span class="k">for</span> <span class="n">encoders</span><span class="o">/</span> <span class="n">misc</span>
        <span class="n">ui5VSupply</span> <span class="p">:</span>        <span class="n">UINT</span><span class="p">;</span>
        <span class="o">//</span><span class="n">Drive</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">C</span>
        <span class="n">uiDriveTemp</span> <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">Checksum</span>
        <span class="n">testChecksum</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-homsstepper">
<h2>ST_HOMSStepper<a class="headerlink" href="#st-homsstepper" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_HOMSStepper</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">/////////////////////////////////</span>
    <span class="n">xEnable</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xReset</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">External</span> <span class="n">motor</span> <span class="n">interlock</span><span class="p">,</span> <span class="n">overrides</span> <span class="n">axis</span> <span class="n">enable</span>
    <span class="n">i_xMotorInterlock</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Motion</span> <span class="n">Profile</span>
    <span class="n">fVelocity</span>     <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span> <span class="p">:</span> <span class="n">REAL</span> <span class="p">;</span>
    <span class="o">//</span><span class="n">Tweak</span> <span class="n">Requests</span>
    <span class="n">bTwkFwd</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bTwkBwd</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rTweak</span>  <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Absolute</span> <span class="n">Value</span> <span class="n">Request</span>
    <span class="n">rReqAbsolute</span> <span class="p">:</span> <span class="n">REAL</span><span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Pitch</span> <span class="n">stepper</span> <span class="n">dmov</span> <span class="nb">range</span> <span class="p">(</span><span class="n">urad</span><span class="p">)</span>
    <span class="n">rStepperDmovRange</span>       <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Status</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">Axis</span> <span class="n">Status</span>
    <span class="n">stStatus</span> <span class="p">:</span> <span class="n">ST_StepperStatus</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">IO</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">CoE</span> <span class="n">Stuff</span>
    <span class="o">///////////////////////////////</span>
    <span class="n">stCoE</span>   <span class="p">:</span>       <span class="n">ST_ElmoGDCBellCoEParams</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Drive</span> <span class="n">inputs</span>
    <span class="o">/////////////////////////////</span>
    <span class="n">diInputs</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Drive</span> <span class="n">current</span>
    <span class="n">iDriveCurrent</span>   <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Axis</span> <span class="n">motor</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">stAxis</span>  <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Limit</span> <span class="n">switches</span>
    <span class="n">xHiLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xLoLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>



<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-elmogdcbellcoeparams">ST_ElmoGDCBellCoEParams</a></p></li>
<li><p><a class="reference internal" href="#st-stepperstatus">ST_StepperStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-piezoaxisold">
<h2>ST_PiezoAxisOld<a class="headerlink" href="#st-piezoaxisold" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PiezoAxisOld</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">IO</span> <span class="o">*</span><span class="p">)</span>
        <span class="o">//</span><span class="n">Readback</span>
        <span class="n">sIdn</span>                                <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">Identity</span>
        <span class="n">iCurError</span>                   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Current</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">should</span> <span class="n">be</span> <span class="mi">0</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span>
        <span class="n">iLastError</span>                  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Last</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="k">for</span> <span class="n">history</span>
        <span class="n">rActVoltage</span>                 <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Actual</span> <span class="n">voltage</span>
        <span class="n">rLastReqVoltage</span>             <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Last</span> <span class="n">requested</span> <span class="n">piezo</span> <span class="n">voltage</span>
        <span class="o">//</span><span class="n">Control</span>
        <span class="n">rSetVoltage</span>                 <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">this</span> <span class="n">parameter</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">the</span> <span class="n">control</span> <span class="n">loop</span><span class="o">/</span> <span class="n">voltage</span> <span class="n">mode</span>
        <span class="n">sAxis</span>                               <span class="p">:</span>   <span class="n">STRING</span> <span class="o">:=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span> <span class="o">//</span><span class="n">Axis</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="o">...</span><span class="n">A</span> <span class="k">if</span> <span class="n">single</span> <span class="n">unit</span>
        <span class="o">//</span><span class="n">Summaries</span>
        <span class="n">xTimeout</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
        <span class="n">xDriverError</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Summary</span> <span class="n">of</span> <span class="nb">any</span> <span class="n">driver</span> <span class="n">errors</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Operation</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">xEnable</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Enable</span> <span class="n">control</span><span class="o">.</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">Voltage</span> <span class="n">mode</span> <span class="ow">and</span> <span class="n">Idle</span> <span class="n">mode</span> <span class="n">overrides</span> <span class="s2">&quot;DirectPiezoMode&quot;</span> <span class="n">of</span> <span class="n">FB_PitchControl</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">xVoltageMode</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Voltage</span> <span class="n">mode</span> <span class="n">gives</span> <span class="n">direct</span> <span class="n">access</span> <span class="n">to</span> <span class="n">piezo</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">false</span> <span class="n">means</span> <span class="n">closed</span> <span class="n">loop</span> <span class="n">position</span> <span class="n">acquisition</span> <span class="p">(</span><span class="n">see</span> <span class="n">FB_PitchControl</span> <span class="k">for</span> <span class="n">piezo</span> <span class="ow">and</span> <span class="n">stepper</span> <span class="n">separation</span><span class="p">)</span>
        <span class="n">xIdleMode</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Use</span> <span class="n">to</span> <span class="n">put</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">at</span> <span class="n">half</span><span class="o">-</span><span class="n">stroke</span>
        <span class="n">rReqVoltage</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">piezo</span> <span class="n">voltage</span> <span class="ow">in</span> <span class="n">voltage</span> <span class="n">mode</span>
        <span class="n">rReqAbsPos</span>  <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">Position</span><span class="p">,</span> <span class="n">latched</span> <span class="n">at</span> <span class="n">rising</span> <span class="n">StartAbsMov</span>
        <span class="n">xStop</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Stops</span> <span class="n">piezo</span> <span class="ow">and</span> <span class="n">holds</span> <span class="n">position</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">Control</span> <span class="n">Parameters</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">rActPos</span>     <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Encoder</span> <span class="n">Readback</span>
        <span class="o">//</span><span class="n">Pitch</span> <span class="n">piezo</span> <span class="n">dmove</span> <span class="nb">range</span> <span class="p">(</span><span class="n">urad</span><span class="p">)</span>
        <span class="n">rPiezoDmovRange</span>             <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">stPIParams</span>  <span class="p">:</span>       <span class="n">ST_CTRL_PI_PARAMS</span> <span class="o">:=</span> <span class="p">(</span>
            <span class="n">tCtrlCycleTime</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#0MS,</span>
            <span class="n">tTaskCycleTime</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#0MS,</span>
            <span class="n">tTn</span>       <span class="o">:=</span> <span class="n">T</span><span class="c1">#1S,</span>
            <span class="n">fKp</span>      <span class="o">:=</span> <span class="mf">0.25</span><span class="p">,</span>
            <span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">bARWOnIPartOnly</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Voltage</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">come</span> <span class="kn">from</span> <span class="nn">specifications</span> <span class="n">of</span> <span class="n">the</span> <span class="n">driver</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">UpperVoltage</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="n">cPiezoMaxVoltage</span><span class="p">;</span> <span class="o">//</span> <span class="n">E</span><span class="o">-</span><span class="mi">816</span> <span class="n">has</span> <span class="n">no</span> <span class="n">software</span> <span class="n">limits</span>
        <span class="n">LowerVoltage</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="n">cPiezoMinVoltage</span><span class="p">;</span> <span class="o">//</span> <span class="n">E</span><span class="o">-</span><span class="mi">816</span> <span class="n">has</span> <span class="n">no</span> <span class="n">software</span> <span class="n">limits</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-stepperstatus">
<h2>ST_StepperStatus<a class="headerlink" href="#st-stepperstatus" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_StepperStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rActPosition</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rActVelocity</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Permalink to this heading"></a></h1>
<section id="global-version">
<h2>Global_Version<a class="headerlink" href="#global-version" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcGenerated&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">automatically</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">project</span> <span class="n">information</span><span class="o">.</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;const_non_replaced&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;linkalways&#39;</span><span class="p">}</span>
    <span class="n">stLibVersion_lcls_plc_xrt_optics</span> <span class="p">:</span> <span class="n">ST_LibVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iMajor</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">iMinor</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iBuild</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iRevision</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sVersion</span> <span class="o">:=</span> <span class="s1">&#39;5.1.0&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl">
<h2>GVL<a class="headerlink" href="#gvl" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>
    <span class="n">g_psLogHost</span>     <span class="p">:</span> <span class="n">T_IPv4Addr</span> <span class="o">:=</span> <span class="s1">&#39;172.21.32.9&#39;</span><span class="p">;</span>
    <span class="n">gDefaultSubsystem</span> <span class="p">:</span> <span class="n">E_Subsystem</span> <span class="o">:=</span> <span class="n">MOTION</span><span class="p">;</span>
    <span class="n">gSystemFault</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">gAmsNetIDEcatMaster1</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span> <span class="n">AMSNETID</span><span class="p">;</span>
    <span class="n">gFirstPass</span>      <span class="p">:</span>        <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="o">//</span><span class="n">MPS</span> <span class="n">Outputs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">M2</span><span class="p">:</span><span class="n">OUT</span>
    <span class="s1">&#39;}</span>
    <span class="n">bXRT_M2_OUT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">M2</span><span class="p">:</span><span class="n">IN</span>
    <span class="s1">&#39;}</span>
    <span class="n">bXRT_M2_IN</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Safe</span><span class="o">-</span><span class="n">torque</span><span class="o">-</span><span class="n">off</span> <span class="n">status</span>
    <span class="n">gM1STO</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">gM2STO</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">gM3STO</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Global</span> <span class="n">encoder</span> <span class="n">scale</span>
    <span class="o">//</span> <span class="n">For</span> <span class="n">the</span> <span class="n">HOMS</span><span class="p">,</span> <span class="n">the</span> <span class="n">encoders</span> <span class="n">are</span> <span class="nb">all</span> <span class="mi">1</span><span class="n">nm</span><span class="o">/</span><span class="n">cnt</span> <span class="n">which</span> <span class="n">makes</span> <span class="n">things</span> <span class="n">very</span> <span class="n">easy</span>
    <span class="n">gEncScale</span>       <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Overrides</span>
    <span class="o">////////////////////////////////////</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Use</span> <span class="n">at</span> <span class="n">your</span> <span class="n">own</span> <span class="n">risk</span><span class="o">.</span> <span class="n">These</span> <span class="n">variables</span> <span class="n">may</span> <span class="n">induce</span> <span class="n">unexpected</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">cases</span><span class="p">,</span>
            <span class="ow">and</span> <span class="n">other</span> <span class="n">undesirable</span> <span class="n">effects</span><span class="o">.</span> <span class="n">They</span> <span class="n">are</span> <span class="n">primarily</span> <span class="k">for</span> <span class="n">testing</span> <span class="n">purposes</span><span class="o">.</span> <span class="n">Do</span>
        <span class="ow">not</span> <span class="n">use</span> <span class="n">them</span> <span class="k">for</span> <span class="n">operations</span> <span class="k">except</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">most</span> <span class="n">dire</span> <span class="n">of</span> <span class="n">situations</span><span class="p">,</span> <span class="ow">and</span> <span class="k">with</span>
        <span class="n">full</span> <span class="n">knowledge</span> <span class="ow">and</span> <span class="n">understanding</span> <span class="n">of</span> <span class="n">what</span> <span class="n">they</span> <span class="n">do</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">gBypassVirtualLimits</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-com-buffers">
<h2>GVL_COM_Buffers<a class="headerlink" href="#gvl-com-buffers" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>

    <span class="o">//</span> <span class="n">M1</span>
    <span class="n">Serial_RXBuffer_MR1L3</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">Serial_TXBuffer_MR1L3</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">Serial_RXBuffer_MR1L4</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">Serial_TXBuffer_MR1L4</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">Serial_RXBuffer_MR2L3</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">Serial_TXBuffer_MR2L3</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>


<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-constants">
<h2>GVL_Constants<a class="headerlink" href="#gvl-constants" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>

    <span class="n">cPiezoMaxVoltage</span>        <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">120</span><span class="p">;</span>
    <span class="n">cPiezoMinVoltage</span>        <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span>
    <span class="o">//</span><span class="n">FEE</span><span class="o">-</span><span class="n">M1</span>
    <span class="o">///////////////////////////</span>
    <span class="o">//</span><span class="n">X</span>
    <span class="n">HOMS1_XGantry_PAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">24432540</span><span class="p">;</span>
    <span class="n">HOMS1_XGantry_SAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">25259170</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Y</span>
    <span class="n">HOMS1_YGantry_PAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">14890432</span><span class="p">;</span>
    <span class="n">HOMS1_YGantry_SAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">14845283</span><span class="p">;</span>

    <span class="o">//</span><span class="n">FEE</span><span class="o">-</span><span class="n">M2</span>
    <span class="o">///////////////////////////</span>
    <span class="o">//</span><span class="n">X</span>
    <span class="n">HOMS2_XGantry_PAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">24432540</span><span class="p">;</span>
    <span class="n">HOMS2_XGantry_SAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">25259170</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Y</span>
    <span class="n">HOMS2_YGantry_PAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">14890432</span><span class="p">;</span>
    <span class="n">HOMS2_YGantry_SAxisCenter</span> <span class="p">:</span> <span class="n">DINT</span><span class="o">:=</span><span class="mi">14845283</span><span class="p">;</span>

    <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr1l3">
<h2>GVL_MR1L3<a class="headerlink" href="#gvl-mr1l3" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Mechanism</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.diEncCnt:=TIIB[EL5042_M1L3_PitchBender]^FB Inputs Channel 1^Position&#39;</span><span class="p">}</span>
    <span class="n">MR1L3_Pitch</span> <span class="p">:</span> <span class="n">HOMS_PitchMechanism</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqPosLimHi</span> <span class="o">:=</span> <span class="mi">220</span><span class="p">,</span>
                                         <span class="n">ReqPosLimLo</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">193.0</span><span class="p">,</span>
                                         <span class="n">diEncPosLimHi</span> <span class="o">:=</span> <span class="mi">11216281</span><span class="p">,</span>
                                         <span class="n">diEncPosLimLo</span> <span class="o">:=</span> <span class="mi">11004512</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr1l3-constants">
<h2>GVL_MR1L3_Constants<a class="headerlink" href="#gvl-mr1l3-constants" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">reference</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>
    <span class="o">//</span> <span class="n">Enc</span> <span class="n">Ref</span> <span class="n">Vals</span> <span class="kn">from</span> <span class="nn">alignment</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mi">12</span>
    <span class="n">nYUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">13611000</span><span class="p">;</span>
    <span class="n">nYDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">13433600</span><span class="p">;</span>
    <span class="n">nXUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">25210500</span><span class="p">;</span>
    <span class="n">nXDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">24971800</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr1l4">
<h2>GVL_MR1L4<a class="headerlink" href="#gvl-mr1l4" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Mechanism</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.diEncCnt:=TIIB[EL5042_M1L4_PitchBender]^FB Inputs Channel 1^Position&#39;</span><span class="p">}</span>
    <span class="n">MR1L4_Pitch</span> <span class="p">:</span> <span class="n">HOMS_PitchMechanism</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqPosLimHi</span> <span class="o">:=</span> <span class="mi">246</span><span class="p">,</span>
                                         <span class="n">ReqPosLimLo</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">212.0</span><span class="p">,</span>
                                         <span class="n">diEncPosLimHi</span> <span class="o">:=</span> <span class="mi">9951420</span><span class="p">,</span>
                                         <span class="n">diEncPosLimLo</span> <span class="o">:=</span> <span class="mi">9716400</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr1l4-constants">
<h2>GVL_MR1L4_Constants<a class="headerlink" href="#gvl-mr1l4-constants" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">reference</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>
    <span class="o">//</span> <span class="n">Enc</span> <span class="n">Ref</span> <span class="n">Vals</span> <span class="kn">from</span> <span class="nn">alignment</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mi">12</span>
    <span class="n">nYUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">13663400</span><span class="p">;</span>
    <span class="n">nYDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">15043000</span><span class="p">;</span>
    <span class="n">nXUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">25569700</span><span class="p">;</span>
    <span class="n">nXDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">26702800</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr2l3">
<h2>GVL_MR2L3<a class="headerlink" href="#gvl-mr2l3" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Mechanism</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.diEncCnt:=TIIB[EL5042_M1_PitchBender]^FB Inputs Channel 1^Position&#39;</span><span class="p">}</span>
    <span class="n">MR2L3_Pitch</span> <span class="p">:</span> <span class="n">HOMS_PitchMechanism</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqPosLimHi</span> <span class="o">:=</span> <span class="mi">246</span><span class="p">,</span>
                                         <span class="n">ReqPosLimLo</span> <span class="o">:=</span> <span class="o">-</span><span class="mf">212.0</span><span class="p">,</span>
                                         <span class="n">diEncPosLimHi</span> <span class="o">:=</span> <span class="mi">10349000</span><span class="p">,</span>
                                         <span class="n">diEncPosLimLo</span> <span class="o">:=</span> <span class="mi">9349000</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-mr2l3-constants">
<h2>GVL_MR2L3_Constants<a class="headerlink" href="#gvl-mr2l3-constants" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">reference</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>
    <span class="o">//</span> <span class="n">Enc</span> <span class="n">Ref</span> <span class="n">Vals</span> <span class="kn">from</span> <span class="nn">alignment</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mi">12</span>
    <span class="n">nYUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">14279350</span><span class="p">;</span>
    <span class="n">nYDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">16316457</span><span class="p">;</span>
    <span class="n">nXUP_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">25135760</span><span class="p">;</span>
    <span class="n">nXDWN_ENC_REF</span> <span class="p">:</span> <span class="n">ULINT</span> <span class="o">:=</span> <span class="mi">24091270</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-pmps">
<h2>GVL_PMPS<a class="headerlink" href="#gvl-pmps" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">FFO</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.q_xFastFaultOut:=TIIB[PMPS_FFO]^Channel 1^Output&#39;</span><span class="p">}</span>
    <span class="n">g_FastFaultOutput1</span>  <span class="p">:</span>   <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_sNetID</span><span class="o">:=</span><span class="s1">&#39;172.21.88.66.1.1&#39;</span><span class="p">);</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">FFO</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.q_xFastFaultOut:=TIIB[PMPS_FFO]^Channel 2^Output&#39;</span><span class="p">}</span>
    <span class="n">g_FastFaultOutput2</span>  <span class="p">:</span>   <span class="n">FB_HardwareFFOutput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_sNetID</span><span class="o">:=</span><span class="s1">&#39;172.21.88.66.1.1&#39;</span><span class="p">);</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="n">g_fbArbiter1</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PLC</span><span class="p">:</span><span class="n">XRT</span><span class="p">:</span><span class="n">OPTICS</span><span class="p">:</span><span class="n">ARB</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="n">g_fbArbiter2</span> <span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">PMPS</span> <span class="n">arbiter</span> <span class="n">interface</span>
    <span class="n">fbArbiterIO</span> <span class="p">:</span> <span class="n">FB_SubSysToArbiter_IO</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-rtds">
<h2>GVL_RTDS<a class="headerlink" href="#gvl-rtds" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="o">//</span> <span class="n">M2K4</span> <span class="n">BENDER</span> <span class="n">RTDs</span>

    <span class="o">//</span> <span class="n">M1L3</span> <span class="n">RTDs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L3_1]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L3_RTD_1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L3_2_3]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L3_RTD_2</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L3_2_3]^RTD Inputs Channel 2^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L3_RTD_3</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">M2L3</span> <span class="n">RTDs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR2L3_1]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM2L3_RTD_1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR2L3_2_3]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM2L3_RTD_2</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR2L3_2_3]^RTD Inputs Channel 2^Value&#39;</span><span class="p">}</span>
    <span class="n">nM2L3_RTD_3</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">M1L4</span> <span class="n">RTDs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L4_1]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L4_RTD_1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L4_2_3]^RTD Inputs Channel 1^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L4_RTD_2</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;TIIB[EL3202-0010_MR1L4_2_3]^RTD Inputs Channel 2^Value&#39;</span><span class="p">}</span>
    <span class="n">nM1L4_RTD_3</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-serialio">
<h2>GVL_SerialIO<a class="headerlink" href="#gvl-serialio" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>VAR_GLOBAL
    //Better have your inputs and outputs!
    //Serial_P1_stComIn   AT %I*    :       EL6inData22B (*KL6inData22B*);
    //Serial_P1_stComOut  AT %Q*    :       EL6outData22B (*KL6outData22B*);
     {attribute    &#39;TcLinkTo&#39;    :=    &#39;.Status:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Status;
                                 .D[0]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 0;
                                 .D[1]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 1;
                                 .D[2]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 2;
                                 .D[3]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 3;
                                 .D[4]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 4;
                                 .D[5]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 5;
                                 .D[6]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 6;
                                 .D[7]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 7;
                                 .D[8]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 8;
                                 .D[9]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 9;
                                 .D[10]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 10;
                                 .D[11]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 11;
                                 .D[12]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 12;
                                 .D[13]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 13;
                                 .D[14]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 14;
                                 .D[15]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 15;
                                 .D[16]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 16;
                                 .D[17]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 17;
                                 .D[18]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 18;
                                 .D[19]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 19;
                                 .D[20]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 20;
                                 .D[21]:=TIIB[EL6001_M1L3_PitchFine]^COM Inputs^Data In 21;&#39;}

Serial_stComIn_MR1L3 AT %I* : EL6inData22B; // M1L3 In Serial Comm Array
         {attribute    &#39;TcLinkTo&#39;    :=  &#39;.D[0]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 0;
                                 .D[1]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 1;
                                 .D[2]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 2;
                                 .D[3]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 3;
                                 .D[4]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 4;
                                 .D[5]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 5;
                                 .D[6]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 6;
                                 .D[7]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 7;
                                 .D[8]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 8;
                                 .D[9]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 9;
                                 .D[10]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 10;
                                 .D[11]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 11;
                                 .D[12]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 12;
                                 .D[13]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 13;
                                 .D[14]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 14;
                                 .D[15]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 15;
                                 .D[16]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 16;
                                 .D[17]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 17;
                                 .D[18]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 18;
                                 .D[19]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 19;
                                 .D[20]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 20;
                                 .D[21]:=TIIB[EL6001_M1L3_PitchFine]^COM Outputs^Data Out 21;&#39;}

    Serial_stComOut_MR1L3 AT %Q* : EL6outData22B; // M1 Out Serual Comm Array
         {attribute    &#39;TcLinkTo&#39;    :=    &#39;.Status:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Status;
                                 .D[0]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 0;
                                 .D[1]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 1;
                                 .D[2]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 2;
                                 .D[3]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 3;
                                 .D[4]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 4;
                                 .D[5]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 5;
                                 .D[6]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 6;
                                 .D[7]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 7;
                                 .D[8]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 8;
                                 .D[9]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 9;
                                 .D[10]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 10;
                                 .D[11]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 11;
                                 .D[12]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 12;
                                 .D[13]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 13;
                                 .D[14]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 14;
                                 .D[15]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 15;
                                 .D[16]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 16;
                                 .D[17]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 17;
                                 .D[18]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 18;
                                 .D[19]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 19;
                                 .D[20]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 20;
                                 .D[21]:=TIIB[EL6001_M1L4_PitchFine]^COM Inputs^Data In 21;&#39;}

Serial_stComIn_MR1L4 AT %I* : EL6inData22B;
         {attribute    &#39;TcLinkTo&#39;    :=  &#39;.D[0]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 0;
                                 .D[1]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 1;
                                 .D[2]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 2;
                                 .D[3]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 3;
                                 .D[4]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 4;
                                 .D[5]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 5;
                                 .D[6]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 6;
                                 .D[7]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 7;
                                 .D[8]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 8;
                                 .D[9]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 9;
                                 .D[10]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 10;
                                 .D[11]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 11;
                                 .D[12]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 12;
                                 .D[13]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 13;
                                 .D[14]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 14;
                                 .D[15]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 15;
                                 .D[16]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 16;
                                 .D[17]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 17;
                                 .D[18]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 18;
                                 .D[19]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 19;
                                 .D[20]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 20;
                                 .D[21]:=TIIB[EL6001_M1L4_PitchFine]^COM Outputs^Data Out 21;&#39;}

Serial_stComOut_MR1L4 AT %Q* : EL6outData22B; // xrt M2 MR1L4 Out Serual Comm Array
    {attribute    &#39;TcLinkTo&#39;    :=    &#39;.Status:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Status;
                                 .D[0]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 0;
                                 .D[1]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 1;
                                 .D[2]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 2;
                                 .D[3]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 3;
                                 .D[4]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 4;
                                 .D[5]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 5;
                                 .D[6]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 6;
                                 .D[7]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 7;
                                 .D[8]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 8;
                                 .D[9]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 9;
                                 .D[10]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 10;
                                 .D[11]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 11;
                                 .D[12]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 12;
                                 .D[13]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 13;
                                 .D[14]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 14;
                                 .D[15]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 15;
                                 .D[16]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 16;
                                 .D[17]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 17;
                                 .D[18]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 18;
                                 .D[19]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 19;
                                 .D[20]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 20;
                                 .D[21]:=TIIB[EL6001_M2L3_PitchFine]^COM Inputs^Data In 21;&#39;}

    Serial_stComIn_MR2L3 AT %I* : EL6inData22B; // M3 In Serial Comm Array
     {attribute    &#39;TcLinkTo&#39;    :=  &#39;.D[0]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 0;
                                 .D[1]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 1;
                                 .D[2]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 2;
                                 .D[3]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 3;
                                 .D[4]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 4;
                                 .D[5]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 5;
                                 .D[6]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 6;
                                 .D[7]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 7;
                                 .D[8]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 8;
                                 .D[9]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 9;
                                 .D[10]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 10;
                                 .D[11]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 11;
                                 .D[12]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 12;
                                 .D[13]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 13;
                                 .D[14]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 14;
                                 .D[15]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 15;
                                 .D[16]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 16;
                                 .D[17]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 17;
                                 .D[18]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 18;
                                 .D[19]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 19;
                                 .D[20]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 20;
                                 .D[21]:=TIIB[EL6001_M2L3_PitchFine]^COM Outputs^Data Out 21;&#39;}

    Serial_stComOut_MR2L3 AT %Q* : EL6outData22B; // M3 Out Serual Comm Array
END_VAR
</pre></div>
</div>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Permalink to this heading"></a></h1>
<section id="f-piezoposition">
<h2>F_PiezoPosition<a class="headerlink" href="#f-piezoposition" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_PiezoPosition</span> <span class="p">:</span> <span class="n">REAL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">rPiezoVoltage</span>   <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">The</span> <span class="n">readback</span> <span class="n">piezo</span> <span class="n">voltage</span>
    <span class="n">arCalibrationTable</span>      <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Piezo</span> <span class="n">Calibration</span> <span class="n">Table</span> <span class="k">for</span> <span class="n">interpolation</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Piezo</span> <span class="n">Position</span>

<span class="n">This</span> <span class="n">function</span> <span class="n">attempts</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">an</span> <span class="n">estimated</span> <span class="n">piezo</span> <span class="n">position</span> <span class="n">given</span>
<span class="n">a</span> <span class="n">calibration</span> <span class="n">table</span> <span class="ow">and</span> <span class="n">a</span> <span class="n">readback</span> <span class="n">piezo</span> <span class="n">voltage</span><span class="o">.</span>

<span class="n">Notes</span><span class="p">:</span>
<span class="o">-</span><span class="n">calibration</span> <span class="n">table</span> <span class="n">may</span> <span class="n">be</span> <span class="o">&gt;</span><span class="mi">2</span><span class="n">D</span><span class="p">,</span> <span class="k">with</span> <span class="n">the</span> <span class="n">extra</span> <span class="n">dimension</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">anticipated</span> <span class="n">loading</span>
<span class="o">-</span><span class="n">calibration</span> <span class="n">table</span> <span class="n">may</span> <span class="n">be</span> <span class="n">offset</span> <span class="n">by</span> <span class="n">some</span> <span class="n">dc</span> <span class="n">value</span>
<span class="o">-</span><span class="n">thinking</span> <span class="n">along</span> <span class="n">the</span> <span class="n">lines</span> <span class="n">of</span> <span class="n">piezo</span> <span class="n">loading</span><span class="p">,</span> <span class="k">if</span> <span class="n">the</span> <span class="n">force</span> <span class="n">on</span> <span class="n">the</span> <span class="n">actuator</span> <span class="n">follows</span>
<span class="n">Hooke</span><span class="s1">&#39;s law or just increases with travel from normal, the piezo voltage required</span>
<span class="k">for</span> <span class="n">a</span> <span class="n">desired</span> <span class="n">displacement</span> <span class="n">will</span> <span class="n">increase</span><span class="o">.</span> <span class="n">Maybe</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">overkill</span><span class="o">.</span> <span class="n">Maybe</span> <span class="n">we</span> <span class="n">should</span>
<span class="n">just</span> <span class="n">implement</span> <span class="n">a</span> <span class="n">realtime</span> <span class="n">feedback</span> <span class="ow">and</span> <span class="n">let</span> <span class="n">the</span> <span class="n">center</span><span class="o">-</span><span class="n">point</span> <span class="n">finder</span> <span class="n">do</span> <span class="n">the</span> <span class="n">work</span><span class="o">...</span>

<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="fb-coating-states">
<h2>FB_Coating_States<a class="headerlink" href="#fb-coating-states" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Coating_States</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase_WithPMPS</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span> <span class="p">:</span> <span class="n">ENUM_Coating_States</span><span class="p">;</span>

    <span class="n">stCoating1</span> <span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
    <span class="n">stCoating2</span> <span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span><span class="p">;</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span> <span class="p">:</span> <span class="n">ENUM_Coating_States</span><span class="p">;</span>
  <span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bCoatingInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">if</span> <span class="n">NOT</span> <span class="n">bCoatingInit</span> <span class="n">THEN</span>
    <span class="n">bCoatingInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stCoating1</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stCoating2</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-coating-states">ENUM_Coating_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-coating-states-nopmps">
<h2>FB_Coating_States_noPMPS<a class="headerlink" href="#fb-coating-states-nopmps" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Coating_States_noPMPS</span> <span class="n">EXTENDS</span> <span class="n">FB_PositionStateBase</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumSet</span> <span class="p">:</span> <span class="n">ENUM_Coating_States</span><span class="p">;</span>

    <span class="n">stCoating1</span> <span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
    <span class="n">stCoating2</span> <span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
      <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span><span class="p">;</span>
      <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">enumGet</span> <span class="p">:</span> <span class="n">ENUM_Coating_States</span><span class="p">;</span>
  <span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bCoatingInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="k">if</span> <span class="n">NOT</span> <span class="n">bCoatingInit</span> <span class="n">THEN</span>
    <span class="n">bCoatingInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">arrStates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stCoating1</span><span class="p">;</span>
    <span class="n">arrStates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stCoating2</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">setState</span> <span class="o">:=</span> <span class="n">enumSet</span><span class="p">;</span>
<span class="n">Exec</span><span class="p">();</span>
<span class="n">enumGet</span> <span class="o">:=</span> <span class="n">getState</span><span class="p">;</span>
<span class="n">enumSet</span> <span class="o">:=</span> <span class="n">setState</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#enum-coating-states">ENUM_Coating_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-drive">
<h2>FB_Drive<a class="headerlink" href="#fb-drive" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Drive</span>
<span class="n">VAR</span>
    <span class="n">sVersion</span><span class="p">:</span> <span class="n">STRING</span><span class="o">:=</span><span class="s1">&#39;1.0.2&#39;</span><span class="p">;</span>
    <span class="n">bMovingRelOrAbs</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">En</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnable</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">/////</span>   <span class="n">nCommand</span><span class="o">...</span>
    <span class="o">/////</span>   <span class="mi">0</span> <span class="o">=</span> <span class="n">Jog</span>
    <span class="o">/////</span>   <span class="mi">1</span> <span class="o">=</span> <span class="n">MoveVelocity</span>
    <span class="o">/////</span>   <span class="mi">2</span> <span class="o">=</span> <span class="n">MoveRelative</span>
    <span class="o">/////</span>   <span class="mi">3</span> <span class="o">=</span> <span class="n">MoveAbsolut</span>
    <span class="o">/////</span>   <span class="mi">4</span> <span class="o">=</span> <span class="n">MoveModulo</span>
    <span class="o">/////</span>   <span class="mi">10</span> <span class="o">=</span> <span class="n">Homing</span>
    <span class="o">/////</span>   <span class="mi">20</span> <span class="o">=</span> <span class="n">SuperInp</span> <span class="o">&gt;&gt;&gt;</span><span class="n">ToBe</span>
    <span class="o">/////</span>   <span class="mi">30</span> <span class="o">=</span> <span class="n">Gear</span>
    <span class="n">nCommand</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCmdData</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAcceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeceleration</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bJogFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bJogBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitFwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitBwd</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fOverride</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">bHomeSensor</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fHomePosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nHomeRevOffset</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">MasterAxis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="n">nMotionAxisID</span><span class="p">:</span><span class="n">UDINT</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>  <span class="o">//</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Motion</span> <span class="p">(</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">bChanChangingDirection</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">EnO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bEnabled</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomed</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">Status</span><span class="p">:</span> <span class="n">ST_AxisStatus</span><span class="p">;</span>
    <span class="n">fActVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActPosition</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fActDiff</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">sErrorMessage</span><span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
    <span class="n">stStepperStatus</span><span class="p">:</span> <span class="n">ST_StepperStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bFirstScan</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iCounter</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fOldVelocity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fbReset</span><span class="p">:</span> <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">fbPower</span><span class="p">:</span> <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">fbHalt</span><span class="p">:</span> <span class="n">MC_Halt</span><span class="p">;</span>
    <span class="n">fbJog</span><span class="p">:</span> <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">fbMoveVelocity</span><span class="p">:</span> <span class="n">MC_MoveVelocity</span><span class="p">;</span>
    <span class="n">fbMoveRelative</span><span class="p">:</span> <span class="n">MC_MoveRelative</span><span class="p">;</span>
    <span class="n">fbMoveAbsolute</span><span class="p">:</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">fbMoveModulo</span><span class="p">:</span> <span class="n">MC_MoveModulo</span><span class="p">;</span>
    <span class="n">fbHome</span><span class="p">:</span> <span class="n">MC_Home</span><span class="p">;</span>
    <span class="n">fbGearInDyn</span><span class="p">:</span> <span class="n">MC_GearInDyn</span><span class="p">;</span>
    <span class="n">fbGearOut</span><span class="p">:</span> <span class="n">MC_GearOut</span><span class="p">;</span>

    <span class="o">////////////////////////////////////</span>
<span class="o">//</span>  <span class="n">fbReadParameter2</span><span class="p">:</span><span class="n">FB_ReadParameterInNc_v1_00</span><span class="p">;</span>
    <span class="n">fbReadFloatParameter</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
    <span class="n">fbReadFloatParameter2</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
    <span class="n">fbReadFloatParameter3</span><span class="p">:</span><span class="n">FB_ReadFloatParameter</span><span class="p">;</span>
    <span class="n">fbWriteParameter</span><span class="p">:</span><span class="n">FB_WriteParameterInNc</span><span class="p">;</span>
    <span class="n">fbWriteParameter2</span><span class="p">:</span><span class="n">FB_WriteParameterInNc</span><span class="p">;</span>
    <span class="n">fbWriteParameter3</span><span class="p">:</span><span class="n">FB_WriteParameterInNc</span><span class="p">;</span>
    <span class="n">fbWriteParameter4</span><span class="p">:</span><span class="n">FB_WriteParameterInNc</span><span class="p">;</span>
    <span class="n">fbRiseTrigger</span><span class="p">:</span><span class="n">R_trig</span><span class="p">;</span>
    <span class="n">fDistance</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fCenterPosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fHomeVelocity</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fHomeReverseVelocity</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPositionAfterSensor</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fSkipPosition</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fScalingFactor</span><span class="p">:</span><span class="n">LREAL</span><span class="p">;</span>
    <span class="n">nCounter</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCounter2</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nDelayCounter</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nCalculatedCounter</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nRealDirection</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nExecutionCounter</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nLimitCounter</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">nInternalHomeRevOffset</span><span class="p">:</span><span class="n">UINT</span><span class="p">;</span>
    <span class="n">bHomeflag</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomeTrigg</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitTrigg</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bCenterCalculated</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDirection</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bChangeDir</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bReadyToGo</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bFlag1</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bFlagWrite4Done</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMode6Flag</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDirectionFlag</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bStartAtLimitSwitch</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingToggled</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState1</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState2</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState3</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState4</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState5</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingState6</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bHomingExecute</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bLimitTimeOut</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bChangingDirection</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fConvertPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="o">////////////////////////////////</span>
<span class="n">END_VAR</span>
<span class="n">EnO</span><span class="o">:=</span><span class="n">En</span><span class="p">;</span>

<span class="n">bHomed</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Homed</span><span class="p">;</span> <span class="o">//</span><span class="n">Add</span> <span class="ow">in</span> <span class="n">DUT_AxisStatus</span> <span class="n">later</span>

<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bReset</span><span class="p">);</span>

<span class="o">//</span><span class="n">Update</span> <span class="n">Axis</span> <span class="n">status</span>
<span class="n">Axis</span><span class="p">();</span>
<span class="p">(</span><span class="o">*</span><span class="n">Reset</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbReset</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Power</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbPower</span><span class="p">(</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Enable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">,</span>
    <span class="n">Enable_Positive</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bChangeDir</span> <span class="n">AND</span> <span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSyncError</span> <span class="n">AND</span> <span class="p">(</span><span class="n">bLimitFwd</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bLimitTimeOut</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">2</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span>  <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">1</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span><span class="p">)))),</span>
    <span class="n">Enable_Negative</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bChangeDir</span> <span class="n">AND</span> <span class="n">bEnable</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bSyncError</span> <span class="n">AND</span> <span class="p">(</span><span class="n">bLimitBwd</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bLimitTimeOut</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">2</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span>  <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">1</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span><span class="p">)))),</span>
    <span class="n">Override</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Status</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Halt</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbHalt</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">bExecute</span>  <span class="n">AND</span> <span class="p">(((</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Busy</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">fbhome</span><span class="o">.</span><span class="n">Busy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span><span class="p">))),</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span> <span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>


<span class="p">(</span><span class="o">*</span><span class="n">MoveRelative</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveRelative</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">Distance</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">MoveAbsolute</span> <span class="p">(</span><span class="n">Command</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">)</span>
<span class="n">fbMoveAbsolute</span><span class="p">(</span>
    <span class="n">Execute</span><span class="o">:=</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCommand</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">Position</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">ABS</span><span class="p">(</span><span class="n">fVelocity</span><span class="p">),</span>
    <span class="n">Acceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">,</span>
    <span class="n">Deceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">,</span>
    <span class="n">Jerk</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">BufferMode</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Options</span><span class="o">:=</span> <span class="p">,</span>
    <span class="n">Axis</span><span class="o">:=</span><span class="n">Axis</span><span class="p">,</span>
    <span class="n">Done</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Busy</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Active</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">CommandAborted</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">fOldVelocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Busy</span><span class="o">*</span><span class="p">)</span>
<span class="n">bMovingRelOrAbs</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nCommand</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">OR</span> <span class="n">nCommand</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">InTargetPosition</span><span class="p">;</span>
<span class="n">bBusy</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HasJob</span> <span class="n">OR</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">HomingBusy</span> <span class="n">OR</span> <span class="n">bChangingDirection</span> <span class="n">OR</span>  <span class="n">bMovingRelOrAbs</span><span class="p">;</span>
<span class="n">bDone</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bBusy</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Enabled</span><span class="o">*</span><span class="p">)</span>
<span class="n">bEnabled</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="kn">from</span> <span class="nn">functions</span> <span class="ow">and</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbPower</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">fbHalt</span><span class="o">.</span><span class="n">Active</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHalt</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">fbJog</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="n">OR</span> <span class="n">fbJog</span><span class="o">.</span><span class="n">JogBackwards</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbJog</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">1</span><span class="p">(</span><span class="o">*</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveVelocity</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">2</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveRelative</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">3</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveAbsolute</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCOmmand</span><span class="o">=</span><span class="mi">4</span> <span class="p">(</span><span class="o">*</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbMoveModulo</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbHome</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="p">(</span><span class="o">*</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbHome</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">30</span> <span class="p">(</span><span class="o">*</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Active</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearInDyn</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbGearOut</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">30</span> <span class="n">AND</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Coupled</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">Execute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbGearOut</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span>  <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">ELSIF</span> <span class="n">fbWriteToNC</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteToNC</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
<span class="o">///////////////////////////////////</span>
<span class="n">ELSIF</span> <span class="n">fbWriteParameter</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbWriteParameter</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteParameter</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteParameter</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteParameter2</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbWriteParameter2</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteParameter2</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteParameter2</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteParameter3</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbWriteParameter3</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteParameter3</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteParameter3</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbWriteParameter4</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbWriteParameter4</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbWriteParameter4</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbWriteParameter4</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadFloatParameter</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbReadFloatParameter</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbReadFloatParameter</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadFloatParameter</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadFloatParameter2</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbReadFloatParameter2</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbReadFloatParameter2</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadFloatParameter2</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbReadFloatParameter3</span><span class="o">.</span><span class="n">bError</span> <span class="n">AND</span> <span class="n">fbReadFloatParameter3</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">fbReadFloatParameter3</span><span class="o">.</span><span class="n">bExecute</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbReadFloatParameter3</span><span class="o">.</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="o">///////////////////////////////////</span><span class="n">Homing</span> <span class="n">Errors</span> <span class="n">Treatment</span> <span class="mh">0x4D</span><span class="n">nn</span><span class="o">///////////////////</span>
<span class="n">ELSIF</span> <span class="n">bHomingState1</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomingState6</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomingToggled</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D01;      //bExecute gets down before bHomed</span>
<span class="n">ELSIF</span> <span class="n">bHomeflag</span> <span class="n">AND</span> <span class="n">bLimitTrigg</span>  <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="n">AND</span> <span class="n">nCmdData</span><span class="o">&lt;=</span><span class="mi">5</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D02; //HomeSensor not detected    (*Mode 2 and Mode 3*)</span>
<span class="n">ELSIF</span> <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bLimitFwd</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomingToggled</span> <span class="n">THEN</span>
    <span class="n">bHomingExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D03; //Unsual error. (The sensor is detected but don&#39;t stopped after that)</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">fActPosition</span><span class="o">&lt;=</span><span class="n">fPositionAfterSensor</span><span class="o">-</span><span class="n">fScalingFactor</span><span class="o">*</span><span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">nInternalHomeRevOffset</span><span class="p">)</span>  <span class="n">AND</span>  <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomed</span>  <span class="n">THEN</span>
    <span class="n">bHomingExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>       <span class="o">//</span><span class="n">Could</span> <span class="n">be</span> <span class="n">done</span> <span class="n">like</span> <span class="n">that</span> <span class="ow">or</span> <span class="n">wait</span> <span class="n">till</span> <span class="n">blimitswitch</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D04; //Not Sync Pulse detected</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">fActPosition</span><span class="o">&gt;=</span><span class="n">fPositionAfterSensor</span><span class="o">+</span><span class="n">fScalingFactor</span><span class="o">*</span><span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">nInternalHomeRevOffset</span><span class="p">)</span> <span class="n">AND</span> <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomed</span> <span class="n">THEN</span>
    <span class="n">bHomingExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D04; //Not Sync Pulse detected</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">nHomeRevOffset</span><span class="o">=</span><span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D05; //Index Can&#39;t be 0</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="p">((</span><span class="n">NOT</span> <span class="n">bLimitBwd</span> <span class="n">AND</span> <span class="n">nRealDirection</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">OR</span> <span class="p">(</span><span class="n">NOT</span> <span class="n">bLimitFwd</span> <span class="n">AND</span> <span class="n">nRealDirection</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D06; //More Index pulses selected than possible</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="n">fActPosition</span><span class="o">&gt;=</span><span class="p">(</span><span class="n">fPositionAfterSensor</span><span class="o">+</span><span class="n">fScalingFactor</span><span class="o">*</span><span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">nInternalHomeRevOffset</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomingState5</span> <span class="n">THEN</span> <span class="o">//</span><span class="k">if</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t detect the Searching Sync State</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D07; //Not Encoder, therefore not able to use  Mode 5</span>
<span class="n">ELSIF</span> <span class="n">nCommand</span><span class="o">=</span><span class="mi">10</span> <span class="n">AND</span> <span class="p">(</span><span class="n">nCmdData</span><span class="o">=</span><span class="mi">9</span> <span class="n">OR</span> <span class="n">nCmdData</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="n">AND</span> <span class="n">bHomingState4</span> <span class="n">AND</span> <span class="n">fActPosition</span><span class="o">&lt;=</span><span class="p">(</span><span class="n">fPositionAfterSensor</span><span class="o">-</span><span class="n">fScalingFactor</span><span class="o">*</span><span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">nInternalHomeRevOffset</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bHomingState5</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bSyncError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D07; //Not Encoder, therefore not able to use  Mode 5</span>

<span class="o">///////////////////////////////////</span>
<span class="n">ELSIF</span> <span class="n">nLimitCounter</span><span class="o">&gt;=</span><span class="mi">300</span> <span class="n">THEN</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bLimitTimeOut</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#4D08; //Error in the Limit Switch.</span>
<span class="o">///////////////////////////////////</span>
<span class="n">ELSE</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Converese</span> <span class="n">nErrorID</span> <span class="n">to</span> <span class="n">string</span><span class="o">*</span><span class="p">)</span>
<span class="n">sErrorMessage</span><span class="o">:=</span><span class="n">WORD_TO_HEXSTR</span><span class="p">(</span><span class="ow">in</span><span class="o">:=</span><span class="n">TO_WORD</span><span class="p">(</span><span class="n">nErrorID</span><span class="p">)</span> <span class="p">,</span> <span class="n">iPrecision</span><span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bLoCase</span><span class="o">:=</span><span class="mi">0</span> <span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">Status</span> <span class="kn">from</span> <span class="nn">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">Status</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Axis</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">motion</span> <span class="s2">&quot;motor&quot;</span><span class="o">*</span><span class="p">)</span>
<span class="n">nMotionAxisID</span><span class="o">:=</span><span class="n">axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Velocity</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActVelocity</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActVelo</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OpMode</span><span class="o">.</span><span class="n">Modulo</span> <span class="n">THEN</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ModuloActPos</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">fActPosition</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span><span class="n">Actual</span> <span class="n">Position</span><span class="o">*</span><span class="p">)</span>
<span class="n">fActDiff</span><span class="o">:=</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">PosDiff</span><span class="p">;</span>

<span class="o">//</span><span class="n">Status</span> <span class="n">struct</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">communication</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bEnable</span><span class="o">:=</span><span class="n">bEnable</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bEnabled</span><span class="o">:=</span><span class="n">bEnabled</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bError</span><span class="o">:=</span><span class="n">bError</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bHomeSensor</span><span class="o">:=</span><span class="n">bHomeSensor</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bJogBwd</span><span class="o">:=</span><span class="n">bJogBwd</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bJogFwd</span><span class="o">:=</span><span class="n">bJogFwd</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bLimitBwd</span><span class="o">:=</span><span class="n">bLimitBwd</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bLimitFwd</span><span class="o">:=</span><span class="n">bLimitFwd</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bReset</span><span class="o">:=</span><span class="n">bReset</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fAcceleration</span><span class="o">:=</span><span class="n">fAcceleration</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fActDiff</span><span class="o">:=</span><span class="n">fActDiff</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="o">:=</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fActVelocity</span><span class="o">:=</span><span class="n">fActVelocity</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fDeceleration</span><span class="o">:=</span><span class="n">fDeceleration</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fOverride</span><span class="o">:=</span><span class="n">fOverride</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fPosition</span><span class="o">:=</span><span class="n">fPosition</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">fVelocity</span><span class="o">:=</span><span class="n">fVelocity</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">rActPosition</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">fActPosition</span><span class="p">);</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">rActVelocity</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">fActVelocity</span><span class="p">);</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">nCmdData</span><span class="o">:=</span><span class="n">nCmdData</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">nCommand</span><span class="o">:=</span><span class="n">nCommand</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">nErrorId</span><span class="o">:=</span><span class="n">nErrorId</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bBusy</span><span class="o">:=</span><span class="n">bBusy</span><span class="p">;</span>
<span class="n">stStepperStatus</span><span class="o">.</span><span class="n">bHomed</span><span class="o">:=</span><span class="n">bHomed</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bFirstScan</span> <span class="n">THEN</span>
    <span class="n">bFirstScan</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-readfloatparameter">FB_ReadFloatParameter</a></p></li>
<li><p><a class="reference internal" href="#st-stepperstatus">ST_StepperStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-elmogdcbellcoe">
<h2>FB_ElmoGDCBellCoE<a class="headerlink" href="#fb-elmogdcbellcoe" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ElmoGDCBellCoE</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stCoE</span>   <span class="p">:</span>       <span class="n">ST_ElmoGDCBellCoEParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbCoERead</span>       <span class="p">:</span>       <span class="n">FB_CoERead_ByDriveRef</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">To</span> <span class="n">make</span> <span class="n">up</span> <span class="k">for</span> <span class="ow">not</span> <span class="n">having</span> <span class="n">a</span> <span class="o">.</span><span class="n">bDone</span> <span class="n">output</span>
    <span class="n">ftCoeReadBusy</span><span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">CaseVar</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">udiIP</span>   <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">uiChecksum</span>      <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">pTempPointer</span> <span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">fTempFloat</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">c5VSupply</span> <span class="p">:</span> <span class="n">ST_CoEIndSub</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nIndex</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#2206, nSubIndex:=0);</span>
    <span class="n">cDriveTemp</span> <span class="p">:</span> <span class="n">ST_CoEIndSub</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nIndex</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#22A3, nSubIndex:=1);</span>
    <span class="n">cIP</span> <span class="p">:</span> <span class="n">ST_CoEIndSub</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nIndex</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#1111, nSubIndex:=1);</span>
    <span class="n">cParamChksm</span>     <span class="p">:</span>       <span class="n">ST_CoEIndSub</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nIndex</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#2060, nSubIndex:=0);</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">17</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">22</span>
<span class="n">ElmoMC</span> <span class="n">Gold</span> <span class="n">DC</span> <span class="n">Bell</span> <span class="n">CoE</span> <span class="n">Read</span>

<span class="n">This</span> <span class="n">FB</span> <span class="n">cyclically</span> <span class="n">reads</span> <span class="n">CoE</span> <span class="n">Parameters</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">ElmoMC</span> <span class="n">drives</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">CASE</span> <span class="n">CaseVar</span> <span class="n">OF</span>

<span class="mi">1</span><span class="p">:</span>
<span class="o">//</span><span class="n">Drive</span> <span class="n">temperature</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nIndex</span> <span class="o">:=</span> <span class="n">cDriveTemp</span><span class="o">.</span><span class="n">nIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nSubIndex</span> <span class="o">:=</span> <span class="n">cDriveTemp</span><span class="o">.</span><span class="n">nSubIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">pDstBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">stCoE</span><span class="o">.</span><span class="n">uiDriveTemp</span><span class="p">);</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">stCoE</span><span class="o">.</span><span class="n">uiDriveTemp</span><span class="p">);</span>
<span class="n">pTempPointer</span> <span class="o">:=</span> <span class="n">fbCoERead</span><span class="o">.</span><span class="n">pDstBuf</span><span class="p">;</span>
<span class="n">fTempFloat</span> <span class="o">:=</span> <span class="n">pTempPointer</span><span class="o">^</span><span class="p">;</span>
<span class="mi">2</span><span class="p">:</span>
<span class="o">//</span><span class="mi">5</span><span class="n">v</span> <span class="n">supply</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nIndex</span> <span class="o">:=</span> <span class="n">c5vSupply</span><span class="o">.</span><span class="n">nIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nSubIndex</span> <span class="o">:=</span> <span class="n">c5vSupply</span><span class="o">.</span><span class="n">nSubIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">pDstBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">stCoE</span><span class="o">.</span><span class="n">ui5VSupply</span><span class="p">);</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">stCoE</span><span class="o">.</span><span class="n">ui5VSupply</span><span class="p">);</span>
<span class="mi">3</span><span class="p">:</span>
<span class="o">//</span><span class="n">Parameter</span> <span class="n">checksum</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nIndex</span> <span class="o">:=</span> <span class="n">cParamChksm</span><span class="o">.</span><span class="n">nIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nSubIndex</span> <span class="o">:=</span> <span class="n">cParamChksm</span><span class="o">.</span><span class="n">nSubIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">pDstBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">uiChecksum</span><span class="p">);</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">uiChecksum</span><span class="p">);</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">testChecksum</span> <span class="o">:=</span> <span class="n">UDINT_TO_DINT</span><span class="p">(</span><span class="n">uiChecksum</span><span class="p">);</span>
<span class="mi">4</span><span class="p">:</span>
<span class="o">//</span><span class="n">IP</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nIndex</span> <span class="o">:=</span> <span class="n">cIP</span><span class="o">.</span><span class="n">nIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">nSubIndex</span> <span class="o">:=</span> <span class="n">cIP</span><span class="o">.</span><span class="n">nSubIndex</span><span class="p">;</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">pDstBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">udiIP</span><span class="p">);</span>
<span class="n">fbCoERead</span><span class="o">.</span><span class="n">cbBufLen</span> <span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">udiIP</span><span class="p">);</span>
<span class="n">END_CASE</span>


<span class="n">fbCoERead</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ftCoeReadBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbCoERead</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">ftCoeReadBusy</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">fbCoERead</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//&lt;</span><span class="n">TODO</span><span class="o">&gt;</span> <span class="n">check</span> <span class="k">for</span> <span class="n">errors</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbCoERead</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="o">//</span><span class="n">Switch</span> <span class="n">to</span> <span class="n">the</span> <span class="n">other</span> <span class="n">case</span>
        <span class="n">CaseVar</span> <span class="o">:=</span> <span class="n">CaseVar</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">CaseVar</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">CaseVar</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="n">ELSE</span>
        <span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">ACT_CoEReadFB</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_CoEReadFB</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-coeindsub">ST_CoEIndSub</a></p></li>
<li><p><a class="reference internal" href="#st-elmogdcbellcoeparams">ST_ElmoGDCBellCoEParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-elmomcuploaddriveparams">
<h2>FB_ElmoMCUploadDriveParams<a class="headerlink" href="#fb-elmomcuploaddriveparams" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ElmoMCUploadDriveParams</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Axis</span>    <span class="p">:</span>       <span class="n">ST_HOMSStepper</span><span class="p">;</span>
    <span class="n">bExecute</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bError</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbUploadDriveParams</span> <span class="p">:</span> <span class="n">FB_EcFoeLoad</span><span class="p">;</span>
    <span class="n">fbFoeOpen</span>       <span class="p">:</span>       <span class="n">FB_EcFoeOpen</span><span class="p">;</span>
    <span class="n">fbFoeAccess</span>     <span class="p">:</span>       <span class="n">FB_EcFoeAccess</span><span class="p">;</span>
    <span class="n">fbFoeClose</span>      <span class="p">:</span>       <span class="n">FB_EcFoeClose</span><span class="p">;</span>
    <span class="n">fbFileOpen</span>      <span class="p">:</span>       <span class="n">FB_FileOpen</span><span class="p">;</span>
    <span class="n">fbFileRead</span>      <span class="p">:</span>       <span class="n">FB_FileRead</span><span class="p">;</span>
    <span class="n">fbFileClose</span>     <span class="p">:</span>       <span class="n">FB_FileClose</span><span class="p">;</span>
    <span class="n">ftBusy</span>  <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtExecute</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftFoeOpen</span>       <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">ftFoeAccess</span>     <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">ftFoeClose</span>      <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">fbReqSlaveState</span> <span class="p">:</span>       <span class="n">FB_EcSetSlaveState</span><span class="p">;</span>
    <span class="n">fbGetSlaveState</span> <span class="p">:</span>       <span class="n">FB_EcGetSlaveState</span><span class="p">;</span>
    <span class="n">iStep</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">FoeHandle</span>       <span class="p">:</span>       <span class="n">T_HFoe</span><span class="p">;</span>
    <span class="n">FileHandle</span>      <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
    <span class="n">stDiag</span>  <span class="p">:</span>       <span class="n">ST_fbDiagnostics</span><span class="p">;</span>
    <span class="n">FileBuffer</span>      <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..500000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">prevSlaveState</span> <span class="p">:</span> <span class="n">ST_EcSlaveState</span><span class="p">;</span>
    <span class="n">sPath</span>   <span class="p">:</span>       <span class="n">T_MaxString</span> <span class="o">:=</span> <span class="s1">&#39;\Hard Disk\WWW\FoePrmFlashImage_XML.xml&#39;</span><span class="p">;</span>
    <span class="n">Password</span><span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#F0EACCEC;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">stepError</span>       <span class="p">:</span>       <span class="n">INT</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">stepClose</span>       <span class="p">:</span>       <span class="n">INT</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ftFoeOpen</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbFoeOpen</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">ftFoeAccess</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">ftFoeClose</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbFoeClose</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>

<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
    <span class="p">;</span>
    <span class="mi">4</span><span class="p">:</span>
    <span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="mi">5</span><span class="p">:</span>
    <span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Get slave state Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">prevSlaveState</span> <span class="o">:=</span> <span class="n">fbGetSlaveState</span><span class="o">.</span><span class="n">state</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">6</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Move</span> <span class="n">to</span> <span class="n">bootstrap</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">reqState</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#03; //bootstrap</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">7</span><span class="p">:</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Set slave state Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">10</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Open</span> <span class="n">connection</span>
    <span class="n">fbFoeOpen</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">ftFoeOpen</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">fbFoeOpen</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">fbFoeOpen</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFoeOpen</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FoeOpen Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">20</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Open</span> <span class="n">File</span>
    <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">21</span><span class="p">:</span>
    <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbFileOpen</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFileOpen</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FileOpen Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">22</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Read</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">file</span>
    <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="mi">23</span><span class="p">:</span>
    <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbFileRead</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFileRead</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FileRead Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">30</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Send</span> <span class="n">file</span>
    <span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="mi">31</span><span class="p">:</span>
    <span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FileRead Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFoeAccess</span><span class="o">.</span><span class="n">cbDone</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Foe Access Sent bytes: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>


    <span class="mi">500</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Close</span> <span class="n">the</span> <span class="n">file</span> <span class="ow">and</span> <span class="n">connection</span>
    <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">501</span><span class="p">:</span>
    <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbFileClose</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFileClose</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FileClose Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">502</span><span class="p">:</span>
    <span class="n">fbFoeClose</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">503</span><span class="p">:</span>
    <span class="n">fbFoeClose</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbFoeClose</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbFoeClose</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbFoeClose</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;FoeClose Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">600</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">600</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Return</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">device</span> <span class="n">state</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">reqState</span> <span class="o">:=</span> <span class="n">prevSlaveState</span><span class="o">.</span><span class="n">deviceState</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="mi">601</span><span class="p">:</span>
    <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">arg1</span> <span class="o">:=</span> <span class="n">F_UDINT</span><span class="p">(</span><span class="n">fbReqSlaveState</span><span class="o">.</span><span class="n">nErrId</span><span class="p">);</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="o">.</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;Return to prev state Error: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">;</span>
            <span class="n">stDiag</span><span class="o">.</span><span class="n">fString</span><span class="p">(</span><span class="n">sout</span><span class="o">=&gt;</span><span class="n">stDiag</span><span class="o">.</span><span class="n">asResults</span><span class="p">[</span><span class="n">stDiag</span><span class="o">.</span><span class="n">resultIdx</span><span class="o">.</span><span class="n">IncVal</span><span class="p">()]);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>
    <span class="mi">8000</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Success</span>
    <span class="n">bDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="mi">9000</span><span class="p">:</span>
    <span class="o">//</span><span class="n">Error</span>
    <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">ACT_ExeFb</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span>
<span class="n">ftBusy</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbUploadDriveParams</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>
<span class="n">fbUploadDriveParams</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">ftBusy</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">ACT_LoadDriveParams</span><span class="p">();</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_ExeFb</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_LoadDriveParams</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-homsstepper">ST_HOMSStepper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-elmostomonitor">
<h2>FB_ElmoStoMonitor<a class="headerlink" href="#fb-elmostomonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ElmoStoMonitor</span>
<span class="n">VAR_INPUT</span>
    <span class="n">YGantry</span> <span class="p">:</span> <span class="n">HOMS_Gantry</span><span class="p">;</span>
    <span class="n">XGantry</span> <span class="p">:</span> <span class="n">HOMS_Gantry</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xSTO</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Whether</span> <span class="nb">any</span> <span class="n">controller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">receiving</span> <span class="n">Safe</span> <span class="n">Torque</span> <span class="n">signal</span>
    <span class="n">q_xSIMUL</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Whether</span> <span class="nb">all</span> <span class="n">controllers</span> <span class="n">are</span> <span class="n">seeing</span> <span class="n">the</span> <span class="n">same</span> <span class="n">Safe</span> <span class="n">Torque</span> <span class="n">signal</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">STO_ERROR</span>   <span class="p">:</span> <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">18000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Gantry</span> <span class="n">STO</span> <span class="n">Monitoring</span>
<span class="n">T</span><span class="o">.</span> <span class="n">Rendahl</span> <span class="mi">17</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">16</span>

<span class="n">The</span> <span class="n">STO</span> <span class="n">monitoring</span> <span class="n">block</span> <span class="n">watches</span> <span class="n">two</span> <span class="n">sets</span> <span class="n">of</span> <span class="n">coupled</span> <span class="n">axes</span> <span class="k">for</span> <span class="n">a</span> <span class="n">total</span> <span class="n">of</span> <span class="n">four</span> <span class="n">ELMO</span>
<span class="n">controllers</span><span class="o">.</span> <span class="n">By</span> <span class="n">monitoring</span> <span class="n">each</span> <span class="n">ELMO</span> <span class="n">controller</span> <span class="k">for</span> <span class="n">errors</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">recognize</span> <span class="n">that</span>
<span class="n">the</span> <span class="n">STO</span> <span class="n">circuit</span> <span class="n">has</span> <span class="n">been</span> <span class="n">interrupted</span><span class="o">.</span>

<span class="n">There</span> <span class="n">are</span> <span class="n">two</span> <span class="n">modes</span> <span class="n">of</span> <span class="n">Safe</span> <span class="n">Torque</span> <span class="n">Off</span> <span class="n">off</span> <span class="n">that</span> <span class="n">the</span> <span class="n">function</span> <span class="n">block</span> <span class="n">monitors</span><span class="o">.</span> <span class="n">The</span> <span class="n">first</span> <span class="n">being</span> <span class="k">if</span> <span class="nb">any</span>
<span class="n">drive</span> <span class="n">receives</span> <span class="n">reports</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">receiving</span> <span class="mi">24</span><span class="n">V</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">STO</span> <span class="o">.</span> <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">help</span> <span class="n">determine</span> <span class="n">whether</span>
<span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">purposeful</span> <span class="n">press</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Emergency</span> <span class="n">Stop</span> <span class="n">button</span><span class="p">,</span> <span class="ow">or</span> <span class="k">if</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">failure</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">circuit</span><span class="o">.</span>
<span class="n">We</span> <span class="n">compare</span> <span class="n">the</span> <span class="n">values</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">STO</span> <span class="n">status</span> <span class="n">registers</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">circuit</span> <span class="ow">is</span> <span class="n">cutting</span> <span class="n">power</span>
<span class="n">to</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">ELMO</span> <span class="n">drives</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">gantry</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">YGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">YGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span><span class="p">)</span> <span class="n">OR</span>
   <span class="p">(</span><span class="n">YGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">YGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span><span class="p">)</span> <span class="n">OR</span>
   <span class="p">(</span><span class="n">XGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">XGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span><span class="p">)</span> <span class="n">OR</span>
   <span class="p">(</span><span class="n">XGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">AND</span> <span class="n">XGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">q_xSTO</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">YGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span> <span class="n">AND</span>
          <span class="n">YGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span> <span class="n">AND</span>
       <span class="n">XGantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span> <span class="n">AND</span>
       <span class="n">XGantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ErrorID</span> <span class="o">=</span> <span class="n">STO_ERROR</span> <span class="n">THEN</span>
       <span class="n">q_xSIMUL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">q_xSIMUL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">ELSE</span>

   <span class="n">q_xSTO</span>   <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
   <span class="n">q_xSIMUL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-gantry">HOMS_Gantry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantry">
<h2>FB_Gantry<a class="headerlink" href="#fb-gantry" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_Gantry
VAR_INPUT
    xReset    : BOOL := FALSE; //Rising edge clears errors
END_VAR
VAR_OUTPUT
    q_xError : BOOL;
    q_xDone  : BOOL;
END_VAR
VAR_IN_OUT
    Gantry : HOMS_Gantry;
END_VAR
VAR
    //FB Boilerplate
    //////////////////////
        stDiag      :       ST_fbDiagnostics;

    PAxis_Drive : FB_PTP;
    SAxis_Drive : FB_PTP;
    VAxis_Drive : FB_PTP;
    GC_State        : E_GantryControl; //Gantry control state
    fbGantryDiffVirtualLimitSwitch  :       FB_GantryDiffVirtualLimitSwitch;
    // Edge detection for reset
    rtReset   : R_TRIG;
    // mcPower Enable for couple mode. Applies to both axes
    CoupledModeEnable: BOOL := FALSE;
    // mcPower Enable for decoupled mode. Applies to both axes
    DecoupledModeEnable: BOOL := FALSE;
    mpCouple        :       MC_GearIn;
    mpDecouple      :       MC_GearOut;
    mcPReset        :       MC_Reset;
    mcSReset        :       MC_Reset;
    xGantryAlreadyCoupled: BOOL := FALSE;
    fbGantryMonitor : FB_GantryDifferenceMonitor;
    xFirstPass      :       BOOL := TRUE;
END_VAR
(* Gantry Control
Basic control of a HOMS Gantry

This handles all controls of a HOMS Gantry. All requested moves, stops, and starts are done by requests
to the HOMS_Gantry and lower level structures. There are two main modes of operation coupled and uncoupled,
these are selected by toggling the xUncouple bit. The axis can be manually reset within with xReset input as well

The Gantry does all of the setup for the FB_PTP for each individual drive, the Gantry Difference Monitor,
and projecting the drive limit switches on to the Gantry.VAxis.
*)

//Triggers
///////////////////////////
rtReset(CLK:=xReset);

//Gantry Difference Monitor
///////////////////////////////
(* Produces a &quot;gantry difference fault&quot; *)
fbGantryMonitor(Gantry:=Gantry);

//Verify the direction of motion for each axis will not increase gantry difference
// when uncoupled. These &quot;limit switches&quot; are applied in the Direction enable logic section.
IF Gantry.Mode = GantryModeDecoupled THEN
    fbGantryDiffVirtualLimitSwitch.GantryDiff := Gantry.Diff;
    fbGantryDiffVirtualLimitSwitch.GantryDiffFlt := Gantry.DiffFlt;
    fbGantryDiffVirtualLimitSwitch(PAxis:=Gantry.PAxis, SAxis:=Gantry.SAxis);
END_IF

//Report Gantry Readback
////////////////////////////////
Gantry.xCoupled := (Gantry.PAxis.stAxis.NcToPlc.CoupleState = 1
                     AND Gantry.SAxis.stAxis.NcToPlc.CoupleState = 3);

//Direction enable logic
//////////////////////////////////
    Gantry.VAxis.xHiLS := (Gantry.PAxis.xHiLS AND Gantry.SAxis.xHiLS) OR gBypassVirtualLimits;
    Gantry.VAxis.xLoLS := (Gantry.PAxis.xLoLS AND Gantry.SAxis.xLoLS) OR gBypassVirtualLimits;
    Gantry.PAxis.xHiLS := ( (Gantry.Mode = GantryModeDecoupled) AND Gantry.PAxis.xHiLS AND Gantry.PAxis.DecoupledPositiveEnable )
                        OR ( (Gantry.Mode = GantryModeCoupled) AND Gantry.VAxis.xHiLS);
    Gantry.PAxis.xLoLS := ( (Gantry.Mode = GantryModeDecoupled) AND Gantry.PAxis.xLoLS AND Gantry.PAxis.DecoupledNegativeEnable )
                        OR ( (Gantry.Mode = GantryModeCoupled) AND Gantry.VAxis.xLoLS);
    Gantry.SAxis.xHiLS := ( (Gantry.Mode = GantryModeDecoupled) AND Gantry.SAxis.xHiLS AND Gantry.SAxis.DecoupledPositiveEnable )
                        OR ( (Gantry.Mode = GantryModeCoupled) AND Gantry.VAxis.xHiLS);
    Gantry.SAxis.xLoLS := ( (Gantry.Mode = GantryModeDecoupled) AND Gantry.SAxis.xLoLS AND Gantry.SAxis.DecoupledNegativeEnable )
                        OR ( (Gantry.Mode = GantryModeCoupled) AND Gantry.VAxis.xLoLS);

//Request mode with binary input
// * Is this too sloppy?
///////////////////////////
IF Gantry.xUncouple THEN
    Gantry.ModeReq := GantryModeDeCoupled;
ELSE
    Gantry.ModeReq := GantryModeCoupled;
END_IF

//Axes enable logic
//////////////////////////////////
Gantry.PAxis.xEnable := (NOT Gantry.PAxis.i_xMotorInterlock) AND (Gantry.ModeReq = Gantry.Mode);
Gantry.SAxis.xEnable := (NOT Gantry.SAxis.i_xMotorInterlock) AND (Gantry.ModeReq = Gantry.Mode);

//Gantry Mode Request
////////////////////////////////////
//The gantry mode cannot change while anything is in motion
    IF xFirstPass THEN
        GC_State := GCM_Init;
    ELSIF Gantry.PAxis.stAxis.Status.Moving OR Gantry.PAxis.stAxis.Status.Moving THEN
        Gantry.ModeReq := Gantry.Mode;
        // TODO : May want to add a warning here.
    ELSIF Gantry.PAxis.stAxis.Status.NotMoving AND Gantry.SAxis.stAxis.Status.NotMoving THEN
        //Change mode to requested if different
        IF Gantry.Mode &lt;&gt; Gantry.ModeReq THEN
            Gantry.Mode := Gantry.ModeReq;
            Gantry.PAxis.xEnable := FALSE;
            Gantry.SAxis.xEnable := FALSE;
            Gantry.VAxis.xEnable := FALSE;
            GC_State := GCM_ChangeCoupling;
        END_IF
    END_IF

//Verify the direction of motion for each axis will not increase
//gantry difference when uncoupled.
IF Gantry.Mode = GantryModeDecoupled THEN
    fbGantryDiffVirtualLimitSwitch.GantryDiff := Gantry.Diff;
    fbGantryDiffVirtualLimitSwitch.GantryDiffFlt := Gantry.DiffFlt;
    fbGantryDiffVirtualLimitSwitch(PAxis:=Gantry.PAxis, SAxis:=Gantry.SAxis);
    Gantry.PAxis.xHiLS := Gantry.PAxis.DecoupledPositiveEnable AND Gantry.PAxis.xHiLS;
    Gantry.SAxis.xLoLS := Gantry.SAxis.DecoupledNegativeEnable AND Gantry.SAxis.xLoLS;
END_IF

//Reinit
/////////////////////////
IF rtReset.Q THEN
    GC_State := GCM_Init;
END_IF

/// Coupling StateMachine
/////////////////////////////////
CASE GC_State OF
    GCM_Idle:
        ;
    GCM_Init:
        //Initialize the axes
        //Use this state to clear errors and resume operation
        q_xError := FALSE;
        //Reset drives
        mcPReset.Execute S= gantry.paxis.stAxis.Status.Error;
        mcPReset.Execute R= mcPReset.Busy OR mcPReset.Done OR mcPReset.Error;
        mcSReset.Execute S= gantry.saxis.stAxis.Status.Error;
        //If the secondary axis is already coupled it will be reset by the primary.
        mcSReset.Execute R= mcSReset.Busy OR mcSReset.Done OR mcSReset.Error OR (gantry.saxis.stAxis.NcToPlc.CoupleState = 3);

        IF mcPReset.Error OR mcSReset.Error THEN
            stDiag.fString.sFormat := &#39;Gantry init: Reset err P:%X S:%X&#39;;
            stDiag.fString.arg1 := F_UDINT(mcPReset.ErrorID);
            stDiag.fString.arg2 := F_UDINT(mcSReset.ErrorID);
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            //Head to error
            GC_State := GCM_Error;

        ELSIF NOT( gantry.paxis.stAxis.Status.Error OR gantry.saxis.stAxis.Status.Error) OR //pass
            mcPReset.Done AND (mcSReset.Done OR (gantry.saxis.stAxis.NcToPlc.CoupleState = 3)) THEN
            stDiag.fString.sFormat := &#39;Gantry reset complete, moving to ChangeCoupling&#39;;
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            //Head to change coupling
            GC_State := GCM_ChangeCoupling;

        END_IF

    GCM_ChangeCoupling:

        //Axes are enabled by the VAxis if coupling
        CoupledModeEnable := (Gantry.Mode = GantryModeCoupled);
        //Gantry.VAxis.xEnable := Gantry.VAxis.i_xMotorInterlock;

        //Axis can be enabled independently in decoupled mode
        DecoupledModeEnable := (Gantry.Mode = GantryModeDecoupled);
        CASE Gantry.Mode OF
            GantryModeCoupled:
                stDiag.fString.sFormat := &#39;Initiating couple&#39;;
                stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
                GC_State := GCM_Couple;
            GantryModeDecoupled:
                stDiag.fString.sFormat := &#39;Initiating decouple&#39;;
                stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
                GC_State := GCM_Decouple;
        END_CASE

    GCM_Couple:
        //&lt;HACK&gt; I don&#39;t really like just checking if the axes are in a coupled state. I&#39;d like a way to verify what other axis they are coupled to...
        xGantryAlreadyCoupled := gantry.paxis.stAxis.NcToPlc.CoupleState=1 AND gantry.saxis.stAxis.NcToPlc.CoupleState = 3;
        mpCouple.Execute := TRUE;
        mpCouple.Execute R= mpCouple.Busy OR mpCouple.InGear OR mpCouple.Error OR mpCouple.CommandAborted OR xGantryAlreadyCoupled;
        IF mpCouple.InGear OR xGantryAlreadyCoupled THEN
            stDiag.fString.sFormat := &#39;Gantry already coupled, going to idle&#39;;
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            GC_State := GCM_Idle;
        ELSIF mpCouple.Error THEN
            stDiag.fString.sFormat := &#39;Couple encountered an error: %x&#39;;
            stDiag.fString.arg1 := F_UDINT(mpCouple.ErrorID);
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            GC_State := GCM_Error;
        ELSIF mpCouple.CommandAborted THEN
            stDiag.fString.sFormat := &#39;Couple aborted: error: %x&#39;;
            stDiag.fString.arg1 := F_UDINT(mpCouple.ErrorID);
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            GC_State := GCM_Error;
        END_IF

    GCM_Decouple:
        //Initiate a decoupling
        mpDecouple.Execute := TRUE;
        mpDecouple.Execute R= mpDecouple.Busy OR mpDecouple.Done OR mpDecouple.Error;

        IF mpDecouple.Done THEN
            GC_State := GCM_Idle;
        ELSIF mpDecouple.Error THEN
            stDiag.fString.sFormat := &#39;Decouple aborted: error: %x&#39;;
            stDiag.fString.arg1 := F_UDINT(mpDecouple.ErrorID);
            stDiag.fString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            GC_State := GCM_Error;
        END_IF

    GCM_Error:
        q_xError := TRUE;
        GC_State := GCM_Idle;

END_CASE

//Coupling Functoins
////////////////////////////////
mpCouple(Master :=Gantry.PAxis.stAxis,
          Slave :=Gantry.SAxis.stAxis,
          RatioNumerator := 1,
          RatioDenominator := 1,
          Acceleration := 0,
          Deceleration := 0,
          Jerk := 0);

//De-coupling Functions
/////////////////////////////////
mpDecouple(Slave := Gantry.SAxis.stAxis);

mcPReset(Axis:=Gantry.PAxis.stAxis);
mcSReset(Axis:=Gantry.SAxis.stAxis);

//Drive functions
///////////////////////////////////
PAxis_Drive(Stepper:=Gantry.PAxis);
SAxis_Drive(Stepper:=Gantry.SAxis);

//First Pass
xFirstPass := FALSE;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-gantrycontrol">E_GantryControl</a></p></li>
<li><p><a class="reference internal" href="#fb-gantrydiffvirtuallimitswitch">FB_GantryDiffVirtualLimitSwitch</a></p></li>
<li><p><a class="reference internal" href="#fb-gantrydifferencemonitor">FB_GantryDifferenceMonitor</a></p></li>
<li><p><a class="reference internal" href="#fb-ptp">FB_PTP</a></p></li>
<li><p><a class="reference internal" href="#homs-gantry">HOMS_Gantry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantrydifferencemonitor">
<h2>FB_GantryDifferenceMonitor<a class="headerlink" href="#fb-gantrydifferencemonitor" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryDifferenceMonitor</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Gantry</span>  <span class="p">:</span>       <span class="n">HOMS_Gantry</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Gantry</span> <span class="n">Difference</span> <span class="n">Monitor</span>
<span class="n">E</span><span class="o">.</span> <span class="n">Rodriguez</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">17</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">15</span>

<span class="n">The</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">monitor</span> <span class="n">runs</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">fast</span> <span class="n">task</span> <span class="ow">and</span> <span class="n">monitors</span>
<span class="n">the</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">between</span> <span class="n">two</span> <span class="n">gantried</span> <span class="n">axes</span><span class="o">.</span> <span class="n">If</span> <span class="n">this</span> <span class="n">difference</span>
<span class="n">exceeds</span> <span class="n">the</span> <span class="n">permitted</span> <span class="n">amount</span><span class="p">,</span> <span class="n">a</span> <span class="n">gauntry</span> <span class="n">fault</span> <span class="n">boolean</span> <span class="ow">is</span> <span class="nb">set</span><span class="o">.</span>

<span class="n">Axilon</span> <span class="n">provided</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="k">for</span> <span class="n">the</span> <span class="s2">&quot;center&quot;</span> <span class="n">of</span> <span class="n">each</span> <span class="n">axis</span><span class="o">.</span> <span class="n">We</span>
<span class="n">consider</span> <span class="n">this</span> <span class="n">center</span> <span class="n">to</span> <span class="n">be</span> <span class="n">the</span> <span class="n">zero</span><span class="o">-</span><span class="n">gantry</span><span class="o">-</span><span class="n">difference</span> <span class="n">position</span><span class="o">.</span>

<span class="n">This</span> <span class="n">boolean</span> <span class="ow">is</span> <span class="n">monitored</span> <span class="n">by</span> <span class="n">other</span> <span class="n">function</span> <span class="n">blocks</span> <span class="n">that</span> <span class="n">use</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">structure</span><span class="p">,</span> <span class="n">including</span>
<span class="n">but</span> <span class="ow">not</span> <span class="n">limited</span> <span class="n">to</span><span class="p">:</span>
<span class="n">Gantry</span> <span class="n">control</span> <span class="n">function</span> <span class="n">block</span>
<span class="n">System</span> <span class="n">error</span> <span class="n">summary</span>
<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="mi">1</span> <span class="n">encoder</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">nm</span>
<span class="o">//</span><span class="n">AxilonGantryDiff</span> <span class="o">:=</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">cCenter</span> <span class="o">-</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">cCenter</span><span class="p">;</span>

<span class="o">//</span><span class="n">HOMSGantryDiff</span> <span class="o">:=</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">diEncCnt</span> <span class="o">-</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">diEncCnt</span><span class="p">;</span>

<span class="n">Gantry</span><span class="o">.</span><span class="n">Diff</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">Gantry</span><span class="o">.</span><span class="n">PAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">-</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">SAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">);</span>

<span class="n">Gantry</span><span class="o">.</span><span class="n">DiffFlt</span> <span class="n">S</span><span class="o">=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">Gantry</span><span class="o">.</span><span class="n">Diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">DiffTol</span><span class="p">;</span>
<span class="n">Gantry</span><span class="o">.</span><span class="n">DiffFlt</span> <span class="n">R</span><span class="o">=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">Gantry</span><span class="o">.</span><span class="n">Diff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">DiffTol</span> <span class="o">-</span> <span class="n">Gantry</span><span class="o">.</span><span class="n">DiffHys</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-gantry">HOMS_Gantry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-gantrydiffvirtuallimitswitch">
<h2>FB_GantryDiffVirtualLimitSwitch<a class="headerlink" href="#fb-gantrydiffvirtuallimitswitch" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GantryDiffVirtualLimitSwitch</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">PAxis</span>   <span class="p">:</span>       <span class="n">HOMS_GantryAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Upstream</span> <span class="n">axis</span>
    <span class="n">SAxis</span>   <span class="p">:</span>       <span class="n">HOMS_GantryAxis</span><span class="p">;</span> <span class="o">//</span><span class="n">Downstream</span> <span class="n">axis</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">GantryDiff</span>      <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span>
    <span class="n">GantryDiffFlt</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Gantry</span> <span class="n">difference</span> <span class="ow">is</span> <span class="n">above</span> <span class="n">limit</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Gantry</span> <span class="n">Difference</span> <span class="n">Virtual</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">17</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">15</span>

<span class="n">Determines</span> <span class="n">which</span> <span class="n">direction</span> <span class="ow">is</span> <span class="n">disabled</span> <span class="n">due</span> <span class="n">to</span> <span class="n">it</span> <span class="n">increasing</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">difference</span><span class="o">.</span>
<span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ESD</span> <span class="k">for</span> <span class="n">actual</span> <span class="n">conventions</span><span class="o">.</span>

<span class="n">A</span> <span class="n">positive</span> <span class="n">gantry</span> <span class="n">error</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">a</span> <span class="n">CCW</span> <span class="n">clocked</span> <span class="n">assembly</span><span class="p">:</span>
<span class="n">eg</span><span class="o">.</span> <span class="k">for</span> <span class="n">X</span>
<span class="n">X1</span> <span class="n">upstream</span><span class="p">,</span> <span class="n">X2</span> <span class="n">downstream</span><span class="o">.</span> <span class="n">Primary</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">upstream</span><span class="o">.</span>
<span class="n">Gantry</span> <span class="n">difference</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">when</span>
<span class="n">X2</span><span class="o">&gt;</span><span class="n">X1</span>
<span class="n">Therefore</span>
<span class="n">X2</span> <span class="n">positive</span> <span class="n">direction</span> <span class="n">disabled</span>
<span class="n">X1</span> <span class="n">negative</span> <span class="n">direction</span> <span class="n">disabled</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">GantryDiffFlt</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="n">THEN</span>
        <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">GantryDiff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="o">//</span><span class="n">If</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">fault</span><span class="p">,</span> <span class="nb">all</span> <span class="n">directions</span> <span class="n">are</span> <span class="n">enabled</span><span class="p">,</span>
    <span class="o">//</span> <span class="n">remember</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">some</span> <span class="n">hystersis</span> <span class="n">built</span> <span class="n">into</span> <span class="n">the</span>
    <span class="o">//</span> <span class="n">gantry</span> <span class="n">difference</span> <span class="n">function</span> <span class="p">(</span><span class="n">should</span> <span class="n">be</span><span class="p">)</span>
    <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">PAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledPositiveEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">SAxis</span><span class="o">.</span><span class="n">DecoupledNegativeEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-gantryaxis">HOMS_GantryAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-initdriverefs">
<h2>FB_InitDriveRefs<a class="headerlink" href="#fb-initdriverefs" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_InitDriveRefs</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stCoE</span>   <span class="p">:</span>       <span class="n">ST_ElmoGDCBellCoEParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">sNetId</span> <span class="o">:=</span> <span class="n">F_CreateAmsNetId</span><span class="p">(</span><span class="n">gAmsNetIDEcatMaster1</span><span class="p">);</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">nDriveNo</span> <span class="o">:=</span> <span class="n">stCoE</span><span class="o">.</span><span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nDriveNo</span><span class="p">;</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">nDriveType</span> <span class="o">:=</span> <span class="n">stCoE</span><span class="o">.</span><span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nDriveType</span><span class="p">;</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">nSlaveAddr</span> <span class="o">:=</span> <span class="n">stCoE</span><span class="o">.</span><span class="n">stPlcDriveRef</span><span class="o">.</span><span class="n">nSlaveAddr</span><span class="p">;</span>

<span class="n">stCoE</span><span class="o">.</span><span class="n">AmsID</span> <span class="o">:=</span> <span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">sNetId</span><span class="p">;</span>
<span class="n">stCoE</span><span class="o">.</span><span class="n">nSlave</span> <span class="o">:=</span> <span class="n">stCoE</span><span class="o">.</span><span class="n">stDriveRef</span><span class="o">.</span><span class="n">nSlaveAddr</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-elmogdcbellcoeparams">ST_ElmoGDCBellCoEParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-limitswitchstate">
<h2>FB_LimitSwitchState<a class="headerlink" href="#fb-limitswitchstate" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LimitSwitchState</span>
<span class="n">VAR_INPUT</span>
    <span class="n">diInputs</span>        <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xHiLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xLoLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">STO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">di_1</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">di_2</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">FLS</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">TRUE</span> <span class="ow">is</span> <span class="n">active</span> <span class="p">(</span><span class="n">ie</span><span class="o">.</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">hit</span><span class="p">,</span> <span class="n">drive</span> <span class="ow">is</span> <span class="n">configured</span> <span class="n">normally</span><span class="o">-</span><span class="n">closed</span><span class="p">)</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">bad</span><span class="o">.</span>
    <span class="n">RLS</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">cHighVal</span>        <span class="p">:</span>       <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#00010002;</span>
    <span class="n">cLowVal</span>         <span class="p">:</span>       <span class="n">UDINT</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#00020001;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">ElmoMC</span> <span class="n">Limit</span> <span class="n">State</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">25</span>

<span class="n">Sets</span> <span class="n">the</span> <span class="n">high</span> <span class="ow">and</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">bools</span> <span class="n">based</span> <span class="n">on</span> <span class="nb">input</span> <span class="n">status</span> <span class="n">dint</span> <span class="kn">from</span> <span class="nn">ElmoMC</span> <span class="n">Drives</span> <span class="o">*</span><span class="p">)</span>


<span class="n">RLS</span>         <span class="o">:=</span> <span class="n">diInputs</span><span class="mf">.0</span><span class="p">;</span>
<span class="n">FLS</span>         <span class="o">:=</span> <span class="n">diInputs</span><span class="mf">.1</span><span class="p">;</span>

<span class="n">STO</span>         <span class="o">:=</span> <span class="n">diInputs</span><span class="mf">.3</span><span class="p">;</span>

<span class="n">di_1</span>        <span class="o">:=</span> <span class="n">diInputs</span><span class="mf">.16</span><span class="p">;</span>
<span class="n">di_2</span>        <span class="o">:=</span> <span class="n">diInputs</span><span class="mf">.17</span><span class="p">;</span>

<span class="o">//</span>

<span class="n">xHiLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">FLS</span> <span class="n">AND</span> <span class="n">STO</span><span class="p">;</span>
<span class="n">xLoLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">RLS</span> <span class="n">AND</span> <span class="n">STO</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-mirrorcoatingprotection">
<h2>FB_MirrorCoatingProtection<a class="headerlink" href="#fb-mirrorcoatingprotection" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MirrorCoatingProtection</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bMirrorIn</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Mirror</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">In</span> <span class="n">position</span>
    <span class="n">rCurrentEncoderPosition</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">encoder</span> <span class="n">position</span>
    <span class="n">neVRange</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">ev</span> <span class="nb">range</span> <span class="kn">from</span> <span class="nn">stCurrentBeamParams</span>
    <span class="n">sDevName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Device</span> <span class="n">name</span>
    <span class="n">rFirstCoatingPosition</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span><span class="o">/</span><span class="n">position</span> <span class="k">for</span> <span class="n">the</span> <span class="n">coating</span>
    <span class="n">rFirstCoatingPositionTolerance</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">position</span> <span class="o">+/-</span> <span class="n">tolerance</span>
    <span class="n">nFirstCoatingBitmask</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Bitmask</span> <span class="k">for</span> <span class="n">upper</span> <span class="n">coating</span>
    <span class="n">sFirstCoatingType</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Type</span> <span class="n">of</span> <span class="n">coating</span>
    <span class="n">rSecondCoatingPosition</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span><span class="o">/</span><span class="n">position</span> <span class="k">for</span> <span class="n">the</span> <span class="n">coating</span>
    <span class="n">rSecondCoatingPositionTolerance</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">position</span> <span class="o">+/-</span> <span class="n">tolerance</span>
    <span class="n">nSecondCoatingBitmask</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Bitmask</span> <span class="k">for</span> <span class="n">upper</span> <span class="n">coating</span>
    <span class="n">sSecondCoatingType</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Type</span> <span class="n">of</span> <span class="n">coating</span>
    <span class="n">bAutoClear</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">ffFirstCoating</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">ffSecondCoating</span><span class="p">:</span> <span class="n">FB_FastFault</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span>  <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_Desc</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sFirstCoatingType</span><span class="p">,</span> <span class="s1">&#39; mirror coating incompatible with beam photon energy&#39;</span><span class="p">);</span>
    <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">;</span>

    <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_Desc</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSecondCoatingType</span><span class="p">,</span> <span class="s1">&#39; mirror coating incompatible with beam photon energy&#39;</span><span class="p">);</span>
    <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">bMirrorIn</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">rCurrentEncoderPosition</span> <span class="o">&gt;=</span> <span class="n">rFirstCoatingPosition</span> <span class="o">-</span> <span class="n">rFirstCoatingPositionTolerance</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rCurrentEncoderPosition</span> <span class="o">&lt;=</span> <span class="n">rFirstCoatingPosition</span> <span class="o">+</span> <span class="n">rFirstCoatingPositionTolerance</span><span class="p">)</span>  <span class="n">THEN</span>
        <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">nFirstCoatingBitmask</span><span class="p">)</span> <span class="o">=</span> <span class="n">neVRange</span><span class="p">;</span>
        <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="p">(</span><span class="n">rCurrentEncoderPosition</span> <span class="o">&gt;=</span> <span class="n">rSecondCoatingPosition</span> <span class="o">-</span> <span class="n">rSecondCoatingPositionTolerance</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">rCurrentEncoderPosition</span> <span class="o">&lt;=</span> <span class="n">rSecondCoatingPosition</span> <span class="o">+</span> <span class="n">rSecondCoatingPositionTolerance</span><span class="p">)</span>  <span class="n">THEN</span>
        <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">nSecondCoatingBitmask</span><span class="p">)</span> <span class="o">=</span> <span class="n">neVRange</span><span class="p">;</span>
        <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">ffFirstCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">ffSecondCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">ffFirstCoating</span><span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoClear</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#601,</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">ffSecondCoating</span><span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoClear</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#601,</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-pi-e621-serialdriverold">
<h2>FB_PI_E621_SerialDriverOld<a class="headerlink" href="#fb-pi-e621-serialdriverold" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PI_E621_SerialDriverOld
VAR_INPUT
    /// rising edge execute
    i_xExecute: BOOL;
    /// Maximum wait time for reply
    i_tTimeOut: TIME := TIME#1S0MS;
//  i_xReset : BOOL := FALSE; //reset function, for timeout etc
END_VAR
VAR_OUTPUT
    q_xDone: BOOL;
    q_xError: BOOL;
    q_sResult: STRING(255);
    /// Last Strings Sent to Serial Device - for debugging
    q_asLastSentStrings: ARRAY[1..50] OF STRING;
    /// Last Strings Received from Serial Device - for debugging
    q_asLastReceivedStrings: ARRAY[1..50] OF STRING;
END_VAR
VAR_IN_OUT
    iq_stPiezoAxis  :       ST_PiezoAxisOld;
    iq_stSerialRXBuffer: ComBuffer;
    iq_stSerialTXBuffer: ComBuffer;
END_VAR
VAR
    rtExecute               : R_TRIG;
    rtTransDone             : R_TRIG;
    iStep: INT;
    sSendData: STRING;
    fbPITransaction: FB_PI_E621_SerialTransaction;
    fbFormatString: FB_FormatString;
    sErrMesg : STRING := &#39;In step %d fbPITransaction failed with message: %s&#39;;
    i               : INT := 1;
END_VAR
(* S. Stubbs, 2-23-2017 *)
(* This function block drives serial communication with a PI E-816 or compatible comm module.
   Note this needs to be re-jiggered if the E-517 is used, uses number rather than letter for axis *)

(* RS232 default settings: 115200 8N1, RTS/CTS

All commands follow format:
CMD X sV.V(Line feed)
Where CMD is the command, X is axis, and sV.V is sign and number (float or int).
Not all commands use axis and parameter, for example ERR?
*)

(* rising edge trigger *)
rtExecute(CLK:= i_xExecute);
IF rtExecute.Q THEN
    q_xDone := FALSE;
    q_xError := FALSE;
    q_sResult:= &#39;&#39;;
    iq_stPiezoAxis.xDriverError := FALSE;
//  i_xReset := FALSE;
    a_ClearTrans();  (* to provide rising edge for execute *)
    IF iq_stPiezoAxis.sIdn= &#39;&#39; THEN (* Should only need to check identity once *)
        iStep := 5;
    ELSE
        iStep := 10;
    END_IF
END_IF


CASE iStep OF
    0: (* idle *)
        ;

    (* Commands *)
    5: (* Get Identity *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;*IDN?&#39;;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.sIdn := fbPITransaction.q_sResponseData; //Hello I am a piezo
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    10: (* Check Servo Mode
        To use manual voltage servo mode must be off *)
        (* Response: 0$L or 1$L *)
        fbPITransaction.i_xExecute:= TRUE;
        fbPITransaction.i_sCmd:= &#39;SVO?&#39;;
        fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
            IF FIND(&#39;1&#39;,fbPITransaction.q_sResponseData) &lt;&gt; 0 THEN //Iff in servo mode, turn it off
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := iStep + 10;
            ELSE
                a_ClearTrans();
                iStep := iStep + 20;  //Skip setting servo mode
            END_IF
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    20: (* Set Servo Mode *)
        fbPITransaction.i_xExecute:= TRUE;
        fbPITransaction.i_sCmd:= &#39;SVO&#39;;
        fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        fbPITransaction.i_sParam:= &#39;0&#39;;
        fbPITransaction.i_xExpectReply:= FALSE;
        IF fbPITransaction.q_xDone THEN
            a_ClearTrans();  (* to provide rising edge for execute *)
            iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    30: (* Set Voltage, only if needed *)
        IF iq_stPiezoAxis.rSetVoltage &lt;&gt; iq_stPiezoAxis.rLastReqVoltage THEN
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;SVA&#39;;
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
            fbPITransaction.i_sParam:=REAL_TO_STRING(iq_stPiezoAxis.rSetVoltage);
            fbPITransaction.i_xExpectReply:= FALSE;
            IF fbPITransaction.q_xDone THEN
                    a_ClearTrans();  (* to provide rising edge for execute *)
                    iStep := iStep + 10;
            ELSIF fbPITransaction.q_xError THEN
                a_ErrorMesg();
                iStep := 9000;
            END_IF
        ELSE
            iStep := iStep + 30; //Should only need to check error and setpoint if setting voltage
        END_IF

    40: (* Get Error Code, also resets current error *)
    (* Response: integer error code *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;ERR?&#39;;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.iCurError := STRING_TO_INT(fbPITransaction.q_sResponseData);
                IF iq_stPiezoAxis.iCurError &lt;&gt; 0 THEN
                    iq_stPiezoAxis.iLastError:= iq_stPiezoAxis.iCurError;
                END_IF
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    50: (* Get Last Requested Piezo Voltage *)
    (* Response: (float)$L *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;SVA?&#39;;
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
            iq_stPiezoAxis.rLastReqVoltage := STRING_TO_REAL(fbPITransaction.q_sResponseData);
            //Check and reset attempts if it went through
            a_ClearTrans();  (* to provide rising edge for execute *)
            iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    60: (* Get Actual Piezo Voltage *)
    (* Response: (float)$L *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;VOL?&#39;;
            // E-517 works differently, uses number rather than letter for axis
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.rActVoltage := STRING_TO_REAL(fbPITransaction.q_sResponseData);
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := 8000; (* Done *)
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    8000: (* done *)
        q_xDone := TRUE;
        IF  i_xExecute = FALSE THEN
            q_xDone:= FALSE;
            iStep := 0;
        END_IF

    9000: (* Error *)
        a_ClearTrans();  (* to provide rising edge for execute *)
        IF fbPITransaction.q_xTimeout THEN
            iStep:=10;//start over
        ELSE
        q_xError := TRUE;
        iq_stPiezoAxis.xDriverError := TRUE;
        END_IF

END_CASE

//call transaction
fbPITransaction(
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer);

iq_stPiezoAxis.xTimeout:=fbPITransaction.q_xTimeout;
(* Rising edge trigger to take care of debugging history *)
rtTransDone(CLK:= fbPITransaction.q_xDone);
IF rtTransDone.Q THEN
q_asLastSentStrings[i] := fbPITransaction.q_sLastSentString;
q_asLastReceivedStrings[i] := fbPITransaction.q_sLastReceivedString;
i := i + 1;
END_IF
IF i = 51 THEN i := 1; END_IF

END_FUNCTION_BLOCK

ACTION a_ClearTrans:
(* Refactor this action to match your transaction *)
fbPITransaction.i_xExecute := TRUE;
fbPITransaction.i_sCmd:= &#39;&#39;; //Input args are Cmd, Axis and Param
fbPITransaction.i_sAxis:= &#39;&#39;;
fbPITransaction.i_sParam:= &#39;&#39;;
fbPITransaction(
    i_tTimeOut:= i_tTimeOut,
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer );
fbPITransaction.i_xExecute := FALSE;
fbPITransaction(
    i_tTimeOut:= i_tTimeOut,
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer );
fbPITransaction.i_xExpectReply:=TRUE;
END_ACTION

ACTION a_ErrorMesg:
fbFormatString( sformat:=sErrMesg,
    arg1:=F_INT(iStep),
    arg2:=F_STRING(fbPITransaction.q_sResult),
    sOut =&gt; q_sResult);
END_ACTION

ACTION a_UnknownError:
q_sResult:= &#39;Unknown error&#39;;

fbFormatString( sformat:=sErrMesg,
    arg1:=F_INT(iStep),
    arg2:=F_STRING(q_sResult), //Little silly, but have to do this because F_STRING requires read/write access
    sOut =&gt; q_sResult);
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-pi-e621-serialtransaction">FB_PI_E621_SerialTransaction</a></p></li>
<li><p><a class="reference internal" href="#st-piezoaxisold">ST_PiezoAxisOld</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pi-e621-serialtransaction">
<h2>FB_PI_E621_SerialTransaction<a class="headerlink" href="#fb-pi-e621-serialtransaction" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PI_E621_SerialTransaction
VAR_INPUT
    /// rising edge execute
    i_xExecute: BOOL;
    /// Maximum wait time for reply
    i_tTimeOut: TIME := TIME#1s0ms;
    // Command field
    i_sCmd: STRING;
    // Axis field
    i_sAxis: STRING;
    // Parameter field
    i_sParam: STRING;
    // Does command have a reply?  Default behavior is the same as the other drivers.
    i_xExpectReply: BOOL := TRUE;
END_VAR
VAR_OUTPUT
    q_xDone: BOOL;
    q_sResponseData: STRING;
    q_xError: BOOL;
    q_xTimeout: BOOL;
    q_sResult: STRING;
    /// Last String Sent to Serial Device - for debugging
    q_sLastSentString: STRING;
    /// Last String Received from Serial Device - for debugging
    q_sLastReceivedString: STRING;
END_VAR
VAR_IN_OUT
    iq_stSerialRXBuffer: ComBuffer;
    iq_stSerialTXBuffer: ComBuffer;
END_VAR
VAR
    rtExecute: R_TRIG;
    iStep: INT;
    fbClearComBuffer: ClearComBuffer;
    sSendString: STRING;
    fbFormatString: FB_FormatString;
    iChecksum: INT;
    fbSendString: SendString;
    fbReceiveString: ReceiveString;
    sReceivedString: STRING;
    tonTimeout: TON;
    sRXStringForChecksum: STRING;
    sReceiveStringWOChecksum: STRING;
    sRXCheckSum: STRING;
    sRXAddress: STRING;
    sRXParmNum: STRING;
END_VAR
(* This function block performs serial transactions with a PI E-816 or compatible comm module *)

(* rising edge trigger *)
rtExecute(CLK:= i_xExecute);
IF rtExecute.Q THEN
    q_xDone := FALSE;
    q_sResponseData := &#39;&#39;;
    q_xError := FALSE;
    q_sResult:= &#39;&#39;;
    q_sLastSentString := &#39;&#39;;
    q_sLastReceivedString:= &#39;&#39;;
    iStep := 10;
END_IF

CASE iStep OF
    0:
        ; (* idle *)

    10: (* clear com buffers *)
        fbClearComBuffer(Buffer:= iq_stSerialRXBuffer);
        fbClearComBuffer(Buffer:= iq_stSerialTXBuffer);
        (* build the send string *)
        IF i_sParam = &#39;&#39; AND i_sAxis &lt;&gt; &#39;&#39; THEN //Axis but no parameter
            fbFormatString( sFormat:= &#39;%s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sAxis),
                sOut=&gt; sSendString);
        ELSIF i_sParam &lt;&gt; &#39;&#39; AND i_sAxis = &#39;&#39; THEN //Parameter but no axis, global command
            fbFormatString( sFormat:= &#39;%s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sParam), //May not work for all commands, good enough for now
                sOut=&gt; sSendString);
        ELSIF i_sParam = &#39;&#39; AND i_sAxis = &#39;&#39; THEN //Global Query/Command
            fbFormatString( sFormat:= &#39;%s$L&#39;,
            arg1:= F_STRING(i_sCmd),
            sOut=&gt; sSendString);
        ELSE
            fbFormatString( sFormat:= &#39;%s %s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sAxis),
                arg3:= F_STRING(i_sParam), //May not work for all commands, good enough for now
                sOut=&gt; sSendString);
        END_IF
        (* send it *)
        fbSendString( SendString:= sSendString, TXbuffer:= iq_stSerialTXBuffer );
        q_sLastSentString := sSendString;
        iStep := iStep + 10;

    20: (* Finish sending the String *)
        IF fbSendString.Busy THEN
            fbSendString( SendString:= sSendString, TXbuffer:= iq_stSerialTXBuffer );
        ELSIF fbSendString.Error &lt;&gt; 0 THEN
            q_sResult := CONCAT(&#39;In step 20 fbSendString resulted in error: &#39;, INT_TO_STRING(fbSendString.Error));
            iStep := 9000;
        ELSIF NOT fbSendString.Busy THEN
            IF i_xExpectReply THEN
            iStep := iStep + 10;
            ELSE //No reply expected, transaction complete
            q_xDone:= TRUE;
            q_sResult := &#39;Success.&#39;;
            q_xTimeout := FALSE; //no timeout
            iStep := 100;
            END_IF
        END_IF
        (* Reset receive *)
        fbReceiveString(
            Reset:= TRUE,
            ReceivedString:= sReceivedString,
            RXbuffer:= iq_stSerialRXBuffer );
        tonTimeout(IN:= FALSE);

    30: (* Get reply, if there is one *)
        fbReceiveString(
            Prefix:= ,
            Suffix:= &#39;$L&#39;,
            Timeout:= i_tTimeOut,
            Reset:= FALSE,
            ReceivedString:= sReceivedString,
            RXbuffer:= iq_stSerialRXBuffer );
        tonTimeout(IN:= TRUE, PT:= i_tTimeOut);
        IF fbReceiveString.Error &lt;&gt; 0 AND fbReceiveString.Error &lt;&gt; 16#1008 THEN //16#1008 is timeout error
            q_sResult := CONCAT(&#39;In step 30 fbReceiveString resulted in error: &#39;, INT_TO_STRING(fbReceiveString.Error));
            iStep := 9000;
        ELSIF fbReceiveString.RxTimeout OR tonTimeout.Q THEN
            q_sResult := &#39;Device failed to reply within timeout period&#39;;
            q_xTimeout := TRUE;
            iStep := 9000;
        ELSIF fbReceiveString.StringReceived THEN
            q_xTimeout := FALSE; //no timeout
            q_sLastReceivedString := sReceivedString;
            q_sResponseData := sReceivedString;
            q_sResult := &#39;Success.&#39;;
            q_xDone:= TRUE;
            iStep := 100;
        END_IF

    100: (* done *)
        IF  i_xExecute = FALSE THEN
            q_xDone:= FALSE;
            iStep := 0;
        END_IF

    9000:
        q_xError := TRUE;

END_CASE

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-piezocontrol">
<h2>FB_PiezoControl<a class="headerlink" href="#fb-piezocontrol" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PiezoControl</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_Piezo</span>        <span class="p">:</span>       <span class="n">ST_PiezoAxisOld</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">xExecute</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">edge</span> <span class="n">being</span> <span class="n">piezo</span> <span class="n">motion</span>
    <span class="n">xReset</span>      <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Positive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reverse</span> <span class="n">of</span> <span class="n">Positive</span> <span class="n">Limit</span> <span class="n">Switch</span>
    <span class="n">Enable_Negative</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reverse</span> <span class="n">of</span> <span class="n">Negative</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xBusy</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Busy</span> <span class="n">remains</span> <span class="n">true</span> <span class="k">while</span> <span class="n">piezo</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">adjusted</span>
    <span class="n">xDone</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reached</span> <span class="n">target</span> <span class="n">position</span>
    <span class="n">xError</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">General</span> <span class="n">error</span>
    <span class="n">xLimited</span><span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Piezo</span> <span class="n">move</span> <span class="n">was</span> <span class="n">limited</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">E_State</span>     <span class="p">:</span> <span class="n">E_PiezoControl</span><span class="p">;</span> <span class="o">//</span><span class="n">ENUM</span> <span class="k">for</span> <span class="n">Piezo</span> <span class="n">Control</span> <span class="n">State</span>
    <span class="n">rtStartMove</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Trigger</span> <span class="k">for</span> <span class="n">Execution</span>
    <span class="n">rtReset</span>     <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Trigger</span> <span class="k">for</span> <span class="n">Error</span> <span class="n">reset</span>
    <span class="n">rSetpoint</span>   <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Internal</span> <span class="n">Storage</span> <span class="n">of</span> <span class="n">Setpoint</span>
    <span class="n">rReqVoltage</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">requested</span> <span class="n">voltage</span>
    <span class="n">rLLSV</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rHLSV</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">120</span><span class="p">;</span>
    <span class="n">fbPI</span><span class="p">:</span> <span class="n">FB_CTRL_PI</span><span class="p">;</span>
    <span class="n">fbRamp</span><span class="p">:</span> <span class="n">FB_CTRL_RAMP_GENERATOR_EXT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FB</span> <span class="n">initialized</span> <span class="n">flag</span>
    <span class="n">bInitialized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Get</span> <span class="n">cycle</span> <span class="n">time</span> <span class="k">for</span> <span class="n">control</span> <span class="n">FBs</span>
    <span class="n">fbGetCycleTime</span>  <span class="p">:</span>       <span class="n">FB_CTRL_GET_TASK_CYCLETIME</span><span class="p">;</span>
    <span class="n">tTaskCycleTime</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="n">bCycleTimeValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtVoltMode</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fOut</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPiezoBias</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">fScale</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span>
    <span class="n">tonPiezoDone</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S);</span>
    <span class="n">tonPiezoLimited</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#500MS);</span>
    <span class="n">xVoltageLimited</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ftEnPos</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">ftEnNeg</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtEnPos</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtEnNeg</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fOutLimitHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">fOutHiLimHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">fOutLoLimHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">FB</span> <span class="n">Piezo</span> <span class="n">Control</span>

<span class="o">//</span><span class="n">TODO</span>
<span class="o">*</span><span class="p">)</span>


<span class="o">//</span><span class="n">Triggers</span>
<span class="o">///////////////////////////////</span>
    <span class="n">rtStartMove</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">xExecute</span><span class="p">);</span>
    <span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xEnable</span><span class="p">);</span>
    <span class="n">rtVoltMode</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xVoltageMode</span><span class="p">);</span>

<span class="o">//</span><span class="n">Status</span> <span class="n">bits</span>
<span class="o">///////////////////////////</span>
<span class="n">xBusy</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">xDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span><span class="n">Keep</span> <span class="n">requested</span> <span class="n">voltage</span> <span class="n">to</span> <span class="n">within</span> <span class="n">limits</span>
<span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">LowerVoltage</span><span class="p">,</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">UpperVoltage</span><span class="p">);</span>

<span class="o">//</span><span class="n">Limits</span>
<span class="p">(</span><span class="o">*</span> <span class="n">These</span> <span class="n">appear</span> <span class="n">flipped</span><span class="p">,</span> <span class="n">but</span> <span class="ow">in</span><span class="o">-</span><span class="n">fact</span> <span class="n">are</span> <span class="ow">not</span> <span class="o">*</span><span class="p">)</span>
<span class="n">ftEnPos</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Positive</span><span class="p">);</span>
<span class="n">ftEnNeg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">);</span>
<span class="n">rtEnPos</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Positive</span><span class="p">);</span>
<span class="n">rtEnNeg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Want</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">on</span> <span class="n">first</span> <span class="k">pass</span> <span class="k">if</span> <span class="n">a</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">hit</span><span class="o">.</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">we</span> <span class="n">move</span> <span class="n">off</span> <span class="n">the</span> <span class="n">limit</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll restore the init value (usually 1). This will be reset</span>
    <span class="n">to</span> <span class="n">something</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">1</span> <span class="n">when</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">gets</span> <span class="n">tripped</span> <span class="n">again</span><span class="p">,</span> <span class="n">because</span> <span class="n">presumably</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">limit</span>
    <span class="n">would</span> <span class="n">have</span> <span class="n">been</span> <span class="nb">set</span> <span class="n">at</span> <span class="n">a</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">the</span> <span class="n">system</span> <span class="n">had</span> <span class="n">been</span> <span class="n">runing</span><span class="o">.</span>
    <span class="n">We</span> <span class="n">just</span> <span class="n">need</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">the</span> <span class="n">init</span> <span class="n">value</span> <span class="n">to</span> <span class="n">make</span> <span class="n">it</span> <span class="n">past</span> <span class="n">this</span> <span class="n">edge</span> <span class="n">case</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">present</span> <span class="n">at</span> <span class="n">startup</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">Enable_Positive</span> <span class="n">THEN</span> <span class="n">fOutHiLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">Enable_Negative</span> <span class="n">THEN</span> <span class="n">fOutLoLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">IF</span> <span class="n">ftEnPos</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rLLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span><span class="p">;</span>

        <span class="n">fOutHiLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">rtEnPos</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rLLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">LowerVoltage</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="n">fOutHiLimHolder</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">ftEnNeg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rHLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span><span class="p">;</span>

        <span class="n">fOutLoLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">rtEnNeg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rHLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">UpperVoltage</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="n">fOutLoLimHolder</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">Don</span><span class="s1">&#39;t do anything until we&#39;</span><span class="n">re</span> <span class="n">ready</span>
<span class="n">IF</span> <span class="n">bInitialized</span> <span class="n">THEN</span>

    <span class="o">//</span><span class="n">While</span> <span class="n">the</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">working</span><span class="p">,</span> <span class="n">a</span> <span class="n">new</span> <span class="n">position</span> <span class="n">may</span> <span class="n">be</span> <span class="n">requested</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">OK</span>
    <span class="n">IF</span> <span class="n">xBusy</span> <span class="n">THEN</span>
        <span class="n">fbPI</span><span class="o">.</span><span class="n">fSetpointValue</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqAbsPos</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="nb">next</span> <span class="n">chunk</span> <span class="n">of</span> <span class="n">code</span> <span class="n">prevents</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="kn">from</span> <span class="nn">winding</span> <span class="n">up</span><span class="o">.</span>
        <span class="n">First</span><span class="p">,</span> <span class="n">when</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">begins</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">voltage</span> <span class="n">that</span> <span class="ow">is</span>
        <span class="n">beyond</span> <span class="n">the</span> <span class="n">permitted</span> <span class="nb">range</span> <span class="p">(</span><span class="n">this</span> <span class="nb">range</span> <span class="ow">is</span> <span class="n">affected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">state</span>
        <span class="n">of</span> <span class="n">limit</span> <span class="n">switches</span><span class="o">/</span> <span class="ow">or</span> <span class="n">enable</span> <span class="n">fwd</span><span class="o">/</span><span class="n">bwd</span><span class="p">),</span> <span class="n">we</span> <span class="n">latch</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">position</span><span class="o">.</span>
        <span class="n">Presumeably</span> <span class="n">this</span> <span class="n">position</span> <span class="n">request</span>  <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span><span class="n">Select</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">control</span> <span class="n">mode</span>
    <span class="o">////////////////////////////////////////</span>
    <span class="n">IF</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xVoltageMode</span> <span class="n">THEN</span>
        <span class="o">//</span><span class="n">Set</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">to</span> <span class="n">idle</span>
        <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_PASSIVE</span><span class="p">;</span>
        <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span><span class="p">;</span> <span class="o">//</span><span class="n">TODO</span> <span class="n">add</span> <span class="n">a</span> <span class="n">ramp</span>
    <span class="n">ELSE</span>
        <span class="n">IF</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xIdleMode</span> <span class="n">THEN</span>
            <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">fScale</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">fPiezoBias</span><span class="p">;</span>

            <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_MANUAL</span><span class="p">;</span>
            <span class="n">ACT_Controller</span><span class="p">();</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">bHold</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="o">//</span><span class="n">Fout</span> <span class="ow">is</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">voltage</span> <span class="n">control</span>
            <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">fScale</span> <span class="o">*</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span> <span class="o">+</span> <span class="n">fPiezoBias</span><span class="p">;</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">bHold</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="o">//</span><span class="n">Control</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">active</span><span class="p">,</span> <span class="n">so</span> <span class="n">compensation</span> <span class="n">takes</span> <span class="n">over</span> <span class="n">more</span> <span class="n">smoothly</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_ACTIVE</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">END_IF</span>

    <span class="n">ACT_Controller</span><span class="p">();</span>

    <span class="n">xVoltageLimited</span> <span class="o">:=</span> <span class="n">rLLSV</span> <span class="o">&gt;</span> <span class="n">rReqVoltage</span> <span class="n">OR</span> <span class="n">rHLSV</span> <span class="o">&lt;</span> <span class="n">rReqVoltage</span><span class="p">;</span>

    <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">where</span> <span class="n">the</span> <span class="n">voltage</span> <span class="n">request</span> <span class="n">gets</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">driver</span>
    <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">rLLSV</span><span class="p">,</span> <span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">rHLSV</span><span class="p">);</span>

<span class="o">//</span><span class="n">Initialization</span>
<span class="n">ELSE</span>
    <span class="n">fbGetCycleTime</span><span class="p">(</span> <span class="n">eMode</span>   <span class="o">:=</span> <span class="n">eCTRL_MODE_ACTIVE</span><span class="p">,</span>
                <span class="n">tTaskCycleTime</span> <span class="o">=&gt;</span> <span class="n">tTaskCycleTime</span><span class="p">,</span>
                <span class="n">bCycleTimeValid</span> <span class="o">=&gt;</span> <span class="n">bCycleTimeValid</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">bCycleTimeValid</span> <span class="n">THEN</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">tTaskCycleTime</span> <span class="o">:=</span> <span class="n">tTaskCycleTime</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">tCtrlCycleTime</span> <span class="o">:=</span> <span class="n">tTaskCycleTime</span><span class="p">;</span>
        <span class="n">bInitialized</span>        <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>

<span class="n">tonPiezoDone</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">WithinRange</span><span class="p">(</span><span class="n">ValA</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rActPos</span><span class="p">,</span> <span class="n">Center</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqAbsPos</span><span class="p">,</span> <span class="n">Range</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rPiezoDmovRange</span><span class="p">,</span> <span class="n">Offset</span><span class="o">:=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">AND</span> <span class="n">NOT</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span> <span class="o">//</span><span class="n">rtStartMove</span> <span class="n">interrupts</span> <span class="n">the</span> <span class="n">timer</span><span class="p">,</span> <span class="n">resetting</span> <span class="n">it</span>
<span class="n">tonPiezoDone</span><span class="p">();</span>

<span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fbPI</span><span class="o">.</span><span class="n">bARWactive</span> <span class="n">OR</span> <span class="n">xVoltageLimited</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">tonPiezoLimited</span><span class="p">();</span>

<span class="n">xDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">xBusy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">tonPiezoDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">xLimited</span> <span class="o">:=</span> <span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">xBusy</span> <span class="n">R</span><span class="o">=</span> <span class="n">xDone</span><span class="p">;</span>

<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_CheckLimits</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Controller</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-piezocontrol">E_PiezoControl</a></p></li>
<li><p><a class="reference internal" href="#st-piezoaxisold">ST_PiezoAxisOld</a></p></li>
<li><p><a class="reference internal" href="#withinrange">WithinRange</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pitchcontrolold">
<h2>FB_PitchControlOld<a class="headerlink" href="#fb-pitchcontrolold" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{attribute &#39;reflection&#39;}
FUNCTION_BLOCK FB_PitchControlOld
VAR_IN_OUT
    Pitch : HOMS_PitchMechanismOld;
END_VAR
VAR_INPUT
    DirectPiezoMode :       BOOL := FALSE; //Set this true to tell the piezo what position to seek in closed loop
    rReqAbsPos      :       REAL; //Control the pitch position with this when DirectPiezoMode is false
END_VAR
VAR_OUTPUT
    q_xError        :       BOOL;
    q_xDone :       BOOL;
    q_xBusy :       BOOL;
END_VAR
VAR
    //Introspection
    //////////////////////////////
        {attribute &#39;instance-path&#39;}
        {attribute &#39;no_init&#39;}
        POUName     :       STRING; //Name of the POU for logging/error reporting


    //FB Boilerplate
    //////////////////////
        stDiag      :       ST_fbDiagnostics;
        fbFormatString      :       FB_FormatString;

    //Working variables
    /////////////////////////
        PC_State            :       E_PitchControl := PCM_Init;
        rPrevReqAbsPos      :       REAL; //Previously  requested abs position
        rPrevStepperPos :   REAL; //Previously successfully achieved stepper position
        tonStepperHold      :       TON := (PT := T#100MS); //Timer to hold stepper position while the system relaxes
        FirstPass   :       BOOL := TRUE; //set false after first pass, used for initializations
        Coarse50PiezoMove   :       BOOL;
        OriginalPosRequest: REAL;
        //PTP
        /////////////////////////
                Drive         : FB_DRIVE;
                fbCoE         : FB_ElmoGDCBellCoE;
                nCommand      : UINT;
                rLastSetpoint : REAL;
                rtTweakFwd    : R_TRIG;
                rtTweakBwd    : R_TRIG;
                rtExecute     : R_TRIG;
                bRequesting   : BOOL;
                rSetpoint     : REAL; //Adjusted based on abs pos request or tweaks.
                mcSmoothMover       :       MC_SmoothMover;

    //Axis Control Blocks
    /////////////////////////////
        fbPiezoControl      :       FB_PiezoControl;


    //Triggers
    //////////////////////////////
        rtManualMode:       R_TRIG;
        ftManualMode        :       F_TRIG;
        rtStepperDone       :       R_TRIG;

    lrActPos: LREAL;
    tonPiezoSettled : TON := (PT:=T#2S);
    tonPiezoDone    :       TON := (PT:=T#500ms);

    ftLimitSwitch: F_TRIG;
    // Flag to track when a limit switch has been hit.
    xLimitHit: BOOL;
    rtPiezoMoveDone: R_TRIG;
    rtHalt: R_TRIG;
    bCoarseMoveComplete     :       BOOL; //Set after a coarse move completes, added because coarse moves can be interrupted
END_VAR
VAR CONSTANT
    cPiezoRange     :       REAL := 60; // 90um of stroke to the piezo, which means a 180urad stroke...
    cOperatingRegion : REAL := 0.75; // Only use a fraction of the piezo range before forcing a coarse move
END_VAR
(* HOMS Pitch Control
A. Wallace

The HOMS Pitch mechanism consists of a stepper and piezo that work together to adjust
the pitch of the mirror assembly.

Pitch control state machine

If the target position is beyond the range of the piezo mechanism,
execute a coarse pitch move with the stepper.
The target of the coarse move shall be set to the requested position.
Once coarse motion has completed the coarse motion drive position
correction output shall be set to zero.

Fine pitch motion with the piezo will be initiated to finish closing the loop.

The piezo mechanism can actuate ~ 180urad or 90um.

*)

lrActPos := Pitch.Stepper.stAxis.NcToPlc.ActPos;
nCommand  := 3;
(* If we hit a limit during a move, we need to change the setpoint *)
ftLimitSwitch(CLK:=Pitch.Stepper.xHiLS AND Pitch.Stepper.xLoLS);

//Manual mode switching logic
/////////////////////////////////////
    rtManualMode(CLK:=DirectPiezoMode);
    ftManualMode(CLK:=DirectPiezoMode);
    A_ModeSwitch();

//Motion control logic from PTP
//Tweak Triggers
/////////////////////////////////////////////
    rtTweakFwd(CLK:=Pitch.Axis.bTwkFwd);
    rtTweakBwd(CLK:=Pitch.Axis.bTwkBwd);
    rtExecute(CLK:=NOT Pitch.Stepper.stAxis.Status.NotMoving);

//Tweak Forward
/////////////////////
IF rtTweakFwd.Q THEN
    //Setup move
    Pitch.Axis.rReqAbsPos := rLastSetpoint + Pitch.Axis.rTweak;
//Tweak Backwards
/////////////////////
ELSIF rtTweakBwd.Q THEN
    //Setup move
    Pitch.Axis.rReqAbsPos := rLastSetpoint - Pitch.Axis.rTweak;
ELSE
    bRequesting := FALSE;
END_IF

(* At this point, Pitch.Axis.rReqAbsPos holds the next setpoint.
Now it will be validated against the soft-limits
*)

//Halt
///////////////////////////////////
    rtHalt(CLK:= Pitch.Axis.xStop);
    (* Halt does the following
    Halts stepper motion, waits for stepper to settle, records stepper position as prev. stepper pos.
    moves to fine move with a new abs setpoint
    *)
    IF rtHalt.Q AND NOT q_xDone THEN
        PC_State := PCM_Halt;
    END_IF

//Check for new position requests, and sanitize
///////////////////////////////////////////////
    IF (rLastSetpoint &lt;&gt; Pitch.Axis.rReqAbsPos) THEN
        //We don&#39;t want to initiate any kind of a move if we don&#39;t have to.
        IF  Pitch.Axis.rReqAbsPos &gt; Pitch.ReqPosLimHi OR Pitch.Axis.rReqAbsPos &lt; Pitch.ReqPosLimLo OR
            (Pitch.Axis.rReqAbsPos &lt; lrActPos) AND Pitch.Axis.xLoLS OR (Pitch.Axis.rReqAbsPos &gt; lrActPos) AND Pitch.Axis.xHiLS THEN
            //Requested move is outside of travel limits
            OriginalPosRequest      := Pitch.Axis.rReqAbsPos;
            Pitch.Axis.rReqAbsPos := LIMIT(Pitch.ReqPosLimLo, Pitch.Axis.rReqAbsPos, Pitch.ReqPosLimHi);
            //Only want to log one warning about a bad position request.
            IF OriginalPosRequest &lt;&gt; Pitch.Axis.rReqAbsPos THEN
                //Log a warning
                fbFormatString.sFormat := &#39;Pitch req OoR fb (%s), reset within limits, %f&#39;;
                fbFormatString.arg1 := F_STRING(POUName);
                fbFormatString.arg2 := F_REAL(OriginalPosRequest);
                //fbFormatString(sOut=&gt;fbLogMessage.i_sMsg);
                fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
                //fbLogMessage(i_eSevr:= Warning, i_eSubsystem:=gDefaultSubsystem);
            END_IF
        END_IF
        // At this point Pitch.Axis.rReqAbsPos is considered clean and safe, so we pass to a holding variable
        rSetpoint := Pitch.Axis.rReqAbsPos;
        //Set the previously requested position here
        rLastSetpoint := rSetpoint;
        //New position request, no longer done.
        q_xDone := FALSE;
        q_xBusy     := TRUE;
        PC_State := PCM_MoveRequested;
    END_IF

//State Machine
//////////////////////////////////
CASE PC_State OF
    PCM_Init:
        //Initialize stepper motor mc power block
        Drive.bReset := FirstPass;
        PC_State := PCM_Standby;

    PCM_Standby:
        ;

    PCM_MoveRequested:
        //A move has been requested, is it within range of the piezo?
        IF WithinRange(ValA:=rSetpoint, Center:=rPrevStepperPos, Range:=cPiezoRange, Offset:=0)
                //Ensure that the piezo is not currently outside the operating range
                //Otherwise, force a coarse move that will rezero the piezo travel
            AND WithinRange(ValA:=Pitch.Piezo.rActVoltage,
                                Center:=(Pitch.Piezo.LowerVoltage + Pitch.Piezo.UpperVoltage)/2.0,
                                Range:=cOperatingRegion*(Pitch.Piezo.UpperVoltage - Pitch.Piezo.LowerVoltage)/2.0,
                                Offset:=0)
            AND bCoarseMoveComplete
        THEN
            //Move is within the nominal range of the piezo
            fbFormatString.sFormat := &#39;Within range, fine move %f&#39;;
            fbFormatString.arg1 := F_REAL(rSetpoint);
            fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            PC_State := PCM_FineMove;
        ELSE
            // Out of range, head to coarse move
            fbFormatString.sFormat := &#39;OoR, using stepper %f&#39;;
            fbFormatString.arg1 := F_REAL(rSetpoint);
            fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            bCoarseMoveComplete := FALSE;
            PC_State := PCM_Coarse50Piezo;
        END_IF

    PCM_Coarse50Piezo:
        //A coarse move uses the stepper to do a best-effort position
        //First set the piezo to nominal 50% extension using idle mode
        //////////////////////////////////////////////////////////////////////////////
        Pitch.Piezo.xIdleMode := TRUE;
        //Indicate we are doing the coarse 50% piezo move
        Coarse50PiezoMove := TRUE;
        //Wait for piezo to settle
        tonPiezoSettled.IN := TRUE;
        Coarse50PiezoMove R= tonPiezoSettled.Q;
        IF tonPiezoSettled.Q THEN
            //Piezo has moved to 50% position, finish with the stepper
            PC_State := PCM_CoarseMove;
            Pitch.Stepper.xEnable := TRUE;
            tonPiezoSettled.IN := FALSE;
        END_IF

    PCM_CoarseMove:
        //With the piezo at a nom 50% extension, move the stepper to requested position
        IF Drive.bEnabled THEN
            //Drive.fPosition := rSetpoint;
            //Drive.bExecute := TRUE;

            mcSmoothMover.ReqAbsPos := rSetpoint;
            mcSmoothMover.Enable := TRUE;
        END_IF

        IF ftLimitSwitch.Q THEN
            Drive.fPosition := lrActPos;

            mcSmoothMover.ReqAbsPos := lrActPos;

            xLimitHit       := TRUE; //set this flag here.
        END_IF
        tonStepperHold.IN := WithinRange(ValA:=LREAL_TO_REAL(lrActPos), Center:=rSetpoint, Range:=Pitch.Stepper.rStepperDmovRange, Offset:=0);
        tonStepperHold(); //call this here to reset Q just below on first cycle
        //If the coarse move is complete, finish position correction with the piezo
        IF tonStepperHold.Q  OR ftLimitSwitch.Q THEN
            PC_State := PCM_CoarseMoveCleanup;
        ELSIF Pitch.Stepper.stStatus.bError OR Drive.bError OR mcSmoothMover.Error THEN
            Drive.bExecute := FALSE;
            mcSmoothMover.Enable := FALSE;
            Pitch.Stepper.xEnable := FALSE;
            PC_State := PCM_StepperError;
            //Stepper fb has encountered an error, pass a message to the logger
            IF Pitch.Stepper.stStatus.bError THEN
                fbFormatString.sFormat := &#39;Coarse move error, stepper err id %d&#39;;
                fbFormatString.arg1 := F_UDINT(Pitch.Stepper.stStatus.nErrorId);
            ELSIF Drive.bError THEN
                fbFormatString.sFormat := &#39;Coarse move error, drive err id %d&#39;;
                fbFormatString.arg1 := F_UDINT(Drive.nErrorId);
            ELSIF mcSmoothMover.Error THEN
                fbFormatString.sFormat := &#39;Coarse move error, smoothmover error&#39;;
            END_IF
            fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
        END_IF

    PCM_CoarseMoveCleanup:
        Drive.bExecute := FALSE;
        //Calling Drive with execute false will halt the axis
        //Once halted, the axis will be in standstill
        // then we can disble it without error.
        IF Pitch.Stepper.stAxis.Status.StandStill THEN
            Pitch.Stepper.xEnable := FALSE;
        END_IF
        IF Pitch.Stepper.stAxis.Status.Disabled THEN
            rPrevStepperPos := mcSmoothMover.ReqAbsPos;
            bCoarseMoveComplete     := TRUE;
            PC_State := PCM_FineMove;
        END_IF

    PCM_FineMove:
        Pitch.Piezo.xIdleMode := FALSE;
        fbPiezoControl.xExecute := TRUE;
        IF xLimitHit THEN
            Pitch.Piezo.rReqAbsPos := lrActPos;
        ELSE
            Pitch.Piezo.rReqAbsPos := rSetpoint;
        END_IF
        rtPiezoMoveDone(CLK:=fbPiezoControl.xDone);
        IF rtPiezoMoveDone.Q THEN
            fbPiezoControl.xExecute := FALSE;
            PC_State := PCM_Done;
        END_IF

    PCM_Halt:
        //We may transition to this state from anywhere, so we need to clean up and move to done
        //Halt the stepper
        //If trans. from FineMove, stepper is already disabled
        Drive.bExecute := FALSE;
        IF Pitch.Stepper.stAxis.Status.Standstill OR Pitch.Stepper.stAxis.Status.Disabled THEN
            Pitch.Stepper.xEnable := FALSE;
            //If the piezo control is done, we haven&#39;t started the fine move yet, so we can
            // record the current position as the prev. achv. stepper position.
            IF fbPiezoControl.xDone THEN
                rPrevStepperPos := lrActPos;
            END_IF
            // Very special case, where the setpoint is now where we halted
            rSetpoint := lrActPos;
            PC_State := PCM_FineMove;
        END_IF

    PCM_Done:

        Pitch.Axis.rReqAbsPos := rLastSetpoint; //this might be kind of funky
        xLimitHit := FALSE;
        //Indicate we&#39;re done
        q_xDone     := TRUE;
        q_xBusy := FALSE;
        //Move back to standby
        PC_State := PCM_Standby;
    PCM_StepperError:
        Drive.bReset := TRUE; // set false again in PCM_Init
        q_xBusy := FALSE;
        PC_State := PCM_Init;
    PCM_PiezoError:
        q_xBusy := FALSE;
        PC_State := PCM_Init;
    PCM_OtherError:
        q_xBusy := FALSE;
        PC_State := PCM_Init;

END_CASE

FirstPass := FALSE;

//Transfer the other stuff to the piezo
/////////////////////////////////////////
Pitch.Piezo.rActPos := lrActPos;

//Function blocks
ACT_PTP();

tonPiezoSettled();
tonStepperHold();

fbPiezoControl(iq_Piezo:=Pitch.Piezo,
    Enable_Positive:=Pitch.Stepper.xHiLS,
    Enable_Negative:=Pitch.Stepper.xLoLS
);

END_FUNCTION_BLOCK

ACTION A_ModeSwitch:
(* When switching between modes, we need to make sure all the executes/ mode switches, etc. are cleared *)

// Automatic to manual
/////////////////////////////
IF rtManualMode.Q THEN
;
END_IF

// Manual to automatic
//////////////////////////////
IF ftManualMode.Q THEN
    ;
END_IF
END_ACTION

ACTION ACT_PTP:
//Read CoE Parameters
/////////////////////////
fbCoE(stCoE:=Pitch.Stepper.stCoE);

//Give control of the axis to the Drive function block
///////////////////////////////////////////////////////
Drive(bEnable  := Pitch.Stepper.xEnable,
      Axis     := Pitch.Stepper.stAxis,
      nCommand := nCommand,
      fAcceleration := Pitch.Stepper.fAcceleration,
      fDeceleration := Pitch.Stepper.fDeceleration,
      fVelocity     := Pitch.Stepper.fVelocity,
      bLimitFwd     := Pitch.Stepper.xHiLS,
      bLimitBwd     := Pitch.Stepper.xLoLS,
      bDone =&gt;  Pitch.Stepper.bDone,
      bBusy =&gt; Pitch.Stepper.bBusy,
      stStepperStatus =&gt; Pitch.Stepper.stStatus
      );

//Reset Execute to wait for next motion command
////////////////////////////////////////////////
//bExecute R= Drive.Status.NotMoving AND NOT bRequesting;

//MC Smooth Mover
////////////////////////////////////////////////
(* You can control an axis with MC blocks other than those in PTP or drive.
We just use the drive/PTP block to initialize the axis and manage the limit
switch logic *)
mcSmoothMover(Axis:=Pitch.Stepper.stAxis,
    Velocity:=Pitch.Stepper.fVelocity);
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pitchcontrol">E_PitchControl</a></p></li>
<li><p><a class="reference internal" href="#fb-elmogdcbellcoe">FB_ElmoGDCBellCoE</a></p></li>
<li><p><a class="reference internal" href="#fb-piezocontrol">FB_PiezoControl</a></p></li>
<li><p><a class="reference internal" href="#homs-pitchmechanismold">HOMS_PitchMechanismOld</a></p></li>
<li><p><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></p></li>
<li><p><a class="reference internal" href="#withinrange">WithinRange</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pitchsoftlimits">
<h2>FB_PitchSoftLimits<a class="headerlink" href="#fb-pitchsoftlimits" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PitchSoftLimits</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Pitch</span>   <span class="p">:</span>       <span class="n">HOMS_PitchMechanismOld</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xHiLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xLoLS</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">diHys</span>   <span class="p">:</span>       <span class="n">DINT</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">;</span> <span class="o">//</span><span class="mi">500</span> <span class="n">nm</span> <span class="p">(</span><span class="mi">1</span> <span class="n">inc</span><span class="o">/</span><span class="n">nm</span><span class="p">)</span>
    <span class="n">STO</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">STO</span> <span class="o">:=</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">diInputs</span><span class="mf">.3</span><span class="p">;</span>

<span class="n">xHiLS</span> <span class="n">S</span><span class="o">=</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncCnt</span> <span class="o">&lt;</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncPosLimHi</span> <span class="o">-</span> <span class="n">diHys</span><span class="p">;</span>
<span class="n">xHiLS</span> <span class="n">R</span><span class="o">=</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncCnt</span> <span class="o">&gt;</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncPosLimHi</span><span class="p">;</span>

<span class="n">xLoLS</span> <span class="n">S</span><span class="o">=</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncCnt</span> <span class="o">&gt;</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncPosLimLo</span> <span class="o">+</span> <span class="n">diHys</span><span class="p">;</span>
<span class="n">xLoLS</span> <span class="n">R</span><span class="o">=</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncCnt</span> <span class="o">&lt;</span> <span class="n">Pitch</span><span class="o">.</span><span class="n">diEncPosLimLo</span><span class="p">;</span>

<span class="n">xHiLS</span> <span class="o">:=</span> <span class="n">xHiLS</span> <span class="n">AND</span> <span class="n">STO</span><span class="p">;</span>
<span class="n">xLoLS</span> <span class="o">:=</span> <span class="n">xLoLS</span> <span class="n">AND</span> <span class="n">STO</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-pitchmechanismold">HOMS_PitchMechanismOld</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ptp">
<h2>FB_PTP<a class="headerlink" href="#fb-ptp" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PTP</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Stepper</span>   <span class="p">:</span> <span class="n">ST_HOMSStepper</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">Drive</span>         <span class="p">:</span> <span class="n">FB_DRIVE</span><span class="p">;</span>
    <span class="n">fbCoE</span>         <span class="p">:</span> <span class="n">FB_ElmoGDCBellCoE</span><span class="p">;</span>
    <span class="n">nCommand</span>      <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">bExecute</span>      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">rLastSetpoint</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rtTweakFwd</span>    <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtTweakBwd</span>    <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtExecute</span>     <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bRequesting</span>   <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">rSetpoint</span>     <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Point</span> <span class="n">to</span> <span class="n">Point</span>
<span class="n">T</span><span class="o">.</span> <span class="n">Rendahl</span> <span class="mi">17</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">05</span>

<span class="n">Provides</span> <span class="n">a</span> <span class="n">conveinent</span> <span class="n">wrapper</span> <span class="k">for</span> <span class="n">EPICS</span> <span class="n">to</span> <span class="n">instruct</span> <span class="n">Point</span> <span class="n">to</span> <span class="n">Point</span> <span class="n">motion</span> <span class="n">of</span>
<span class="n">an</span> <span class="n">axis</span><span class="o">.</span> <span class="n">The</span> <span class="n">function</span> <span class="n">block</span> <span class="n">supplies</span> <span class="n">support</span> <span class="k">for</span> <span class="n">three</span> <span class="n">basic</span> <span class="n">kinds</span> <span class="n">of</span> <span class="n">motion</span><span class="p">,</span>
<span class="n">absolute</span><span class="p">,</span> <span class="n">tweak</span> <span class="n">forward</span> <span class="ow">and</span> <span class="n">tweak</span> <span class="n">backwards</span><span class="o">.</span> <span class="n">The</span> <span class="n">ladder</span> <span class="n">has</span> <span class="n">a</span> <span class="n">single</span> <span class="n">reference</span>
<span class="k">for</span> <span class="n">distance</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="n">however</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">motion</span> <span class="ow">is</span> <span class="n">triggered</span> <span class="n">by</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span>
<span class="n">either</span> <span class="n">bTwkFwd</span><span class="p">,</span> <span class="ow">or</span> <span class="n">bTwkBwd</span><span class="o">.</span> <span class="n">Absolute</span> <span class="n">positioning</span> <span class="n">works</span> <span class="n">differently</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span>
<span class="n">mimic</span> <span class="n">the</span> <span class="n">way</span> <span class="n">EPICS</span> <span class="n">motor</span> <span class="n">record</span><span class="o">.</span> <span class="n">In</span> <span class="n">this</span> <span class="n">case</span><span class="p">,</span> <span class="n">simply</span> <span class="n">changing</span> <span class="n">the</span> <span class="n">rAbsolute</span>
<span class="n">setpoint</span> <span class="n">will</span> <span class="n">start</span> <span class="n">the</span> <span class="n">motion</span>

<span class="n">The</span> <span class="n">management</span> <span class="n">of</span> <span class="n">setpoint</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">general</span> <span class="n">control</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Axis</span> <span class="n">are</span>
<span class="n">derived</span> <span class="n">HomsStepper</span> <span class="n">DUT</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="k">for</span> <span class="n">easy</span> <span class="n">mapping</span> <span class="n">of</span> <span class="n">status</span> <span class="n">variables</span> <span class="n">to</span>
<span class="n">EPICS</span> <span class="n">modbus</span> <span class="n">maps</span><span class="o">.</span>

<span class="n">TODO</span>
<span class="o">****</span>
<span class="n">Pause</span> <span class="p">:</span> <span class="n">The</span> <span class="n">drive</span> <span class="n">will</span> <span class="n">Halt</span> <span class="k">if</span> <span class="n">we</span> <span class="n">change</span> <span class="n">bExecute</span> <span class="n">to</span> <span class="kc">False</span>
<span class="n">Stop</span>  <span class="p">:</span> <span class="n">Not</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">FB_Drive</span><span class="p">,</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">Pause</span> <span class="k">except</span>
        <span class="n">requires</span> <span class="n">explicit</span> <span class="n">clearing</span> <span class="n">before</span> <span class="n">moving</span> <span class="n">again</span>
<span class="o">*</span><span class="p">)</span>
<span class="o">//</span><span class="n">Read</span> <span class="n">CoE</span> <span class="n">Parameters</span>
<span class="o">/////////////////////////</span>
<span class="n">fbCoE</span><span class="p">(</span><span class="n">stCoE</span><span class="o">:=</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stCoE</span><span class="p">);</span>

<span class="o">//</span><span class="n">Tweak</span> <span class="n">Triggers</span>
<span class="o">/////////////////////////////////////////////</span>
<span class="n">rtTweakFwd</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bTwkFwd</span><span class="p">);</span>
<span class="n">rtTweakBwd</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bTwkBwd</span><span class="p">);</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span><span class="p">);</span>


<span class="o">//</span><span class="n">Tweak</span> <span class="n">Forward</span>
<span class="o">/////////////////////</span>
<span class="n">IF</span> <span class="n">rtTweakFwd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Setup</span> <span class="n">move</span>
    <span class="n">nCommand</span>  <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">rSetpoint</span> <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">rTweak</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Execute</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRequesting</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="o">//</span><span class="n">Tweak</span> <span class="n">Backwards</span>
<span class="o">/////////////////////</span>
<span class="n">ELSIF</span> <span class="n">rtTweakBwd</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Setup</span> <span class="n">move</span>
    <span class="n">nCommand</span>  <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">rSetpoint</span> <span class="o">:=</span> <span class="o">-</span><span class="n">Stepper</span><span class="o">.</span><span class="n">rTweak</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Execute</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRequesting</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span><span class="n">Setpoint</span> <span class="n">change</span>
<span class="o">///////////////////////</span>
<span class="n">ELSIF</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">rReqAbsolute</span> <span class="o">&lt;&gt;</span> <span class="n">rLastSetpoint</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">AND</span> <span class="n">NOT</span> <span class="n">Drive</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Setup</span> <span class="n">move</span>
    <span class="n">rSetpoint</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">Stepper</span><span class="o">.</span><span class="n">rReqAbsolute</span><span class="p">);</span>
    <span class="n">nCommand</span>  <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Execute</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bRequesting</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Store</span> <span class="n">last</span> <span class="n">request</span> <span class="n">so</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t repeat</span>
    <span class="n">rLastSetpoint</span> <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">rReqAbsolute</span><span class="p">;</span>

<span class="n">ELSE</span>
    <span class="n">bRequesting</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Trigger</span> <span class="n">reset</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>
<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Stepper</span><span class="o">.</span><span class="n">xReset</span><span class="p">);</span>

<span class="o">//</span><span class="n">Give</span> <span class="n">control</span> <span class="n">of</span> <span class="n">the</span> <span class="n">axis</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Drive</span> <span class="n">function</span> <span class="n">block</span>
<span class="o">///////////////////////////////////////////////////////</span>
<span class="n">Drive</span><span class="p">(</span><span class="n">bEnable</span>  <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">xEnable</span><span class="p">,</span>
      <span class="n">Axis</span>     <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">stAxis</span><span class="p">,</span>
      <span class="n">nCommand</span> <span class="o">:=</span> <span class="n">nCommand</span><span class="p">,</span>
      <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">,</span>
      <span class="n">bReset</span> <span class="o">:=</span> <span class="n">rtReset</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
      <span class="n">fPosition</span>     <span class="o">:=</span> <span class="n">rSetpoint</span><span class="p">,</span>
      <span class="n">fAcceleration</span> <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">fAcceleration</span><span class="p">,</span>
      <span class="n">fDeceleration</span> <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">fDeceleration</span><span class="p">,</span>
      <span class="n">fVelocity</span>     <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">,</span>
      <span class="n">bLimitFwd</span>     <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">xHiLS</span><span class="p">,</span>
      <span class="n">bLimitBwd</span>     <span class="o">:=</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">xLoLS</span><span class="p">,</span>
      <span class="n">bDone</span> <span class="o">=&gt;</span> <span class="n">Stepper</span><span class="o">.</span><span class="n">bDone</span><span class="p">,</span>
      <span class="p">);</span>

<span class="o">//</span><span class="n">Reset</span> <span class="n">Execute</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">motion</span> <span class="n">command</span>
<span class="o">////////////////////////////////////////////////</span>
<span class="n">bExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">Drive</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">NotMoving</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">bRequesting</span><span class="p">;</span>

<span class="o">//</span><span class="n">Link</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Drive</span> <span class="n">back</span> <span class="n">to</span> <span class="n">the</span> <span class="n">struct</span>
<span class="n">Stepper</span><span class="o">.</span><span class="n">stStatus</span> <span class="o">:=</span> <span class="n">Drive</span><span class="o">.</span><span class="n">stStepperStatus</span><span class="p">;</span>
<span class="o">//</span><span class="n">Explicit</span> <span class="n">output</span> <span class="n">of</span> <span class="n">busy</span>
<span class="n">Stepper</span><span class="o">.</span><span class="n">bBusy</span> <span class="o">:=</span> <span class="n">Drive</span><span class="o">.</span><span class="n">bBusy</span><span class="p">;</span>
<span class="o">//</span><span class="n">Gather</span> <span class="n">done</span> <span class="n">flag</span> <span class="n">because</span> <span class="n">it</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">storted</span> <span class="ow">in</span> <span class="n">status</span>
<span class="o">//</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bDone</span> <span class="o">:=</span> <span class="n">bExecute</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-drive">FB_Drive</a></p></li>
<li><p><a class="reference internal" href="#fb-elmogdcbellcoe">FB_ElmoGDCBellCoE</a></p></li>
<li><p><a class="reference internal" href="#st-homsstepper">ST_HOMSStepper</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-readfloatparameter">
<h2>FB_ReadFloatParameter<a class="headerlink" href="#fb-readfloatparameter" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadFloatParameter</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
        <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
        <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
        <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
            <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">ELSE</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-readparameterinnc">
<h2>FB_ReadParameterInNC<a class="headerlink" href="#fb-readparameterinnc" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReadParameterInNC</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">:</span> <span class="n">ADSREAD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Read</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSREAD</span><span class="p">(</span>
        <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
        <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
        <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">DESTADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">READ</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSREAD</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
            <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">ELSE</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSREAD</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSREAD</span><span class="p">(</span><span class="n">READ</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-reducegantrydiff">
<h2>FB_ReduceGantryDiff<a class="headerlink" href="#fb-reducegantrydiff" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ReduceGantryDiff</span>
<span class="n">VAR_INPUT</span>
    <span class="n">xStart</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xError</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xBusy</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xDone</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_Gantry</span>       <span class="p">:</span>       <span class="n">HOMS_Gantry</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iStep</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Reduce</span> <span class="n">Gantry</span> <span class="n">Difference</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">17</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">26</span>

<span class="n">On</span> <span class="n">execute</span> <span class="n">rising</span><span class="o">-</span><span class="n">edge</span><span class="p">,</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">decouples</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">axes</span><span class="p">,</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="n">to</span>
<span class="n">reduce</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">difference</span><span class="o">.</span>

<span class="n">Presumably</span> <span class="n">the</span> <span class="n">gantry</span> <span class="n">error</span> <span class="n">has</span> <span class="n">occured</span> <span class="n">due</span> <span class="n">to</span> <span class="n">a</span> <span class="n">jammed</span> <span class="n">axis</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="o">//</span><span class="n">Idle</span>
    <span class="p">;</span>
    <span class="mi">100</span><span class="p">:</span>
        <span class="o">//</span><span class="n">Decide</span> <span class="n">to</span> <span class="n">move</span> <span class="n">P</span> <span class="ow">or</span> <span class="n">S</span> <span class="n">axis</span>
        <span class="o">//</span><span class="n">Always</span> <span class="k">try</span> <span class="n">to</span> <span class="n">move</span> <span class="n">S</span> <span class="n">to</span> <span class="n">P</span> <span class="k">if</span> <span class="n">you</span> <span class="n">can</span>
        <span class="o">//</span><span class="n">First</span> <span class="k">if</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">switches</span> <span class="n">don</span><span class="s1">&#39;t make sense, throw an error</span>
        <span class="p">;</span>
    <span class="o">//</span><span class="n">Move</span> <span class="n">S</span>

    <span class="o">//</span><span class="n">Recouple</span><span class="o">/</span> <span class="n">reset</span> <span class="n">to</span> <span class="n">idle</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-gantry">HOMS_Gantry</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-writeparameterinnc">
<h2>FB_WriteParameterInNC<a class="headerlink" href="#fb-writeparameterinnc" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WriteParameterInNC</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">///</span><span class="mi">16</span><span class="c1">#4000=Axisdata, 16#5000=Encoderdata, 16#6000=Controldata, 16#7000=Drivedata</span>
    <span class="n">nDeviceGroup</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nIndexOffset</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">nData</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bDone</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nErrorId</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span><span class="p">:</span> <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nState</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">:</span> <span class="n">ADSWRITE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span><span class="n">Sequence</span> <span class="n">to</span> <span class="n">write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
<span class="n">CASE</span> <span class="n">nState</span> <span class="n">OF</span>
<span class="mi">0</span><span class="p">:</span>  <span class="p">(</span><span class="o">*</span><span class="n">Start</span> <span class="n">sequence</span><span class="o">.</span> <span class="n">Wait</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">TRUE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bBusy</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">bError</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Write</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">Nc</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span>
        <span class="n">PORT</span><span class="o">:=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">IDXGRP</span><span class="o">:=</span><span class="n">nDeviceGroup</span><span class="o">+</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisId</span><span class="p">,</span>
        <span class="n">IDXOFFS</span><span class="o">:=</span><span class="n">nIndexOffset</span><span class="p">,</span>
        <span class="n">LEN</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">SRCADDR</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">nData</span><span class="p">),</span>
        <span class="n">WRITE</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Wait</span> <span class="n">until</span> <span class="n">it</span><span class="s1">&#39;s done or if an error occurs*)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERR</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
            <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
            <span class="n">nState</span><span class="o">:=</span><span class="mi">20</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">ELSE</span>
        <span class="n">nErrorId</span><span class="o">:=</span><span class="n">fbADSWRITE</span><span class="o">.</span><span class="n">ERRID</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">999</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Sequense</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span> <span class="n">Waits</span> <span class="n">until</span> <span class="n">bExecute</span> <span class="ow">is</span> <span class="n">FALSE</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="mi">999</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="n">Error</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">*</span><span class="p">)</span>
    <span class="n">bError</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">bDone</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbADSWRITE</span><span class="p">(</span><span class="n">WRITE</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
        <span class="n">nState</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="main">
<h2>Main<a class="headerlink" href="#main" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">Main</span>
<span class="n">VAR</span>
    <span class="n">tpImAPLC</span> <span class="p">:</span> <span class="n">TP</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>

    <span class="o">//</span> <span class="n">MR1L3</span>
    <span class="o">//</span> <span class="n">Motors</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_Yup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_Yup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YUP</span>
    <span class="s1">&#39;}</span>
    <span class="o">//</span><span class="n">PMPS</span> <span class="n">State</span> <span class="n">Stage</span><span class="p">;</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="kc">False</span>
    <span class="n">M1</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">sName</span><span class="o">:=</span><span class="s1">&#39;MR1L3-Coatings&#39;</span><span class="p">,</span> <span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m1</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_Ydwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_Ydwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M2</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m2</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_Xup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_Xup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XUP</span>
    <span class="s1">&#39;}</span>
    <span class="n">M3</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m3</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_Xdwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_Xdwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M4</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m4</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_PitchCoarse]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_PitchCoarse</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">M5</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR1L3</span> <span class="n">Pitch</span> <span class="n">Stepper</span>
    <span class="n">fbMotionStage_m5</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L3_Bender]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L3_Bender</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">M6</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR1L3</span> <span class="n">Bender</span>
    <span class="n">fbMotionStage_m6</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.fbRunHOMS.bSTOEnable1:=TIIB[EL1004_M1L3_STO]^Channel 1^Input;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL1004_M1L3_STO</span><span class="p">]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span>
    <span class="s1">&#39;}</span>
    <span class="n">MR1L3</span> <span class="p">:</span> <span class="n">DUT_HOMS</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">STATS</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR1L3GantryStats</span> <span class="p">:</span> <span class="n">FB_HomsStats</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Arrays</span><span class="o">/</span><span class="n">RMS</span> <span class="n">Watch</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">Y</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbYRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxYRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinYRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">X</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbXRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxXRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinXRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbPitchRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxPitchRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinPitchRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbBenderRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxBenderRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinBenderRMSErrorMR1L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
    <span class="n">fbMR1L3PitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>
    <span class="n">bMR1L3PitchDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMR1L3PitchBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Bender</span> <span class="n">Control</span>
    <span class="n">fbBenderMR1L3</span> <span class="p">:</span> <span class="n">FB_Bender</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYupMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYdwnMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXupMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXdwnMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntPitchMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYupMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYdwnMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXupMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXdwnMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefPitchMR1L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">mcReadParameterPitchMR1L3</span> <span class="p">:</span> <span class="n">MC_ReadParameter</span><span class="p">;</span>
    <span class="n">fEncRefPitchMR1L3_urad</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">Pitch</span> <span class="n">encoder</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">urad</span>
    <span class="o">//</span> <span class="n">MR1L4</span>
    <span class="o">//</span> <span class="n">Motors</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_Yup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_Yup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YUP</span>
    <span class="s1">&#39;}</span>
    <span class="n">M7</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m7</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_Ydwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_Ydwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M8</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m8</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_Xup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_Xup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XUP</span>
    <span class="s1">&#39;}</span>
    <span class="n">M9</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m9</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_Xdwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_Xdwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M10</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
    <span class="n">fbMotionStage_m10</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_PitchCoarse]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_PitchCoarse</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">M11</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR1L4</span> <span class="n">Pitch</span> <span class="n">Stepper</span>
    <span class="n">fbMotionStage_m11</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M1L4_Bender]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M1L4_Bender</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">M12</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR1L4</span> <span class="n">Bender</span>
    <span class="n">fbMotionStage_m12</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.fbRunHOMS.bSTOEnable1:=TIIB[EL1004_M1L4_STO]^Channel 1^Input;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL1004_M1L4_STO</span><span class="p">]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M1L4_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span>
    <span class="s1">&#39;}</span>
    <span class="n">MR1L4</span> <span class="p">:</span> <span class="n">DUT_HOMS</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">STATS</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR1L4GantryStats</span> <span class="p">:</span> <span class="n">FB_HomsStats</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Arrays</span><span class="o">/</span><span class="n">RMS</span> <span class="n">Watch</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">Y</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbYRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxYRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinYRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">X</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbXRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxXRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinXRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbPitchRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxPitchRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinPitchRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbBenderRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxBenderRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinBenderRMSErrorMR1L4</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
    <span class="n">fbMR1L4PitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>
    <span class="n">bMR1L4PitchDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMR1L4PitchBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Bender</span> <span class="n">Control</span>
    <span class="n">fbBenderMR1L4</span> <span class="p">:</span> <span class="n">FB_Bender</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYupMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYdwnMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXupMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXdwnMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntPitchMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYupMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYdwnMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXupMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXdwnMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefPitchMR1L4</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">mcReadParameterPitchMR1L4</span> <span class="p">:</span> <span class="n">MC_ReadParameter</span><span class="p">;</span>
    <span class="n">fEncRefPitchMR1L4_urad</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">Pitch</span> <span class="n">encoder</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">urad</span>

<span class="o">//</span> <span class="n">MR2L3</span> <span class="n">BECKHOFF</span>
<span class="o">//</span> <span class="n">Motors</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_Yup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_Yup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YUP</span>
    <span class="s1">&#39;}</span>
    <span class="n">M13</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Yup</span>
    <span class="n">fbMotionStage_m13</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_Ydwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_Ydwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">YDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M14</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Ydwn</span>
    <span class="n">fbMotionStage_m14</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_Xup]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_Xup</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XUP</span>
    <span class="s1">&#39;}</span>
    <span class="n">M15</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Xup</span>
    <span class="n">fbMotionStage_m15</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_Xdwn]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_Xdwn</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XDWN</span>
    <span class="s1">&#39;}</span>
    <span class="n">M16</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Xdwn</span>
    <span class="n">fbMotionStage_m16</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_PitchCoarse]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_PitchCoarse</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">M17</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Pitch</span> <span class="n">Stepper</span>
    <span class="n">fbMotionStage_m17</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.bLimitForwardEnable:=TIIB[EL7041-1000_M2L3_Bender]^STM Status^Status^Digital input 1;</span>
                              <span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL7041</span><span class="o">-</span><span class="mi">1000</span><span class="n">_M2L3_Bender</span><span class="p">]</span><span class="o">^</span><span class="n">STM</span> <span class="n">Status</span><span class="o">^</span><span class="n">Status</span><span class="o">^</span><span class="n">Digital</span> <span class="nb">input</span> <span class="mi">2</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_PitchBender</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">M18</span> <span class="p">:</span> <span class="n">DUT_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fVelocity</span><span class="o">:=</span><span class="mf">150.0</span><span class="p">,</span> <span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">,</span> <span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span> <span class="o">//</span> <span class="n">MR2L3</span> <span class="n">Bender</span>
    <span class="n">fbMotionStage_m18</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.fbRunHOMS.bSTOEnable1:=TIIB[EL1004_M2L3_STO]^Channel 1^Input;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL1004_M2L3_STO</span><span class="p">]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Yupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Position</span><span class="p">;</span>
                              <span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="o">:=</span><span class="n">TIIB</span><span class="p">[</span><span class="n">EL5042_M2L3_Xupdwn</span><span class="p">]</span><span class="o">^</span><span class="n">FB</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Position</span><span class="s1">&#39;}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span>
    <span class="s1">&#39;}</span>
    <span class="n">MR2L3</span> <span class="p">:</span> <span class="n">DUT_HOMS</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">STATS</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR2L3GantryStats</span> <span class="p">:</span> <span class="n">FB_HomsStats</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Arrays</span><span class="o">/</span><span class="n">RMS</span> <span class="n">Watch</span><span class="p">:</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">Y</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbYRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxYRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinYRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">X</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbXRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxXRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinXRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbPitchRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxPitchRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinPitchRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">BENDER</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbBenderRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">FB_RMSWatch</span><span class="p">;</span>
    <span class="n">fMaxBenderRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fMinBenderRMSErrorMR2L3</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
    <span class="n">fbMR2L3PitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>
    <span class="n">bMR2L3PitchDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bMR2L3PitchBusy</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Bender</span> <span class="n">Control</span>
    <span class="n">fbBenderMR2L3</span> <span class="p">:</span> <span class="n">FB_Bender</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYupMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntYdwnMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXupMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntXdwnMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">CNT</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncCntPitchMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYupMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">YDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefYdwnMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXupMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">XDWN</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefXdwnMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">ENC</span><span class="p">:</span><span class="n">PITCH</span><span class="p">:</span><span class="n">REF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">cnt</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nEncRefPitchMR2L3</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">mcReadParameterPitchMR2L3</span> <span class="p">:</span> <span class="n">MC_ReadParameter</span><span class="p">;</span>
    <span class="n">fEncRefPitchMR2L3_urad</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">Pitch</span> <span class="n">encoder</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">urad</span>


    <span class="o">//</span> <span class="n">Common</span>
    <span class="n">fEncLeverArm_mm</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">513.0</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Logging</span>
    <span class="n">fbLogHandler</span> <span class="p">:</span> <span class="n">FB_LogHandler</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L3_RTD_1</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">2</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L3_RTD_2</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L3_RTD_3</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM2L3_RTD_1</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">2</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM2L3_RTD_2</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM2L3_RTD_3</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L4_RTD_1</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">2</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L4_RTD_2</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ASLO</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">C</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fM1L4_RTD_3</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">MR1L3</span> <span class="n">BECKHOFF</span>
<span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="p">(</span><span class="n">stYup</span><span class="o">:=</span><span class="n">M1</span><span class="p">,</span>
               <span class="n">stYdwn</span><span class="o">:=</span><span class="n">M2</span><span class="p">,</span>
               <span class="n">stXup</span><span class="o">:=</span><span class="n">M3</span><span class="p">,</span>
               <span class="n">stXdwn</span><span class="o">:=</span><span class="n">M4</span><span class="p">,</span>
               <span class="n">stPitch</span><span class="o">:=</span><span class="n">M5</span><span class="p">,</span>
               <span class="n">nYupEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nYdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">nXupEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nXdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">bExecuteCoupleY</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bExecuteCoupleY</span><span class="p">,</span>
               <span class="n">bExecuteCoupleX</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bExecuteCoupleX</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleY</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bExecuteDecoupleY</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleX</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bExecuteDecoupleX</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledY</span><span class="o">=&gt;</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledY</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledX</span><span class="o">=&gt;</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledX</span><span class="p">,</span>
               <span class="n">nCurrGantryY</span><span class="o">=&gt;</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">,</span>
               <span class="n">nCurrGantryX</span><span class="o">=&gt;</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">);</span>
<span class="n">fbBenderMR1L3</span><span class="p">(</span><span class="n">stBender</span><span class="o">:=</span><span class="n">M6</span><span class="p">,</span>
             <span class="n">bSTOEnable1</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable1</span><span class="p">,</span>
             <span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="p">);</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">slave</span> <span class="n">motion</span> <span class="n">through</span> <span class="n">Epics</span>
<span class="n">M2</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR1L3</span><span class="o">-</span><span class="n">Ydwn</span>
<span class="n">M4</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR1L3</span><span class="o">-</span><span class="n">Xdwn</span>

<span class="o">//</span> <span class="n">Convert</span> <span class="n">nCurrGantry</span> <span class="n">to</span> <span class="n">um</span> <span class="p">(</span><span class="n">smaller</span> <span class="n">number</span><span class="p">)</span> <span class="n">to</span> <span class="n">read</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">epics</span>
<span class="n">MR1L3</span><span class="o">.</span><span class="n">fCurrGantryY_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>
<span class="n">MR1L3</span><span class="o">.</span><span class="n">fCurrGantryX_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>

<span class="o">//</span> <span class="n">FB_MotionStage</span><span class="s1">&#39;s for non-piezo axes</span>
<span class="n">fbMotionStage_m1</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M1</span><span class="p">);</span>
<span class="n">fbMotionStage_m2</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M2</span><span class="p">);</span>
<span class="n">fbMotionStage_m3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M3</span><span class="p">);</span>
<span class="n">fbMotionStage_m4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M4</span><span class="p">);</span>
<span class="n">fbMotionStage_m5</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M5</span><span class="p">);</span>
<span class="n">fbMotionStage_m6</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M6</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">Gantry</span> <span class="n">Stats</span>
<span class="n">fbMR1L3GantryStats</span><span class="p">(</span><span class="n">homs</span><span class="o">:=</span><span class="n">MR1L3</span><span class="p">,</span> <span class="n">fbUpStreamY</span><span class="o">:=</span><span class="n">M1</span><span class="p">,</span> <span class="n">fbUpStreamX</span><span class="o">:=</span><span class="n">M3</span><span class="p">);</span>
<span class="n">fbMR1L4GantryStats</span><span class="p">(</span><span class="n">homs</span><span class="o">:=</span><span class="n">MR1L4</span><span class="p">,</span> <span class="n">fbUpStreamY</span><span class="o">:=</span><span class="n">M7</span><span class="p">,</span> <span class="n">fbUpStreamX</span><span class="o">:=</span><span class="n">M9</span><span class="p">);</span>
<span class="n">fbMR2L3GantryStats</span><span class="p">(</span><span class="n">homs</span><span class="o">:=</span><span class="n">MR2L3</span><span class="p">,</span> <span class="n">fbUpStreamY</span><span class="o">:=</span><span class="n">M13</span><span class="p">,</span> <span class="n">fbUpStreamX</span><span class="o">:=</span><span class="n">M15</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">Pitch</span> <span class="n">RMS</span> <span class="n">Error</span><span class="p">:</span>
<span class="n">fbYRMSErrorMR1L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M1</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxYRMSErrorMR1L3</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinYRMSErrorMR1L3</span><span class="p">);</span>

<span class="n">fbXRMSErrorMR1L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M3</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxXRMSErrorMR1L3</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinXRMSErrorMR1L3</span><span class="p">);</span>

<span class="n">fbPitchRMSErrorMR1L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M5</span><span class="p">,</span>
                    <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxPitchRMSErrorMR1L3</span><span class="p">,</span>
                    <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinPitchRMSErrorMR1L3</span><span class="p">);</span>

<span class="n">fbBenderRMSErrorMR1L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M6</span><span class="p">,</span>
                     <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxBenderRMSErrorMR1L3</span><span class="p">,</span>
                     <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinBenderRMSErrorMR1L3</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
<span class="o">//</span><span class="n">fbMR1L3PitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">GVL_M1</span><span class="o">.</span><span class="n">MR1L3_Pitch</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">Stepper</span><span class="o">:=</span><span class="n">M5</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">lrCurrentSetpoint</span><span class="o">:=</span><span class="n">M5</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bDone</span><span class="o">=&gt;</span><span class="n">bMR1L3PitchDone</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="n">bMR1L3PitchBusy</span><span class="p">);</span>
<span class="o">//</span> <span class="n">When</span> <span class="n">STO</span> <span class="n">hit</span><span class="p">,</span> <span class="n">need</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">SP</span>
<span class="o">//</span><span class="n">IF</span> <span class="n">NOT</span> <span class="n">M5</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">M5</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">M5</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="o">//</span><span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncCntYupMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntYdwnMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXupMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXdwnMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntPitchMR1L3</span> <span class="o">:=</span> <span class="n">LINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L3</span><span class="o">.</span><span class="n">MR1L3_Pitch</span><span class="o">.</span><span class="n">diEncCnt</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncRefYupMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefYdwnMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXupMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXdwnMR1L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L3_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">);</span>
<span class="n">mcReadParameterPitchMR1L3</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">M5</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                         <span class="n">Enable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                         <span class="n">ParameterNumber</span><span class="o">:=</span><span class="n">MC_AxisParameter</span><span class="o">.</span><span class="n">AxisEncoderOffset</span><span class="p">,</span>
                         <span class="n">ReadMode</span><span class="o">:=</span><span class="n">READMODE_CYCLIC</span><span class="p">,</span>
                         <span class="n">Value</span><span class="o">=&gt;</span><span class="n">fEncRefPitchMR1L3_urad</span><span class="p">);</span>

<span class="n">nEncRefPitchMR1L3</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">fEncRefPitchMR1L3_urad</span><span class="p">)</span> <span class="o">*</span> <span class="n">fEncLeverArm_mm</span><span class="p">);</span>

<span class="o">//</span><span class="n">Beckhoff</span> <span class="n">MR1L4</span>
<span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="p">(</span><span class="n">stYup</span><span class="o">:=</span><span class="n">M7</span><span class="p">,</span>
               <span class="n">stYdwn</span><span class="o">:=</span><span class="n">M8</span><span class="p">,</span>
               <span class="n">stXup</span><span class="o">:=</span><span class="n">M9</span><span class="p">,</span>
               <span class="n">stXdwn</span><span class="o">:=</span><span class="n">M10</span><span class="p">,</span>
               <span class="n">stPitch</span><span class="o">:=</span><span class="n">M11</span><span class="p">,</span>
               <span class="n">nYupEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nYdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">nXupEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nXdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">bExecuteCoupleY</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bExecuteCoupleY</span><span class="p">,</span>
               <span class="n">bExecuteCoupleX</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bExecuteCoupleX</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleY</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bExecuteDecoupleY</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleX</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bExecuteDecoupleX</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledY</span><span class="o">=&gt;</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledY</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledX</span><span class="o">=&gt;</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledX</span><span class="p">,</span>
               <span class="n">nCurrGantryY</span><span class="o">=&gt;</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">,</span>
               <span class="n">nCurrGantryX</span><span class="o">=&gt;</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">);</span>
<span class="n">fbBenderMR1L4</span><span class="p">(</span><span class="n">stBender</span><span class="o">:=</span><span class="n">M12</span><span class="p">,</span>
             <span class="n">bSTOEnable1</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable1</span><span class="p">,</span>
             <span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="p">);</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">slave</span> <span class="n">motion</span> <span class="n">through</span> <span class="n">Epics</span>
<span class="n">M8</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR1L3</span><span class="o">-</span><span class="n">Ydwn</span>
<span class="n">M10</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR1L3</span><span class="o">-</span><span class="n">Xdwn</span>

<span class="o">//</span> <span class="n">Convert</span> <span class="n">nCurrGantry</span> <span class="n">to</span> <span class="n">um</span> <span class="p">(</span><span class="n">smaller</span> <span class="n">number</span><span class="p">)</span> <span class="n">to</span> <span class="n">read</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">epics</span>
<span class="n">MR1L4</span><span class="o">.</span><span class="n">fCurrGantryY_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>
<span class="n">MR1L4</span><span class="o">.</span><span class="n">fCurrGantryX_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>

<span class="o">//</span> <span class="n">FB_MotionStage</span><span class="s1">&#39;s for non-piezo axes</span>
<span class="n">fbMotionStage_m7</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M7</span><span class="p">);</span>
<span class="n">fbMotionStage_m8</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M8</span><span class="p">);</span>
<span class="n">fbMotionStage_m9</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M9</span><span class="p">);</span>
<span class="n">fbMotionStage_m10</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M10</span><span class="p">);</span>
<span class="n">fbMotionStage_m11</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M11</span><span class="p">);</span>
<span class="n">fbMotionStage_m12</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M12</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">Pitch</span> <span class="n">RMS</span> <span class="n">Error</span><span class="p">:</span>
<span class="n">fbYRMSErrorMR1L4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M7</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxYRMSErrorMR1L4</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinYRMSErrorMR1L4</span><span class="p">);</span>

<span class="n">fbXRMSErrorMR1L4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M9</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxXRMSErrorMR1L4</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinXRMSErrorMR1L4</span><span class="p">);</span>

<span class="n">fbPitchRMSErrorMR1L4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M11</span><span class="p">,</span>
                    <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxPitchRMSErrorMR1L4</span><span class="p">,</span>
                    <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinPitchRMSErrorMR1L4</span><span class="p">);</span>

<span class="n">fbBenderRMSErrorMR1L4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M12</span><span class="p">,</span>
                     <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxBenderRMSErrorMR1L4</span><span class="p">,</span>
                     <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinBenderRMSErrorMR1L4</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
<span class="o">//</span><span class="n">fbMR1L4PitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">GVL_M1L4</span><span class="o">.</span><span class="n">MR1L4_Pitch</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">Stepper</span><span class="o">:=</span><span class="n">M11</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">lrCurrentSetpoint</span><span class="o">:=</span><span class="n">M11</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bDone</span><span class="o">=&gt;</span><span class="n">bMR1L4PitchDone</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="n">bMR1L4PitchBusy</span><span class="p">);</span>
<span class="o">//</span> <span class="n">When</span> <span class="n">STO</span> <span class="n">hit</span><span class="p">,</span> <span class="n">need</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">SP</span>
<span class="o">//</span><span class="n">IF</span> <span class="n">NOT</span> <span class="n">M11</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">M11</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">M11</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="o">//</span><span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncCntYupMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntYdwnMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXupMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXdwnMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntPitchMR1L4</span> <span class="o">:=</span> <span class="n">LINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L4</span><span class="o">.</span><span class="n">MR1L4_Pitch</span><span class="o">.</span><span class="n">diEncCnt</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncRefYupMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefYdwnMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXupMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXdwnMR1L4</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR1L4_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">);</span>

<span class="n">mcReadParameterPitchMR1L4</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">M11</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                         <span class="n">Enable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                         <span class="n">ParameterNumber</span><span class="o">:=</span><span class="n">MC_AxisParameter</span><span class="o">.</span><span class="n">AxisEncoderOffset</span><span class="p">,</span>
                         <span class="n">ReadMode</span><span class="o">:=</span><span class="n">READMODE_CYCLIC</span><span class="p">,</span>
                         <span class="n">Value</span><span class="o">=&gt;</span><span class="n">fEncRefPitchMR1L4_urad</span><span class="p">);</span>

<span class="n">nEncRefPitchMR1L4</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">fEncRefPitchMR1L4_urad</span><span class="p">)</span> <span class="o">*</span> <span class="n">fEncLeverArm_mm</span><span class="p">);</span>

<span class="o">//</span><span class="n">Beckhoff</span> <span class="n">MR2L3</span>
<span class="o">//</span> <span class="n">MR2L3</span>
<span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="p">(</span><span class="n">stYup</span><span class="o">:=</span><span class="n">M13</span><span class="p">,</span>
               <span class="n">stYdwn</span><span class="o">:=</span><span class="n">M14</span><span class="p">,</span>
               <span class="n">stXup</span><span class="o">:=</span><span class="n">M15</span><span class="p">,</span>
               <span class="n">stXdwn</span><span class="o">:=</span><span class="n">M16</span><span class="p">,</span>
               <span class="n">stPitch</span><span class="o">:=</span><span class="n">M17</span><span class="p">,</span>
               <span class="n">nYupEncRef</span><span class="o">:=</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nYdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">nXupEncRef</span><span class="o">:=</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">,</span>
               <span class="n">nXdwnEncRef</span><span class="o">:=</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">,</span>
               <span class="n">bExecuteCoupleY</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bExecuteCoupleY</span><span class="p">,</span>
               <span class="n">bExecuteCoupleX</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bExecuteCoupleX</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleY</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bExecuteDecoupleY</span><span class="p">,</span>
               <span class="n">bExecuteDecoupleX</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bExecuteDecoupleX</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledY</span><span class="o">=&gt;</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledY</span><span class="p">,</span>
               <span class="n">bGantryAlreadyCoupledX</span><span class="o">=&gt;</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledX</span><span class="p">,</span>
               <span class="n">nCurrGantryY</span><span class="o">=&gt;</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">,</span>
               <span class="n">nCurrGantryX</span><span class="o">=&gt;</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">);</span>
<span class="n">fbBenderMR2L3</span><span class="p">(</span><span class="n">stBender</span><span class="o">:=</span><span class="n">M18</span><span class="p">,</span>
             <span class="n">bSTOEnable1</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable1</span><span class="p">,</span>
             <span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="p">);</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">slave</span> <span class="n">motion</span> <span class="n">through</span> <span class="n">Epics</span>
<span class="n">M14</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR2L3</span><span class="o">-</span><span class="n">Ydwn</span>
<span class="n">M16</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">MR2L3</span><span class="o">-</span><span class="n">Xdwn</span>

<span class="o">//</span> <span class="n">Convert</span> <span class="n">nCurrGantry</span> <span class="n">to</span> <span class="n">um</span> <span class="p">(</span><span class="n">smaller</span> <span class="n">number</span><span class="p">)</span> <span class="n">to</span> <span class="n">read</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">epics</span>
<span class="n">MR2L3</span><span class="o">.</span><span class="n">fCurrGantryY_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">MR2L3</span><span class="o">.</span><span class="n">fCurrGantryX_um</span> <span class="o">:=</span> <span class="n">LINT_TO_REAL</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

<span class="o">//</span> <span class="n">FB_MotionStage</span><span class="s1">&#39;s for non-piezo axes</span>
<span class="n">fbMotionStage_m13</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M13</span><span class="p">);</span>
<span class="n">fbMotionStage_m14</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M14</span><span class="p">);</span>
<span class="n">fbMotionStage_m15</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M15</span><span class="p">);</span>
<span class="n">fbMotionStage_m16</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M16</span><span class="p">);</span>
<span class="n">fbMotionStage_m17</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M17</span><span class="p">);</span>
<span class="n">fbMotionStage_m18</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M18</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">RMS</span> <span class="n">Error</span><span class="p">:</span>
<span class="n">fbYRMSErrorMR2L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M13</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxYRMSErrorMR2L3</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinYRMSErrorMR2L3</span><span class="p">);</span>

<span class="n">fbXRMSErrorMR2L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M15</span><span class="p">,</span>
                <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxXRMSErrorMR2L3</span><span class="p">,</span>
                <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinXRMSErrorMR2L3</span><span class="p">);</span>

<span class="n">fbPitchRMSErrorMR2L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M17</span><span class="p">,</span>
                    <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxPitchRMSErrorMR2L3</span><span class="p">,</span>
                    <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinPitchRMSErrorMR2L3</span><span class="p">);</span>

<span class="n">fbBenderRMSErrorMR2L3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M18</span><span class="p">,</span>
                     <span class="n">fMaxRMSError</span><span class="o">=&gt;</span><span class="n">fMaxBenderRMSErrorMR2L3</span><span class="p">,</span>
                     <span class="n">fMinRMSError</span><span class="o">=&gt;</span><span class="n">fMinBenderRMSErrorMR2L3</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Pitch</span> <span class="n">Control</span>
<span class="o">//</span><span class="n">fbMR2L3PitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">GVL_MR2L3</span><span class="o">.</span><span class="n">MR2L3_Pitch</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">Stepper</span><span class="o">:=</span><span class="n">M17</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">lrCurrentSetpoint</span><span class="o">:=</span><span class="n">M17</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bDone</span><span class="o">=&gt;</span><span class="n">bMR2L3PitchDone</span><span class="p">,</span>
                   <span class="o">//</span><span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="n">bMR2L3PitchBusy</span><span class="p">);</span>
<span class="o">//</span> <span class="n">When</span> <span class="n">STO</span> <span class="n">hit</span><span class="p">,</span> <span class="n">need</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">SP</span>
<span class="o">//</span><span class="n">IF</span> <span class="n">NOT</span> <span class="n">M17</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">M17</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">M17</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="o">//</span><span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Raw</span> <span class="n">Encoder</span> <span class="n">Counts</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncCntYupMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntYdwnMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stYdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXupMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntXdwnMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">MR2L3</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXdwnEnc</span><span class="o">.</span><span class="n">Count</span><span class="p">);</span>
<span class="n">nEncCntPitchMR2L3</span> <span class="o">:=</span> <span class="n">LINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR2L3</span><span class="o">.</span><span class="n">MR2L3_Pitch</span><span class="o">.</span><span class="n">diEncCnt</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Encoder</span> <span class="n">Reference</span> <span class="n">Values</span> <span class="n">For</span> <span class="n">Epics</span>
<span class="n">nEncRefYupMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nYUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefYdwnMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nYDWN_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXupMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nXUP_ENC_REF</span><span class="p">);</span>
<span class="n">nEncRefXdwnMR2L3</span> <span class="o">:=</span> <span class="n">ULINT_TO_UDINT</span><span class="p">(</span><span class="n">GVL_MR2L3_Constants</span><span class="o">.</span><span class="n">nXDWN_ENC_REF</span><span class="p">);</span>
<span class="n">mcReadParameterPitchMR2L3</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">M17</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span>
                         <span class="n">Enable</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                         <span class="n">ParameterNumber</span><span class="o">:=</span><span class="n">MC_AxisParameter</span><span class="o">.</span><span class="n">AxisEncoderOffset</span><span class="p">,</span>
                         <span class="n">ReadMode</span><span class="o">:=</span><span class="n">READMODE_CYCLIC</span><span class="p">,</span>
                         <span class="n">Value</span><span class="o">=&gt;</span><span class="n">fEncRefPitchMR2L3_urad</span><span class="p">);</span>

<span class="n">nEncRefPitchMR2L3</span> <span class="o">:=</span> <span class="n">LREAL_TO_UDINT</span><span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">fEncRefPitchMR2L3_urad</span><span class="p">)</span> <span class="o">*</span> <span class="n">fEncLeverArm_mm</span><span class="p">);</span>

<span class="n">bXRT_M2_IN</span>  <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">MR1L4</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">stXupEnc</span><span class="o">.</span><span class="n">Count</span> <span class="o">&lt;</span> <span class="mi">25490840</span><span class="p">;</span>
<span class="n">bXRT_M2_OUT</span> <span class="o">:=</span> <span class="ow">not</span> <span class="n">bXRT_M2_IN</span><span class="p">;</span>
<span class="o">//</span><span class="n">States</span>
<span class="n">PRG_States</span><span class="p">();</span>
<span class="o">//</span><span class="n">PMPS</span>
<span class="n">PRG_CoatingProtection</span><span class="p">();</span>
<span class="n">PRG_PMPS</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Logging</span>
<span class="n">fbLogHandler</span><span class="p">();</span>

<span class="n">fM1L3_RTD_1</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L3_RTD_1</span><span class="p">);</span>
<span class="n">fM1L3_RTD_2</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L3_RTD_2</span><span class="p">);</span>
<span class="n">fM1L3_RTD_3</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L3_RTD_3</span><span class="p">);</span>

<span class="n">fM2L3_RTD_1</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM2L3_RTD_1</span><span class="p">);</span>
<span class="n">fM2L3_RTD_2</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM2L3_RTD_2</span><span class="p">);</span>
<span class="n">fM2L3_RTD_3</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM2L3_RTD_3</span><span class="p">);</span>

<span class="n">fM1L4_RTD_1</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L4_RTD_1</span><span class="p">);</span>
<span class="n">fM1L4_RTD_2</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L4_RTD_2</span><span class="p">);</span>
<span class="n">fM1L4_RTD_3</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">GVL_RTDS</span><span class="o">.</span><span class="n">nM1L4_RTD_3</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-mr1l3">GVL_MR1L3</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr1l3-constants">GVL_MR1L3_Constants</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr1l4">GVL_MR1L4</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr1l4-constants">GVL_MR1L4_Constants</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr2l3">GVL_MR2L3</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr2l3-constants">GVL_MR2L3_Constants</a></p></li>
<li><p><a class="reference internal" href="#gvl-rtds">GVL_RTDS</a></p></li>
<li><p><a class="reference internal" href="#prg-coatingprotection">PRG_CoatingProtection</a></p></li>
<li><p><a class="reference internal" href="#prg-pmps">PRG_PMPS</a></p></li>
<li><p><a class="reference internal" href="#prg-states">PRG_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="mc-smoothmover">
<h2>MC_SmoothMover<a class="headerlink" href="#mc-smoothmover" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">MC_SmoothMover</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span>    <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Velocity</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ReqAbsPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">New</span> <span class="n">requested</span> <span class="n">position</span>
    <span class="n">Enable</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">While</span> <span class="n">true</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">accept</span> <span class="n">new</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">them</span> <span class="k">if</span> <span class="n">they</span> <span class="n">are</span> <span class="n">different</span>
    <span class="n">Execute</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Will</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">target</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">Done</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Busy</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Error</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mcMoveAbsolute</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iI</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">imcBlockIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ReqAbsPosPrevious</span>       <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rtExecute</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Smooth</span> <span class="n">Mover</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">30</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span>

<span class="n">Enable</span> <span class="n">means</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">always</span> <span class="n">aquire</span> <span class="n">new</span> <span class="n">positions</span> <span class="k">as</span> <span class="n">they</span> <span class="n">are</span> <span class="n">updated</span><span class="o">.</span> <span class="n">Execute</span>
<span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span> <span class="n">Axis</span> <span class="n">must</span> <span class="n">be</span> <span class="n">enabled</span> <span class="n">by</span> <span class="n">a</span> <span class="n">power</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Execute</span><span class="p">);</span>

<span class="n">IF</span> <span class="p">(</span> <span class="p">(</span><span class="n">ReqAbsPos</span> <span class="o">&lt;&gt;</span> <span class="n">ReqAbsPosPrevious</span> <span class="n">AND</span> <span class="n">Enable</span><span class="p">)</span> <span class="n">OR</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="n">imcBlockIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">imcBlockIndex</span> <span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span> <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">ReqAbsPosPrevious</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">CommandAborted</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>

<span class="n">FOR</span> <span class="n">iI</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">2</span> <span class="n">DO</span>
    <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">iI</span><span class="p">](</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">Axis</span><span class="p">,</span> <span class="n">Velocity</span><span class="o">:=</span><span class="n">Velocity</span><span class="p">,</span> <span class="n">BufferMode</span><span class="o">:=</span><span class="n">MC_Aborting</span><span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">Error</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">R</span><span class="o">=</span> <span class="n">Busy</span> <span class="n">OR</span> <span class="n">Error</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="p-serial-com">
<h2>P_Serial_Com<a class="headerlink" href="#p-serial-com" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">P_Serial_Com</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">fbSerialLineControl_EL6001_P1</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_EL6001_MR1L3</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span> <span class="o">//</span> <span class="n">M1</span> <span class="n">Serial</span> <span class="n">Comm</span> <span class="n">Function</span> <span class="n">Block</span>
    <span class="n">fbSerialLineControl_EL6001_MR1L4</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span> <span class="o">//</span> <span class="n">M1</span> <span class="n">Serial</span> <span class="n">Comm</span> <span class="n">Function</span> <span class="n">Block</span>

    <span class="n">fbSerialLineControl_EL6001_MR2L3</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">These</span> <span class="n">are</span> <span class="n">the</span> <span class="k">global</span> <span class="n">IOs</span><span class="o">...</span><span class="n">don</span><span class="s1">&#39;t forget to copy your data into them</span>




<span class="p">(</span><span class="o">*</span> <span class="n">EL6001</span> <span class="n">Serial</span> <span class="n">port</span> <span class="mi">0</span> <span class="n">com</span> <span class="n">function</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbSerialLineControl_EL6001_MR1L3</span><span class="p">(</span><span class="n">Mode</span><span class="o">:=</span> <span class="n">SERIALLINEMODE_EL6_22B</span><span class="p">,</span>
                                <span class="n">pComIn</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComIn_MR1L3</span><span class="p">),</span>
                                   <span class="n">pComOut</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComOut_MR1L3</span><span class="p">),</span>
                                <span class="n">SizeComIn</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">Serial_stComIn_MR1L3</span><span class="p">),</span>
                                <span class="n">TxBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR1L3</span><span class="p">,</span>
                                <span class="n">RxBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR1L3</span><span class="p">,</span>
                                <span class="n">Error</span><span class="o">=&gt;</span><span class="p">,</span>
                                <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="p">);</span>

<span class="n">fbSerialLineControl_EL6001_MR1L4</span><span class="p">(</span><span class="n">Mode</span><span class="o">:=</span> <span class="n">SERIALLINEMODE_EL6_22B</span><span class="p">,</span>
                                <span class="n">pComIn</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComIn_MR1L4</span><span class="p">),</span>
                                   <span class="n">pComOut</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComOut_MR1L4</span><span class="p">),</span>
                                <span class="n">SizeComIn</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">Serial_stComIn_MR1L4</span><span class="p">),</span>
                                <span class="n">TxBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR1L4</span><span class="p">,</span>
                                <span class="n">RxBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR1L4</span><span class="p">,</span>
                                <span class="n">Error</span><span class="o">=&gt;</span><span class="p">,</span>
                                <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="p">);</span>



<span class="n">fbSerialLineControl_EL6001_MR2L3</span><span class="p">(</span><span class="n">Mode</span><span class="o">:=</span> <span class="n">SERIALLINEMODE_EL6_22B</span><span class="p">,</span>
                                <span class="n">pComIn</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComIn_MR2L3</span><span class="p">),</span>
                                   <span class="n">pComOut</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">Serial_stComOut_MR2L3</span><span class="p">),</span>
                                <span class="n">SizeComIn</span><span class="o">:=</span> <span class="n">SIZEOF</span><span class="p">(</span><span class="n">Serial_stComIn_MR2L3</span><span class="p">),</span>
                                <span class="n">TxBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR2L3</span><span class="p">,</span>
                                <span class="n">RxBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR2L3</span><span class="p">,</span>
                                <span class="n">Error</span><span class="o">=&gt;</span><span class="p">,</span>
                                <span class="n">ErrorID</span><span class="o">=&gt;</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="piezoserial">
<h2>PiezoSerial<a class="headerlink" href="#piezoserial" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PiezoSerial</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">PI</span> <span class="n">Serial</span>
    <span class="o">//</span><span class="n">Beckhoff</span>
    <span class="n">fbE621SerialDriver_MR1L3</span> <span class="p">:</span> <span class="n">FB_PI_E621_SerialDriver</span><span class="p">;</span>
    <span class="n">rtInitParams_MR1L3</span>      <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonTimeoutRst_MR1L3</span>     <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S); //For timeout reset</span>

    <span class="n">fbE621SerialDriver_MR2L3</span> <span class="p">:</span> <span class="n">FB_PI_E621_SerialDriver</span><span class="p">;</span>
    <span class="n">rtInitParams_MR2L3</span>      <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonTimeoutRst_MR2L3</span>     <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S); //For timeout reset</span>

    <span class="n">fbE621SerialDriver_MR1L4</span> <span class="p">:</span> <span class="n">FB_PI_E621_SerialDriver</span><span class="p">;</span>
    <span class="n">rtInitParams_MR2L4</span>      <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonTimeoutRst_MR2L4</span>     <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S); //For timeout reset</span>



    <span class="n">rtInitParams</span>    <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tonTimeoutRstM1</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S); //For timeout reset</span>
    <span class="n">tonTimeoutRstM2</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S); //For timeout reset</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">MR1L3</span> <span class="n">Piezo</span> <span class="n">E</span><span class="o">-</span><span class="mi">621</span>
<span class="o">///////////////////////</span>
<span class="n">fbE621SerialDriver_MR1L3</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR1L3</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbE621SerialDriver_MR1L3</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR1L3</span><span class="p">(</span><span class="n">iq_stPiezoAxis</span><span class="o">:=</span> <span class="n">GVL_MR1L3</span><span class="o">.</span><span class="n">MR1L3_Pitch</span><span class="o">.</span><span class="n">Piezo</span><span class="p">,</span>
                        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR1L3</span><span class="p">,</span>
                        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR1L3</span><span class="p">);</span>


<span class="o">//</span><span class="n">M2</span> <span class="n">Piezo</span> <span class="n">E</span><span class="o">-</span><span class="mi">621</span>
<span class="o">///////////////////////</span>
<span class="n">fbE621SerialDriver_MR1L4</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR1L4</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbE621SerialDriver_MR1L4</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR1L4</span><span class="p">(</span><span class="n">iq_stPiezoAxis</span><span class="o">:=</span> <span class="n">GVL_MR1L4</span><span class="o">.</span><span class="n">MR1L4_Pitch</span><span class="o">.</span><span class="n">Piezo</span><span class="p">,</span>
                        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR1L4</span><span class="p">,</span>
                        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR1L4</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR2L3</span> <span class="n">Piezo</span> <span class="n">E</span><span class="o">-</span><span class="mi">621</span>
<span class="o">///////////////////////</span>
<span class="n">fbE621SerialDriver_MR2L3</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR2L3</span><span class="o">.</span><span class="n">i_xExecute</span> <span class="n">R</span><span class="o">=</span> <span class="n">fbE621SerialDriver_MR2L3</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">;</span>
<span class="n">fbE621SerialDriver_MR2L3</span><span class="p">(</span><span class="n">iq_stPiezoAxis</span><span class="o">:=</span> <span class="n">GVL_MR2L3</span><span class="o">.</span><span class="n">MR2L3_Pitch</span><span class="o">.</span><span class="n">Piezo</span><span class="p">,</span>
                        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">Serial_RXBuffer_MR2L3</span><span class="p">,</span>
                        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">Serial_TXBuffer_MR2L3</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-mr1l3">GVL_MR1L3</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr1l4">GVL_MR1L4</a></p></li>
<li><p><a class="reference internal" href="#gvl-mr2l3">GVL_MR2L3</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="prg-coatingprotection">
<h2>PRG_CoatingProtection<a class="headerlink" href="#prg-coatingprotection" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_CoatingProtection</span>
<span class="n">VAR</span>
<span class="o">//</span><span class="n">M1</span>
   <span class="n">fbM1</span> <span class="p">:</span> <span class="n">FB_MirrorCoatingProtection</span> <span class="o">:=</span> <span class="p">(</span>
           <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;XRT-M1&#39;</span><span class="p">,</span>
        <span class="n">rFirstCoatingPosition</span><span class="o">:=</span> <span class="mi">8611000</span><span class="p">,</span>
        <span class="n">rFirstCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span><span class="p">,</span>
        <span class="n">sFirstCoatingType</span><span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">rSecondCoatingPosition</span><span class="o">:=</span> <span class="mi">18611000</span> <span class="p">,</span>
        <span class="n">rSecondCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span> <span class="p">,</span>
        <span class="n">sSecondCoatingType</span><span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">bAutoClear</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="o">//</span><span class="n">M2</span>
   <span class="n">fbM2</span> <span class="p">:</span> <span class="n">FB_MirrorCoatingProtection</span> <span class="o">:=</span> <span class="p">(</span>
           <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;XRT-M2&#39;</span><span class="p">,</span>
        <span class="n">rFirstCoatingPosition</span><span class="o">:=</span> <span class="mi">8496030</span><span class="p">,</span>
        <span class="n">rFirstCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span><span class="p">,</span>
        <span class="n">sFirstCoatingType</span><span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">rSecondCoatingPosition</span><span class="o">:=</span> <span class="mi">18496030</span> <span class="p">,</span>
        <span class="n">rSecondCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span> <span class="p">,</span>
        <span class="n">sSecondCoatingType</span><span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">bAutoClear</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="o">//</span><span class="n">M3</span>
   <span class="n">fbM3</span> <span class="p">:</span> <span class="n">FB_MirrorCoatingProtection</span> <span class="o">:=</span> <span class="p">(</span>
           <span class="n">sDevName</span><span class="o">:=</span> <span class="s1">&#39;XRT-M3&#39;</span><span class="p">,</span>
        <span class="n">rFirstCoatingPosition</span><span class="o">:=</span> <span class="mi">9279350</span><span class="p">,</span>
        <span class="n">rFirstCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span><span class="p">,</span>
        <span class="n">sFirstCoatingType</span><span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">rSecondCoatingPosition</span><span class="o">:=</span> <span class="mi">19279350</span> <span class="p">,</span>
        <span class="n">rSecondCoatingPositionTolerance</span><span class="o">:=</span> <span class="mi">1000000</span> <span class="p">,</span>
        <span class="n">sSecondCoatingType</span><span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">bAutoClear</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>



        <span class="o">//</span> <span class="n">Fast</span> <span class="n">Fault</span> <span class="n">used</span> <span class="n">when</span> <span class="n">M1</span> <span class="ow">and</span> <span class="n">M2</span> <span class="n">are</span> <span class="n">both</span> <span class="ow">in</span>
         <span class="n">ffM1M2IN</span><span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
                    <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;XRT-M1 and XRT-M2&#39;</span><span class="p">,</span>
                    <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when both M1 and M2 are IN&#39;</span><span class="p">,</span>
                    <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#602);</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">M1</span>
<span class="n">fbM1</span><span class="p">(</span>
    <span class="n">bMirrorIn</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Main</span><span class="o">.</span><span class="n">nEncCntXupMR1L3</span> <span class="o">&gt;</span> <span class="mi">20210500</span><span class="p">)</span> <span class="p">,</span> <span class="o">//</span> <span class="n">according</span> <span class="n">to</span> <span class="n">confluence</span> <span class="o">-</span><span class="mi">6</span> <span class="ow">is</span> <span class="n">nominal</span> <span class="n">out</span> <span class="n">position</span>
    <span class="n">rCurrentEncoderPosition</span> <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">nEncCntYupMR1L3</span><span class="p">,</span>
    <span class="n">neVRange</span> <span class="o">:=</span> <span class="n">PMPS</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span>
    <span class="n">nFirstCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">13500</span><span class="p">,</span> <span class="mi">90000</span><span class="p">),</span>
    <span class="n">nSecondCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">FFO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>

<span class="o">//</span><span class="n">M2</span>
<span class="o">//</span><span class="n">With</span> <span class="n">M2</span> <span class="n">the</span> <span class="n">same</span> <span class="n">coating</span> <span class="n">has</span> <span class="n">different</span> <span class="n">bit</span> <span class="n">masks</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">pitch</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">Main</span><span class="o">.</span><span class="n">nEncCntPitchMR1L4</span> <span class="o">&lt;</span> <span class="mi">9616668</span> <span class="p">)</span> <span class="n">THEN</span><span class="o">//</span><span class="p">(</span><span class="n">HOMS2_Pitch</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stStatus</span><span class="o">.</span><span class="n">rActPosition</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">400</span> <span class="p">)</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MFX</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nFirstCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">13500</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nSecondCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
<span class="n">ELSIF</span> <span class="p">(</span><span class="n">Main</span><span class="o">.</span><span class="n">nEncCntPitchMR1L4</span> <span class="o">&gt;</span> <span class="mi">10129409</span> <span class="p">)</span> <span class="n">THEN</span><span class="o">//</span> <span class="p">(</span><span class="n">HOMS2_Pitch</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stStatus</span><span class="o">.</span><span class="n">rActPosition</span> <span class="o">&gt;</span> <span class="mi">600</span><span class="p">)</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">MEC</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nFirstCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">25000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nSecondCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
<span class="n">ELSE</span> <span class="o">//</span> <span class="n">Anything</span> <span class="k">else</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">range</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nFirstCoatingBitmask</span><span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fbM2</span><span class="o">.</span><span class="n">nSecondCoatingBitmask</span><span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbM2</span><span class="p">(</span>
    <span class="n">bMirrorIn</span> <span class="o">:=</span> <span class="p">(</span><span class="n">Main</span><span class="o">.</span><span class="n">nEncCntXupMR1L4</span> <span class="o">&lt;</span> <span class="mi">25490840</span><span class="p">),</span>
    <span class="n">rCurrentEncoderPosition</span> <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">nEncCntYupMR1L4</span><span class="p">,</span>
    <span class="n">neVRange</span> <span class="o">:=</span> <span class="n">PMPS</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span>
    <span class="n">FFO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>

<span class="o">//</span><span class="n">M3</span>
<span class="n">fbM3</span><span class="p">(</span>
    <span class="n">bMirrorIn</span><span class="o">:=</span>  <span class="n">fbM1</span><span class="o">.</span><span class="n">bMirrorIn</span><span class="p">,</span> <span class="o">//</span> <span class="n">When</span> <span class="n">M1</span> <span class="ow">is</span> <span class="n">out</span><span class="p">,</span> <span class="n">M3</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">to</span> <span class="n">be</span> <span class="n">OUT</span>
    <span class="n">rCurrentEncoderPosition</span> <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">nEncCntYupMR2L3</span><span class="p">,</span>
    <span class="n">neVRange</span> <span class="o">:=</span> <span class="n">PMPS</span><span class="o">.</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span>
    <span class="n">nFirstCoatingBitmask</span><span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">13500</span><span class="p">,</span> <span class="mi">90000</span><span class="p">),</span>
    <span class="n">nSecondCoatingBitmask</span><span class="o">:=</span>  <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">),</span>
    <span class="n">FFO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>


<span class="o">//</span> <span class="n">Evaluate</span> <span class="n">M1</span> <span class="ow">and</span> <span class="n">M2</span> <span class="n">status</span>
<span class="n">ffM1M2IN</span><span class="p">(</span>
        <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">fbM1</span><span class="o">.</span><span class="n">bMirrorIn</span> <span class="n">AND</span> <span class="n">fbM2</span><span class="o">.</span><span class="n">bMirrorIn</span><span class="p">),</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-mirrorcoatingprotection">FB_MirrorCoatingProtection</a></p></li>
<li><p><a class="reference internal" href="#gvl-pmps">GVL_PMPS</a></p></li>
<li><p><a class="reference internal" href="#main">Main</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="prg-pmps">
<h2>PRG_PMPS<a class="headerlink" href="#prg-pmps" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_PMPS</span>
<span class="n">VAR</span>
    <span class="n">bMR1L3_OUT_Veto</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fb_vetoArbiter</span><span class="p">:</span> <span class="n">FB_VetoArbiter</span><span class="p">;</span>
    <span class="n">ff2_ff1_link_vac</span><span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;FF2 to FF1 Link&#39;</span><span class="p">,</span> <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;This is virtual FF2 fault, Please check the faulting XRT Optics device&#39;</span><span class="p">,</span> <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#9999);</span>

    <span class="n">rtRemove</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">bRemove</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExist</span> <span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>
    <span class="n">nReq</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">PMPS</span> <span class="n">Arbiter</span> <span class="ow">and</span> <span class="n">FFO</span> <span class="n">instantiation</span><span class="o">.</span>
<span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter1</span><span class="o">.</span><span class="n">AddRequest</span><span class="p">(</span><span class="mi">16</span><span class="c1">#5, PMPS_GVL.cstFullBeam, &#39;XRT HOMS&#39;);</span>


<span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">fbArbiterIO</span><span class="o">.</span><span class="n">i_bVeto</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">[</span><span class="n">PMPS</span><span class="o">.</span><span class="n">L_Stopper</span><span class="o">.</span><span class="n">ST1L0</span><span class="p">];</span>
<span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">fbArbiterIO</span><span class="p">(</span><span class="n">Arbiter</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter1</span><span class="p">,</span> <span class="n">fbFFHWO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>


<span class="n">bMR1L3_OUT_Veto</span> <span class="o">:=</span> <span class="p">((</span> <span class="n">PRG_States</span><span class="o">.</span><span class="n">fbMR1L3_InOut_States</span><span class="o">.</span><span class="n">enumGet</span> <span class="o">=</span> <span class="n">ENUM_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span> <span class="n">PRG_States</span><span class="o">.</span><span class="n">fbMR1L3_InOut_States</span><span class="o">.</span><span class="n">enumGet</span> <span class="o">=</span> <span class="n">ENUM_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">));</span>
<span class="n">fb_vetoArbiter</span><span class="p">(</span><span class="n">bVeto</span><span class="o">:=</span><span class="n">bMR1L3_OUT_Veto</span><span class="p">,</span> <span class="o">//</span> <span class="n">should</span> <span class="n">Veto</span> <span class="n">when</span> <span class="n">MR1L3</span> <span class="ow">is</span> <span class="n">out</span> <span class="n">of</span> <span class="n">the</span> <span class="n">beam</span>
                <span class="n">HigherAuthority</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter1</span><span class="p">,</span>
                <span class="n">LowerAuthority</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter2</span><span class="p">,</span>
                <span class="n">FFO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">);</span>

<span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">i_xVeto</span><span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">aVetoDevices</span><span class="p">[</span><span class="n">PMPS</span><span class="o">.</span><span class="n">L_Stopper</span><span class="o">.</span><span class="n">ST1L0</span><span class="p">]);</span>
<span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput2</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">bAutoReset</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">i_xVeto</span><span class="o">:=</span> <span class="n">bMR1L3_OUT_Veto</span><span class="p">);</span>


<span class="n">ff2_ff1_link_vac</span><span class="p">(</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput1</span><span class="p">,</span>
    <span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput2</span><span class="o">.</span><span class="n">q_xFastFaultOut</span><span class="p">);</span>

<span class="o">//</span> <span class="k">for</span> <span class="n">testing</span> <span class="ow">and</span> <span class="n">checking</span>
<span class="n">bExist</span><span class="o">:=</span> <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter1</span><span class="o">.</span><span class="n">CheckRequestInPool</span><span class="p">(</span><span class="n">nReq</span><span class="p">);</span>
<span class="n">rtRemove</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">bRemove</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">rtRemove</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
     <span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter1</span><span class="o">.</span><span class="n">RemoveRequest</span><span class="p">(</span><span class="n">nReq</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-pmps">GVL_PMPS</a></p></li>
<li><p><a class="reference internal" href="#prg-states">PRG_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="prg-states">
<h2>PRG_States<a class="headerlink" href="#prg-states" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">PRG_States</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">MR1L3</span> <span class="n">Coating</span> <span class="n">States</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">COATING</span><span class="p">:</span><span class="n">STATE</span><span class="p">;</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
     <span class="s1">&#39;}</span>
    <span class="n">fbMR1L3_Coating_States</span><span class="p">:</span> <span class="n">FB_Coating_States</span><span class="p">;</span>

    <span class="n">MR1L3_SiC</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">8611100</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">,</span>
        <span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">,</span>
        <span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FA72);</span>

    <span class="n">MR1L3_W</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">18611220</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">,</span>
        <span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">,</span>
        <span class="n">nRequestAssertionID</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FA73);</span>

<span class="o">//</span><span class="n">MR1L3</span> <span class="n">In</span> <span class="n">Out</span> <span class="n">States</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">STATE</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR1L3_InOut_States</span> <span class="p">:</span> <span class="n">FB_PositionStateInOut</span><span class="p">;</span>

    <span class="n">MR1L3_In</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">25210740</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

    <span class="n">MR1L3_Out</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">19210590</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR2L3</span> <span class="n">Coating</span> <span class="n">States</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR2L3</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">COATING</span><span class="p">:</span><span class="n">STATE</span><span class="p">;</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR2L3_Coating_States</span><span class="p">:</span> <span class="n">FB_Coating_States_noPMPS</span><span class="p">;</span>

    <span class="n">MR2L3_SiC</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">9278970</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

    <span class="n">MR2L3_W</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">19279260</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR1L4</span> <span class="n">Coating</span> <span class="n">States</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">COATING</span><span class="p">:</span><span class="n">STATE</span><span class="p">;</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR1L4_Coating_States</span><span class="p">:</span> <span class="n">FB_Coating_States_noPMPS</span><span class="p">;</span>

    <span class="n">MR1L4_SiC</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;SiC&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">8495750</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

    <span class="n">MR1L4_W</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">18496280</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR1L4</span> <span class="n">In</span> <span class="n">Out</span> <span class="n">States</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MR1L4</span><span class="p">:</span><span class="n">HOMS</span><span class="p">:</span><span class="n">MMS</span><span class="p">:</span><span class="n">XUP</span><span class="p">:</span><span class="n">STATE</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbMR1L4_InOut_States</span> <span class="p">:</span> <span class="n">FB_PositionStateInOut</span><span class="p">;</span>

    <span class="n">MR1L4_In</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;IN&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">23590530</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>

    <span class="n">MR1L4_Out</span> <span class="p">:</span> <span class="n">DUT_PositionState</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">bUseRawCounts</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bMoveOk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;OUT&#39;</span><span class="p">,</span>
        <span class="n">nEncoderCount</span> <span class="o">:=</span> <span class="mi">43989180</span><span class="p">,</span>
        <span class="n">fDelta</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">fVelocity</span> <span class="o">:=</span> <span class="mi">150</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">STATES</span>
    <span class="n">MR1L3_SiC</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">13500</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
    <span class="n">MR1L3_W</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span> <span class="o">:=</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13000</span><span class="p">)</span> <span class="n">AND</span> <span class="n">F_eVExcludeRange</span><span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>

<span class="o">//</span><span class="n">M1L3</span> <span class="n">States</span> <span class="k">with</span> <span class="n">PMPS</span>
    <span class="o">//</span><span class="n">Main</span><span class="o">.</span><span class="n">M1</span><span class="o">.</span><span class="n">bPowerSelf</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">;</span>
    <span class="n">fbMR1L3_Coating_States</span><span class="p">(</span>
        <span class="n">bBPOkAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">stCoating1</span> <span class="o">:=</span> <span class="n">MR1L3_SiC</span><span class="p">,</span>
        <span class="n">stCoating2</span> <span class="o">:=</span> <span class="n">MR1L3_W</span><span class="p">,</span>
        <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_fbArbiter2</span><span class="p">,</span>
        <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">GVL_PMPS</span><span class="o">.</span><span class="n">g_FastFaultOutput2</span> <span class="p">,</span>
        <span class="n">nTransitionAssertionID</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#FA71 ,</span>
        <span class="n">nUnknownAssertionID</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#FA70 ,</span>
        <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">Main</span><span class="o">.</span><span class="n">M1</span><span class="p">);</span>

<span class="o">//</span><span class="n">M1L3</span> <span class="n">States</span> <span class="n">No</span> <span class="n">State</span> <span class="n">PMPS</span>
    <span class="n">fbMR1L3_InOut_States</span><span class="p">(</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">stIn</span> <span class="o">:=</span> <span class="n">MR1L3_In</span><span class="p">,</span>
        <span class="n">stOut</span> <span class="o">:=</span> <span class="n">MR1L3_Out</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">M3</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR2L3</span> <span class="n">States</span> <span class="n">No</span> <span class="n">State</span> <span class="n">PMPS</span>
    <span class="n">fbMR2L3_Coating_States</span><span class="p">(</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">stCoating1</span> <span class="o">:=</span> <span class="n">MR2L3_SiC</span><span class="p">,</span>
        <span class="n">stCoating2</span> <span class="o">:=</span> <span class="n">MR2L3_W</span><span class="p">,</span>
        <span class="n">stMotionStage</span><span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">M13</span><span class="p">);</span>

<span class="o">//</span><span class="n">MR1L4</span> <span class="n">States</span> <span class="n">No</span> <span class="n">State</span> <span class="n">PMPS</span>
    <span class="n">fbMR1L4_Coating_States</span><span class="p">(</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">stCoating1</span> <span class="o">:=</span> <span class="n">MR1L4_SiC</span><span class="p">,</span>
        <span class="n">stCoating2</span> <span class="o">:=</span> <span class="n">MR1L4_W</span><span class="p">,</span>
        <span class="n">stMotionStage</span><span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">M7</span><span class="p">);</span>

    <span class="n">fbMR1L4_InOut_States</span><span class="p">(</span>
        <span class="n">bEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">stIn</span> <span class="o">:=</span> <span class="n">MR1L4_In</span><span class="p">,</span>
        <span class="n">stOut</span> <span class="o">:=</span> <span class="n">MR1L4_Out</span><span class="p">,</span>
        <span class="n">stMotionStage</span> <span class="o">:=</span> <span class="n">Main</span><span class="o">.</span><span class="n">M9</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-coating-states">FB_Coating_States</a></p></li>
<li><p><a class="reference internal" href="#fb-coating-states-nopmps">FB_Coating_States_noPMPS</a></p></li>
<li><p><a class="reference internal" href="#gvl-pmps">GVL_PMPS</a></p></li>
<li><p><a class="reference internal" href="#main">Main</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="withinrange">
<h2>WithinRange<a class="headerlink" href="#withinrange" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">WithinRange</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ValA</span>    <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">New</span> <span class="n">position</span> <span class="n">to</span> <span class="n">evaluate</span>
    <span class="n">Center</span> <span class="p">:</span>        <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Current</span> <span class="n">position</span>
    <span class="n">Range</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Span</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">range</span>
    <span class="n">Offset</span>  <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span><span class="n">Offset</span> <span class="kn">from</span> <span class="nn">center</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">range</span> <span class="ow">is</span> <span class="n">non</span><span class="o">-</span><span class="n">symetric</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">ValA</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Center</span> <span class="o">+</span> <span class="n">Offset</span> <span class="o">-</span> <span class="p">(</span><span class="n">Range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="n">THEN</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">ValA</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">Center</span> <span class="o">+</span> <span class="n">Offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">Range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="n">THEN</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="HOMS_XRT_HOMS_XRT_PLC_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>